import os
import logging
import asyncio
import random
from dotenv import load_dotenv
from typing import Dict, Any, List, Tuple
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove, BotCommand
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    ConversationHandler,
    filters,
    Application,
)


load_dotenv()

BOT_TOKEN = os.getenv("BOT_TOKEN", "YOUR_TOKEN_HERE")

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# states
(
    GENDER, AGE, HAIR_STATUS, HAIR_COLOR, HAIR_TYPE, HAIR_MODEL, HAIR_MODEL_FEMALE, HAIR_DYE,
    FACE_CONDITION, FACE_SHAPE, SKIN_COLOR, EYEBROW_COLOR, EYE_COLOR, NOSE_TYPE,
    BEARD_PRESENT, BEARD_COLOR, BEARD_MODEL, BEARD_DYE, SUMMARY,
) = range(19)

# emoji labels
BACK = "ุจุงุฒฺฏุดุช ๐"
CANCEL = "ุงูุตุฑุงู โ"
READY = "ุขูุงุฏูโุงู โ"
NEXT_PAGE = "ุจุนุฏ โถ๏ธ"
PREV_PAGE = "ูุจู โ๏ธ"
RESTART = "ุดุฑูุน /start"
START = "ุดุฑูุน"
HELP = "ุฑุงูููุง โน๏ธ"

# option arrays
gender_options = ["ูุฑุฏ", "ุฒู"]
age_options = ["ุชุง 20", "20-30", "30-40", "40-50", "50-60", "+60"]
hair_status_options = ["ุฏุงุฑุง ูู", "ุฌูู ุชุง ูพุดุช ุณุฑ ุจุฏูู ูู"]

# ---------- ุชุบุฑ 1: ุงุถุงูู ฺฉุฑุฏู ุฎุงฺฉุณุชุฑ ุจู ุฑูฺฏ ูููุง ูุฑุฏุงู ----------
hair_color_options = ["ูุดฺฉ", "ููููโุง ุชุฑู", "ููููโุง ุฑูุดู", "ุจูููุฏ/ุจูุฑ", "ุฌูฺฏูุฏูู", "ูุฑูุฒ ุญูุง", "ุณูุฏ", "ุฎุงฺฉุณุชุฑ"]

hair_type_options = ["ุตุงู ๐", "ููุฌโุฏุงุฑ ๐", "ูุฑ ๐", "ูุฒ ๐"]
face_condition_options = ["ูุนููู", "ูุงุบุฑ", "ฺุงู"]
face_shape_options = ["ุจุถ", "ฺฏูุฑุฏ", "ูุณุชุทู", "ููุจ", "ูุซูุซ", "ูุฑุจุน", "ุงููุงุณ"]
skin_color_options = ["ุฑูุดู ๐", "ุณุจุฒู ๐", "ฺฏูุฏู ๐", "ุจุฑูุฒู ๐", "ุชุฑู ๐", "ุณุฑุฎ ๐"]
eyebrow_color_options = ["ูุดฺฉ", "ููููโุง", "ุฌูฺฏูุฏูู", "ุจูููุฏ", "ูุฑูุฒ ุญูุง", "ุณูุฏ"]
eye_color_options = ["ูุดฺฉ ๐", "ููููโุง ๐", "ุขุจ ๐", "ุณุจุฒ ๐", "ุฎุงฺฉุณุชุฑ ๐", "ุนุณู ๐"]
nose_type_options = ["ุงุณุชุฎูุงู ๐", "ฺฏูุดุช ๐", "ูุนููู ๐"]
dye_options = ["ุขุฑู โ", "ูู โ"]
beard_presence_options = ["ุฏุงุฑู ๐ง", "ูุฏุงุฑู โ"]

# ---------- ุฑูฺฏโูุง ูุงุจู ูพุดููุงุฏ (ุซุงุจุช) ----------
# ---------- ุชุบุฑ 2: ุงุถุงูู ฺฉุฑุฏู ุฎุงฺฉุณุชุฑ ุจู AVAILABLE_DYE_COLORS ----------
AVAILABLE_DYE_COLORS = ["ูุดฺฉ", "ููููโุง ุชุฑู", "ููููโุง ุฑูุดู", "ุจูููุฏ/ุจูุฑ", "ุฎุงฺฉุณุชุฑ", "ุญูุง", "ุดุฑ"]

# ูุฏูโูุง ูู ูุฑุฏุงูู (ุซุงุจุช)
hair_model_options = [
    "ูู ุงุฑุชุด (ุชุฑุงุดุฏู)", "ฺฉุฑููพ", "ุณุฒุงุฑ", "ุชูพุฑ", "ุณุงุฏู ฺฉูุงุณฺฉ", "ูุฏู ุฑูุฒูุฑู",
    "ุขูุฏุฑฺฉุงุช", "ูพูููพุงุฏูุฑ", "ูุฏ", "ุชฺฉุณฺุฑ ฺฉูุชุงู", "ูุงโุงูุฏุช", "ุงุณฺฉู ูุฏ", "ุณุงุฏ ูพุงุฑุช",
    "ฺฉุฑุงูพ ุชฺฉุณฺุฑ", "ฺฉูู", "ุขู ูฺฏ", "ฺฉูุจโุงููุฑ", "ูููุงฺฉ", "ูุงฺฉโูุงฺฉ", "ุขูุฑู ฺฉูุชุงู",
    "ุชูุฆุณุช", "ุงุณูพุงฺฉ ฺฉูุชุงู", "ุจูฺฉุณูุฑ", "ุขููุงู", "ุณูู", "ุณุงุฏ ูพุงุฑุช ุณุงุฏู",
    "ุณูฺฉโุจฺฉ ุณุงุฏู", "ูุงูโุจู ุณุงุฏู", "ูุชูุณุท ฺฉูุงุณฺฉ", "ุจุฑู ูููู", "ูุฑูุฌ ูุงูุฑุชุจ",
    "ุชุงูพโูุงุช", "ูู ููุฌโุฏุงุฑ ูุชูุณุท", "ุชฺฉุณุชฺุฑ ุจููุฏ", "ูุงูฺฏ ุชฺฉุณฺุฑ", "ฺฉุฑุงูพ ูุฑุงูุณู",
    "ุจุงุชุฒ", "ุชฺฉุณุชฺุฑ", "ูุงูฺฏ ุณูฺฉโุจฺฉ", "ูุงูโุจู", "ุจููุฏ ฺฉูุงุณฺฉ", "ุตุงู ู ุจููุฏ",
    "ูู ููุฌโุฏุงุฑ (ุณูุฑูุฑ)", "ูุฏูโุฏุงุฑ ุจููุฏ", "ุฏุฑุฏูฺฉ"
]

# ูุฏูโูุง ุฑุด (ุซุงุจุช)
beard_model_options = [
    "ุฑุด ู ุณุจู ฺฉุงูู ฺฉูุชุงู", "ุฑุด ู ุณุจู ฺฉุงูู ุจููุฏ", "ุชูโุฑุด", "ุณุจู",
    "ุฑุด ฺุงููโุง (Goatee)", "ุฑุด ูพุฑููุณูุฑ ฺฉูุงุณฺฉ"
]

# ุฑูฺฏโูุง ุฑุด (ุซุงุจุช)
beard_color_options = ["ูุดฺฉ", "ุจูุฑ/ ุจูููุฏ", "ุณูุฏ", "ููููโุง", "ูุฑูุฒ ุญูุง", "ุฌูฺฏูุฏูู"]

# ---------- NEW: Intelligent Style Engine ----------
class PersianStyleEngine:
    """
    ููุชูุฑ ููุดููุฏ ูพุดููุงุฏ ุงุณุชุงู ุจุฑุง ุขูุงุงู ุจุง ุชูุธูุงุช ูฺู ุงุฑุงู
    """
    
    def __init__(self):
        # ูุฒูโุฏู ููุดููุฏ ุจู ูพุงุฑุงูุชุฑูุง (ุฌูุน ฺฉู = 1.0)
        self.weights = {
            'face_shape': 0.35,      # ูููโุชุฑู ุจุฑุง ูุฏู ูู
            'hair_type': 0.25,       # ุชุนูโฺฉููุฏู ุจุฑุง ูุฏู ูู
            'skin_color': 0.20,      # ูููโุชุฑู ุจุฑุง ุฑูฺฏ
            'age': 0.10,             # ูุญุฏูุฏุช ุณู
            'eye_color': 0.05,       # ููุงููฺฏ ุฑูฺฏ
            'eyebrow_color': 0.03,   # ููุงููฺฏ ุฑูฺฏ
            'nose_type': 0.01,       # ุฌุฒุฆุงุช ุตูุฑุช
            'face_condition': 0.01,  # ุฌุฒุฆุงุช ุตูุฑุช
        }
        
        # ---------- ุชุบุฑ 2: ุงุถุงูู ฺฉุฑุฏู ุฎุงฺฉุณุชุฑ ุจู ููุงูู ุณุงุฒฺฏุงุฑ ----------
        # ููุงูู ุณุงุฒฺฏุงุฑ ููุดููุฏ ุฑูฺฏโูุง
        self.color_harmony_rules = {
            # ุฑูฺฏ ูพูุณุช -> (ุฑูฺฏ ูู ูพุดููุงุฏ: ุงูุฑฺ ููุงููฺฏ)
            "ุฑูุดู ๐": {
                "ูุดฺฉ": 6, "ููููโุง ุชุฑู": 7, "ููููโุง ุฑูุดู": 9, "ุจูููุฏ/ุจูุฑ": 10,
                "ุฎุงฺฉุณุชุฑ": 8, "ุญูุง": 5, "ุดุฑ": 9
            },
            "ุณุจุฒู ๐": {
                "ูุดฺฉ": 10, "ููููโุง ุชุฑู": 9, "ููููโุง ุฑูุดู": 7, "ุจูููุฏ/ุจูุฑ": 3,
                "ุฎุงฺฉุณุชุฑ": 6, "ุญูุง": 8, "ุดุฑ": 5
            },
            "ฺฏูุฏู ๐": {
                "ูุดฺฉ": 9, "ููููโุง ุชุฑู": 10, "ููููโุง ุฑูุดู": 8, "ุจูููุฏ/ุจูุฑ": 6,
                "ุฎุงฺฉุณุชุฑ": 7, "ุญูุง": 7, "ุดุฑ": 6
            },
            "ุจุฑูุฒู ๐": {
                "ูุดฺฉ": 10, "ููููโุง ุชุฑู": 9, "ููููโุง ุฑูุดู": 7, "ุจูููุฏ/ุจูุฑ": 2,
                "ุฎุงฺฉุณุชุฑ": 5, "ุญูุง": 6, "ุดุฑ": 4
            },
            "ุชุฑู ๐": {
                "ูุดฺฉ": 10, "ููููโุง ุชุฑู": 8, "ููููโุง ุฑูุดู": 4, "ุจูููุฏ/ุจูุฑ": 1,
                "ุฎุงฺฉุณุชุฑ": 4, "ุญูุง": 5, "ุดุฑ": 3
            },
            "ุณุฑุฎ ๐": {
                "ูุดฺฉ": 9, "ููููโุง ุชุฑู": 5, "ููููโุง ุฑูุดู": 6, "ุจูููุฏ/ุจูุฑ": 2,
                "ุฎุงฺฉุณุชุฑ": 7, "ุญูุง": 7, "ุดุฑ": 5
            }
        }
        
        # ููุงูู ุณูโูุญูุฑ
        self.age_constraints = {
            "ุชุง 20": {"bold_styles": 1.2, "conservative_penalty": -2, "modern_bonus": 1.5},
            "20-30": {"bold_styles": 1.1, "conservative_penalty": -1, "modern_bonus": 1.3},
            "30-40": {"bold_styles": 1.0, "conservative_penalty": 0, "modern_bonus": 1.0},
            "40-50": {"conservative_bonus": 1.2, "bold_penalty": -1, "classic_bonus": 1.3},
            "50-60": {"conservative_bonus": 1.4, "bold_penalty": -2, "classic_bonus": 1.5},
            "+60": {"conservative_bonus": 1.3, "bold_penalty": -3, "classic_bonus": 1.4},
        }
        
        # ูุฑู ุตูุฑุช -> ูุฏูโูุง ูููโุงูุนุงุฏู ุณุงุฒฺฏุงุฑ (ุงูุชุงุฒ ูพุงู 10)
        self.face_shape_perfect_match = {
            "ุจุถ": ["ุขูุฏุฑฺฉุงุช", "ุณุงุฏ ูพุงุฑุช", "ูพูููพุงุฏูุฑ", "ุณุงุฏู ฺฉูุงุณฺฉ", "ูุฏู ุฑูุฒูุฑู", "ฺฉุฑููพ", "ุขู ูฺฏ"],
            "ฺฏูุฑุฏ": ["ุขูุฏุฑฺฉุงุช", "ูุฏ", "ูุงโุงูุฏุช", "ุชูพุฑ", "ุงุณฺฉู ูุฏ", "ฺฉุฑููพ"],
            "ูุณุชุทู": ["ฺฉุฑููพ", "ุณุฒุงุฑ", "ุชฺฉุณฺุฑ ฺฉูุชุงู", "ูุชูุณุท ฺฉูุงุณฺฉ", "ุขู ูฺฏ", "ุขููุงู", "ุณูู"],
            "ููุจ": ["ุณุงุฏ ูพุงุฑุช", "ูุฑูุฌ ูุงูุฑุชุจ", "ุชูพุฑ", "ฺฉูู", "ุณูฺฉโุจฺฉ ุณุงุฏู", "ฺฉุฑููพ", "ฺฉุฑุงูพ ูุฑุงูุณู"],
            "ูุซูุซ": ["ุชุงูพโูุงุช", "ูพูููพุงุฏูุฑ", "ูู ููุฌโุฏุงุฑ ูุชูุณุท", "ูููุงฺฉ", "ูุงฺฉโูุงฺฉ", "ุฏุฑุฏูฺฉ"],
            "ูุฑุจุน": ["ฺฉุฑููพ", "ูู ุงุฑุชุด (ุชุฑุงุดุฏู)", "ุงุณฺฉู ูุฏ", "ุขูุฏุฑฺฉุงุช", "ุชูพุฑ", "ุจุงุชุฒ", "ุขููุงู"],
            "ุงููุงุณ": ["ุณุงุฏ ูพุงุฑุช", "ุจุฑู ูููู", "ูุฑูุฌ ูุงูุฑุชุจ", "ฺฉูุจโุงููุฑ", "ุณุงุฏ ูพุงุฑุช ุณุงุฏู", "ฺฉุฑุงูพ ูุฑุงูุณู"]
        }
        
        # ุฌูุณ ูู -> ูุฏูโูุง ุบุฑููฺฉู (ุญุฐู ูโุดููุฏ)
        self.hair_type_exclusions = {
            "ุตุงู ๐": ["ุขูุฑู ฺฉูุชุงู", "ุชูุฆุณุช", "ุฏุฑุฏูฺฉ"],
            "ููุฌโุฏุงุฑ ๐": ["ูู ุงุฑุชุด (ุชุฑุงุดุฏู)", "ุงุณฺฉู ูุฏ"],
            "ูุฑ ๐": ["ุณูฺฉโุจฺฉ ุณุงุฏู", "ุขู ูฺฏ", "ฺฉูุจโุงููุฑ", "ุงุณฺฉู ูุฏ"],
            "ูุฒ ๐": ["ุณูฺฉโุจฺฉ ุณุงุฏู", "ูพูููพุงุฏูุฑ", "ฺฉูู", "ูุงูฺฏ ุณูฺฉโุจฺฉ"]
        }
        
        # ุฑูฺฏ ฺุดู -> ุฑูฺฏโูุง ูฺฉูู (ุจูููุณ)
        self.eye_color_complements = {
            "ูุดฺฉ ๐": {"ูุดฺฉ": 2, "ููููโุง ุชุฑู": 1},
            "ููููโุง ๐": {"ุจูููุฏ/ุจูุฑ": 2, "ุญูุง": 1, "ููููโุง ุฑูุดู": 1},
            "ุขุจ ๐": {"ูุดฺฉ": 3, "ููููโุง ุชุฑู": 2},
            "ุณุจุฒ ๐": {"ุญูุง": 2, "ููููโุง ุชุฑู": 1},
            "ุฎุงฺฉุณุชุฑ ๐": {"ุฎุงฺฉุณุชุฑ": 2, "ุจูููุฏ/ุจูุฑ": 1},
            "ุนุณู ๐": {"ููููโุง ุฑูุดู": 2, "ุญูุง": 1}
        }
        
        # ุฑูฺฏ ุงุจุฑู -> ุฑูฺฏโูุง ูฺฉูู
        self.eyebrow_color_complements = {
            "ูุดฺฉ": {"ูุดฺฉ": 2, "ููููโุง ุชุฑู": 1},
            "ููููโุง": {"ููููโุง ุฑูุดู": 2, "ุญูุง": 1, "ุจูููุฏ/ุจูุฑ": 1},
            "ุฌูฺฏูุฏูู": {"ููููโุง ุฑูุดู": 2, "ุจูููุฏ/ุจูุฑ": 1},
            "ุจูููุฏ": {"ุจูููุฏ/ุจูุฑ": 3, "ุดุฑ": 2, "ููููโุง ุฑูุดู": 1},
            "ูุฑูุฒ ุญูุง": {"ุญูุง": 3, "ููููโุง ุฑูุดู": 1},
            "ุณูุฏ": {"ุฎุงฺฉุณุชุฑ": 2, "ุดุฑ": 2}
        }
        
        # ููุน ุจู -> ูุฏูโูุง ููุงููฺฏ
        self.nose_type_harmony = {
            "ุงุณุชุฎูุงู ๐": {"ูพูููพุงุฏูุฑ": 2, "ุณุงุฏ ูพุงุฑุช": 1, "ูููุงฺฉ": 2, "ูุงฺฉโูุงฺฉ": 1},
            "ฺฏูุดุช ๐": {"ฺฉุฑููพ": 2, "ุชูพุฑ": 2, "ูุฑูุฌ ูุงูุฑุชุจ": 2, "ุจุฑู ูููู": 1},
            "ูุนููู ๐": {"ูุฏู ุฑูุฒูุฑู": 2, "ุณุงุฏู ฺฉูุงุณฺฉ": 1, "ูุชูุณุท ฺฉูุงุณฺฉ": 1}
        }
        
        # ูุฏู ุฑุด ุจุฑ ุงุณุงุณ ูุฑู ุตูุฑุช
        self.beard_face_match = {
            "ุจุถ": ["ุฑุด ู ุณุจู ฺฉุงูู ฺฉูุชุงู", "ุฑุด ู ุณุจู ฺฉุงูู ุจููุฏ", "ุฑุด ฺุงููโุง (Goatee)"],
            "ฺฏูุฑุฏ": ["ุฑุด ู ุณุจู ฺฉุงูู ุจููุฏ", "ุชูโุฑุด", "ุณุจู"],
            "ูุณุชุทู": ["ุฑุด ู ุณุจู ฺฉุงูู ฺฉูุชุงู", "ุชูโุฑุด", "ุฑุด ฺุงููโุง (Goatee)"],
            "ููุจ": ["ุฑุด ฺุงููโุง (Goatee)", "ุณุจู", "ุชูโุฑุด"],
            "ูุซูุซ": ["ุฑุด ู ุณุจู ฺฉุงูู ุจููุฏ", "ุณุจู", "ุฑุด ู ุณุจู ฺฉุงูู ฺฉูุชุงู"],
            "ูุฑุจุน": ["ุฑุด ู ุณุจู ฺฉุงูู ฺฉูุชุงู", "ุชูโุฑุด", "ุณุจู"],
            "ุงููุงุณ": ["ุฑุด ฺุงููโุง (Goatee)", "ุณุจู", "ุชูโุฑุด"]
        }
        
        # ูุฏู ุฑุด ุจุฑ ุงุณุงุณ ุณู
        self.beard_age_match = {
            "ุชุง 20": ["ุชูโุฑุด", "ุณุจู", "ุฑุด ฺุงููโุง (Goatee)"],
            "20-30": ["ุฑุด ู ุณุจู ฺฉุงูู ฺฉูุชุงู", "ุชูโุฑุด", "ุฑุด ฺุงููโุง (Goatee)"],
            "30-40": ["ุฑุด ู ุณุจู ฺฉุงูู ฺฉูุชุงู", "ุฑุด ู ุณุจู ฺฉุงูู ุจููุฏ", "ุฑุด ฺุงููโุง (Goatee)"],
            "40-50": ["ุฑุด ูพุฑููุณูุฑ ฺฉูุงุณฺฉ", "ุฑุด ู ุณุจู ฺฉุงูู ฺฉูุชุงู", "ุชูโุฑุด"],
            "50-60": ["ุฑุด ูพุฑููุณูุฑ ฺฉูุงุณฺฉ", "ุฑุด ู ุณุจู ฺฉุงูู ฺฉูุชุงู", "ุณุจู"],
            "+60": ["ุฑุด ูพุฑููุณูุฑ ฺฉูุงุณฺฉ", "ุฑุด ู ุณุจู ฺฉุงูู ฺฉูุชุงู", "ุชูโุฑุด"]
        }
    
    def calculate_color_score(self, color: str, data: Dict[str, Any]) -> float:
        """ูุญุงุณุจู ุงูุชุงุฒ ฺฉู ฺฉ ุฑูฺฏ ุจุฑ ุงุณุงุณ ููู ูพุงุฑุงูุชุฑูุง"""
        score = 0.0
        
        # ูพุงู: ุณุงุฒฺฏุงุฑ ุจุง ุฑูฺฏ ูพูุณุช
        skin_color = data.get("skin_color", "ฺฏูุฏู ๐")
        score += self.color_harmony_rules.get(skin_color, {}).get(color, 5) * self.weights['skin_color']
        
        # ุจูููุณ: ุณุงุฒฺฏุงุฑ ุจุง ุฑูฺฏ ฺุดู
        eye_color = data.get("eye_color", "")
        eye_bonus = self.eye_color_complements.get(eye_color, {}).get(color, 0)
        score += eye_bonus * self.weights['eye_color']
        
        # ุจูููุณ: ุณุงุฒฺฏุงุฑ ุจุง ุฑูฺฏ ุงุจุฑู
        eyebrow_color = data.get("eyebrow_color", "")
        eyebrow_bonus = self.eyebrow_color_complements.get(eyebrow_color, {}).get(color, 0)
        score += eyebrow_bonus * self.weights['eyebrow_color']
        
        # ุชูุธู ุจุฑ ุงุณุงุณ ุณู
        age = data.get("age", "30-40")
        age_mod = self.age_constraints.get(age, {})
        
        # ุฑูฺฏโูุง ุฌุณูุฑุงูู ุจุฑุง ุฌูุงูโูุง
        if color in ["ุจูููุฏ/ุจูุฑ", "ุญูุง", "ุดุฑ"]:
            if "ุชุง 20" in age or "20-30" in age:
                score *= 1.1
            elif "40-50" in age or "50-60" in age or "+60" in age:
                score *= 0.8
        
        # ุฑูฺฏโูุง ูุญุงูุธูโฺฉุงุฑุงูู ุจุฑุง ูุงูุณุงูโูุง
        if color in ["ูุดฺฉ", "ููููโุง ุชุฑู"]:
            if "40-50" in age or "50-60" in age or "+60" in age:
                score *= 1.1
            elif "ุชุง 20" in age:
                score *= 0.9
        
        return score
    
    def calculate_hair_model_score(self, model: str, data: Dict[str, Any]) -> float:
        """ูุญุงุณุจู ุงูุชุงุฒ ฺฉู ฺฉ ูุฏู ูู"""
        score = 0.0
        
        # ุงูุชุงุฒ ูพุงู ุงุฒ ูุฑู ุตูุฑุช
        face_shape = data.get("face_shape", "ุจุถ")
        if model in self.face_shape_perfect_match.get(face_shape, []):
            score += 10 * self.weights['face_shape']
        else:
            score += 5 * self.weights['face_shape']
        
        # ุงูุชุงุฒ ุงุฒ ุฌูุณ ูู
        hair_type = data.get("hair_type", "ุตุงู ๐")
        if model in self.hair_type_exclusions.get(hair_type, []):
            # ูุฏู ุบุฑููฺฉู - ุงูุชุงุฒ ููู ุดุฏุฏ
            return -1000
        
        # ุจูููุณ ุงุฒ ููุน ุจู
        nose_type = data.get("nose_type", "ูุนููู ๐")
        nose_bonus = self.nose_type_harmony.get(nose_type, {}).get(model, 0)
        score += nose_bonus * self.weights['nose_type']
        
        # ุชูุธู ุจุฑ ุงุณุงุณ ุณู
        age = data.get("age", "30-40")
        age_mod = self.age_constraints.get(age, {})
        
        # ูุฏูโูุง ุฌุณูุฑุงูู ุจุฑุง ุฌูุงูโูุง
        bold_models = ["ูููุงฺฉ", "ูุงฺฉโูุงฺฉ", "ุงุณูพุงฺฉ ฺฉูุชุงู", "ุชุงูพโูุงุช", "ุฏุฑุฏูฺฉ"]
        if model in bold_models:
            score += age_mod.get("bold_styles", 1.0) * 3
            score += age_mod.get("bold_penalty", 0) * 2
        
        # ูุฏูโูุง ฺฉูุงุณฺฉ ุจุฑุง ุจุฒุฑฺฏุณุงูุงู
        classic_models = ["ุณุงุฏู ฺฉูุงุณฺฉ", "ฺฉูุจโุงููุฑ", "ุณุงุฏ ูพุงุฑุช ุณุงุฏู", "ุณูฺฉโุจฺฉ ุณุงุฏู"]
        if model in classic_models:
            score += age_mod.get("classic_bonus", 1.0) * 3
            score += age_mod.get("conservative_penalty", 0) * -2
        
        # ูุฏูโูุง ูุฏุฑู ุจุฑุง ุฌูุงูโูุง
        modern_models = ["ุขูุฏุฑฺฉุงุช", "ูพูููพุงุฏูุฑ", "ูุฏ", "ุชฺฉุณฺุฑ ฺฉูุชุงู", "ูุงโุงูุฏุช"]
        if model in modern_models:
            score *= age_mod.get("modern_bonus", 1.0)
        
        # ุงูุชุงุฒ ูพุงู ุจุฑุง ููู
        score += 3 * 0.1  # ูุฒู ฺฉูฺฺฉ ุจุฑุง ูพูุดุด ุนููู
        
        return score
    
    def calculate_beard_model_score(self, model: str, data: Dict[str, Any]) -> float:
        """ูุญุงุณุจู ุงูุชุงุฒ ฺฉู ฺฉ ูุฏู ุฑุด"""
        score = 0.0
        
        # ุงูุชุงุฒ ุงุฒ ูุฑู ุตูุฑุช
        face_shape = data.get("face_shape", "ุจุถ")
        if model in self.beard_face_match.get(face_shape, []):
            score += 8 * 0.6
        else:
            score += 4 * 0.6
        
        # ุงูุชุงุฒ ุงุฒ ุณู
        age = data.get("age", "30-40")
        if model in self.beard_age_match.get(age, []):
            score += 8 * 0.4
        else:
            score += 3 * 0.4
        
        # ุฑุด ูพุฑููุณูุฑ ููุท ุจุฑุง 40+
        if model == "ุฑุด ูพุฑููุณูุฑ ฺฉูุงุณฺฉ":
            if "40-50" in age or "50-60" in age or "+60" in age:
                score += 5
            else:
                score -= 5
        
        return score
    
    def get_harmonious_beard_color(self, hair_color: str, skin_color: str, age: str, current_beard_color: str) -> str:
        """
        ุงูุชุฎุงุจ ุฑูฺฏ ุฑุด ุจู ุตูุฑุช ููุดููุฏ:
        - ูุนูููุงู ููุงููฺฏ ุจุง ุฑูฺฏ ูู
        - ฺฏุงู ูุชูุงูุช ุจุฑุง ุฌููฺฏุฑ ุงุฒ ูพุฑ ุง ุงุฌุงุฏ ฺฉูุชุฑุงุณุช
        """
        # ุณูุงุฑู 1: ุฑุด ุณูุฏ ู ูู ูุดฺฉ (ุฌูุงูโุณุงุฒ)
        if ("50-60" in age or "+60" in age) and current_beard_color == "ุณูุฏ":
            if random.random() < 0.6:  # 60% ุงุญุชูุงู ุฑูฺฏ ูุดุงุจู ุจุฑุง ุทุจุน ุจูุฏู
                return hair_color
            else:
                return "ูุดฺฉ"  # ูพุดููุงุฏ ุฌูุงูโุณุงุฒ
        
        # ุณูุงุฑู 2: ูู ุจูููุฏ ู ูพูุณุช ุฑูุดู
        if "ุจูููุฏ" in hair_color and "ุฑูุดู" in skin_color:
            if random.random() < 0.7:
                return "ุจูุฑ/ ุจูููุฏ"
            else:
                return "ููููโุง"
        
        # ุณูุงุฑู 3: ูู ูุดฺฉ ู ฺุดู/ุงุจุฑู ูุดฺฉ (ููุงููฺฏ ฺฉุงูู)
        if hair_color == "ูุดฺฉ":
            return "ูุดฺฉ"
        
        # ุณูุงุฑู 4: ูพุดโูุฑุถ - ููุงููฺฏ ุจุง ุฑูฺฏ ูู
        color_map = {
            "ูุดฺฉ": "ูุดฺฉ",
            "ููููโุง ุชุฑู": "ููููโุง",
            "ููููโุง ุฑูุดู": "ููููโุง",
            "ุจูููุฏ/ุจูุฑ": "ุจูุฑ/ ุจูููุฏ",
            "ุฎุงฺฉุณุชุฑ": "ุณูุฏ",
            "ุญูุง": "ูุฑูุฒ ุญูุง",
            "ุดุฑ": "ุจูุฑ/ ุจูููุฏ"
        }
        
        return color_map.get(hair_color, "ูุดฺฉ")

# ูููููโุง ุงุฒ ููุชูุฑ
style_engine = PersianStyleEngine()


class PersianFemaleStyleEngine:
    """
    ููุชูุฑ ููุดููุฏ ูพุดููุงุฏ ุงุณุชุงู ุจุฑุง ุฎุงููโูุง ุจุง ุชูุธูุงุช ูฺู ุงุฑุงู
    """
    
    def __init__(self):
        # ูุฒูโุฏู ููุดููุฏ ุจู ูพุงุฑุงูุชุฑูุง ุจุฑุง ุฎุงููโูุง (ุฌูุน ฺฉู = 1.0)
        # ุชูุฑฺฉุฒ ุจุดุชุฑ ุฑู ูุฑู ุตูุฑุชุ ุฌูุณ ููุ ุฑูฺฏ ูพูุณุช ู ุณู
        self.weights_female = {
            'face_shape': 0.30,      # ูููโุชุฑู ุจุฑุง ูุฏู ูู ุฎุงููโูุง
            'hair_type': 0.25,       # ุชุนูโฺฉููุฏู ุงุตู ุจุฑุง ูุฏู ูู
            'skin_color': 0.20,      # ูููโุชุฑู ุจุฑุง ุฑูฺฏ ูู
            'age': 0.15,             # ูุญุฏูุฏุชโูุง ุณู ู ุณุจฺฉ
            'face_condition': 0.05,  # ูุถุนุช ุตูุฑุช (ูุงุบุฑ/ฺุงู)
            'eye_color': 0.03,       # ููุงููฺฏ ุฑูฺฏ
            'eyebrow_color': 0.02,   # ููุงููฺฏ ุฑูฺฏ
        }
        
        # ููุงูู ุณุงุฒฺฏุงุฑ ุฑูฺฏ ูู ุจุง ูพูุณุช ุจุฑุง ุฎุงููโูุง (ูุญุจูุจโุชุฑ ุฏุฑ ุงุฑุงู)
        self.color_harmony_female = {
            "ุฑูุดู ๐": {
                "ูุดฺฉ ุทุจุน": 9, "ูุดฺฉ ุขุจ": 8, "ููููโุง ุดฺฉูุงุช": 9, "ููููโุง ูุณฺฉุงููโุง": 10,
                "ุจูููุฏ ุทูุง": 10, "ุจูููุฏ ฺฉุฑูโุง (Butter Blonde)": 9, "ุจูููุฏ ุฑูุดู": 8,
                "ุฑุฒฺฏูุฏ": 9, "ุตูุฑุช ูพุงุณุชู": 8, "ููููโุง ุฑูุดู": 9, "ููููโุง ฺฉุงุฑุงูู": 10,
                "ุณูุฏ ูพูุงุชูู": 7, "ุขุจ ุฎุงฺฉุณุชุฑ": 6
            },
            "ุณุจุฒู ๐": {
                "ูุดฺฉ ุทุจุน": 10, "ูุดฺฉ ุขุจ": 9, "ููููโุง ุชุฑู": 9, "ููููโุง ุดฺฉูุงุช": 10,
                "ููููโุง ูุณฺฉุงููโุง": 9, "ููููโุง ุฏูุฏ": 8, "ููููโุง ุนุณู": 9,
                "ููููโุง ููุฏู": 8, "ุจูููุฏ ุชุฑู": 7, "ุจูููุฏ ูุชูุณุท": 6,
                "ูุฑูุฒ ุทุจุน": 7, "ูุฑูุฒ ุชุฑู": 8, "ุดุฑุงุจ": 9, "ุขูุจุงูู": 8,
                "ูุณ": 9, "ูุณ ุทูุง": 8, "ุจููุด ุงุณุทูุฎูุฏูุณ": 7
            },
            "ฺฏูุฏู ๐": {
                "ููููโุง ุชุฑู": 9, "ููููโุง ุดฺฉูุงุช": 10, "ููููโุง ูุณฺฉุงููโุง": 9,
                "ููููโุง ูุชูุณุท": 9, "ููููโุง ุฑูุดู": 8, "ููููโุง ฺฉุงุฑุงูู": 9,
                "ููููโุง ุทูุง": 8, "ููููโุง ุฏูุฏ": 7, "ููููโุง ุนุณู": 9,
                "ููููโุง ููุฏู": 8, "ุจูููุฏ ุชุฑู": 8, "ุจูููุฏ ูุชูุณุท": 7,
                "ุจูููุฏ ุทูุง": 8, "ุจูููุฏ ุนุณู": 9, "ูุฑูุฒ ุทุจุน": 8,
                "ูุฑูุฒ ุชุฑู": 9, "ุดุฑุงุจ": 10, "ุขูุจุงูู": 9, "ูุณ": 10,
                "ูุณ ุทูุง": 9, "ุฎุงฺฉุณุชุฑ ููุฑูโุง": 6
            },
            "ุจุฑูุฒู ๐": {
                "ูุดฺฉ ุทุจุน": 10, "ููููโุง ุชุฑู": 9, "ููููโุง ุดฺฉูุงุช": 9,
                "ููููโุง ูุณฺฉุงููโุง": 8, "ููููโุง ูุชูุณุท": 9, "ููููโุง ุฑูุดู": 7,
                "ููููโุง ฺฉุงุฑุงูู": 8, "ููููโุง ุทูุง": 7, "ุจูููุฏ ุชุฑู": 6,
                "ูุฑูุฒ ุทุจุน": 9, "ูุฑูุฒ ุชุฑู": 10, "ุดุฑุงุจ": 9, "ุขูุจุงูู": 10,
                "ูุณ": 9, "ูุณ ูุฑูุฒุฑูฺฏ (Copper Red)": 10, "ุจููุด ุชุฑู (Violet)": 8
            },
            "ุชุฑู ๐": {
                "ูุดฺฉ ุทุจุน": 10, "ููููโุง ุชุฑู": 9, "ููููโุง ุดฺฉูุงุช": 8,
                "ููููโุง ูุณฺฉุงููโุง": 7, "ููููโุง ูุชูุณุท": 8, "ููููโุง ุฑูุดู": 5,
                "ูุฑูุฒ ุทุจุน": 8, "ูุฑูุฒ ุชุฑู": 9, "ุดุฑุงุจ": 8, "ุขูุจุงูู": 9,
                "ูุณ": 8, "ูุณ ูุฑูุฒุฑูฺฏ (Copper Red)": 9, "ุจููุด ุชุฑู (Violet)": 9
            },
            "ุณุฑุฎ ๐": {
                "ูุดฺฉ ุทุจุน": 9, "ููููโุง ุชุฑู": 7, "ููููโุง ุดฺฉูุงุช": 8,
                "ููููโุง ุฏูุฏ": 9, "ููููโุง ุนุณู": 8, "ููููโุง ููุฏู": 7,
                "ุจูููุฏ ูุชูุณุท": 6, "ุจูููุฏ ุนุณู": 7, "ูุฑูุฒ ุทุจุน": 9,
                "ูุฑูุฒ ุชุฑู": 10, "ุดุฑุงุจ": 9, "ุขูุจุงูู": 8,
                "ุฎุงฺฉุณุชุฑ ููุฑูโุง": 8, "ููุฑูโุง ุฑูุดู": 7
            }
        }
        
        # ูุฑู ุตูุฑุช -> ูุฏูโูุง ูููโุงูุนุงุฏู ุณุงุฒฺฏุงุฑ ุจุฑุง ุฎุงููโูุง
        self.face_shape_perfect_match_female = {
            "ุจุถ": [
                "ูุงูโุฏุงุฑ ูุชูุณุท", "ููุฌ ุทุจุน ูุชูุณุท", "ุตุงู ูุชูุณุท ฺฉูุงุณฺฉ",
                "ูุงูโุฏุงุฑ ุจููุฏ V-Cut / Butterfly Cut", "ุตุงู ุทุจุน ุจููุฏ",
                "ุดููู ููู ุจุงุฒ", "ุดููู ูพุงู ฺฏุฑุฏู ุณุงุฏู", "ุจุงูุช ูุฑุงูุณู ฺฉูุงุณฺฉ"
            ],
            "ฺฏูุฑุฏ": [
                "ูุงูโุฏุงุฑ ูุชูุณุท", "ูพฺฉุณ ุจููุฏ ูุงูุชูุงุฑู ูุงูุชุฒ", "ูุฏู ูุงุฑฺ ฺฉูุชุงู",
                "ูุงูโุฏุงุฑ ุจููุฏ V-Cut / Butterfly Cut", "ุฑุดโุฑุด ุจููุฏ",
                "ุดููู ููู ุจุงุฒ", "ููููโฺฉุงุช", "ฺุชุฑ ฺฉโุทุฑูู ุญุฌู"
            ],
            "ูุณุชุทู": [
                "ููุฌ ุทุจุน ูุชูุณุท", "ุตุงู ูุชูุณุท ฺฉูุงุณฺฉ", "ูุฏู ฺฉุฑูโุง ูุชูุณุท",
                "ููุฌ ุณุงุญู / ูุฑ ุจุงุฒ", "ูุฑ ุจุงุฒ ุจููุฏ", "ุดููู ูุฑุงูุณู ฺฏูุฌูโุง",
                "ุจุงูุช ูููุฏ / ุชุงุฌ", "ฺุชุฑ ูพุฑุฏูโุง ูุชูุณุท-ุจููุฏ"
            ],
            "ููุจ": [
                "ูุงูโุฏุงุฑ ูุชูุณุท", "ููุฌ ุทุจุน ูุชูุณุท", "ุตุงู ูุชูุณุท ฺฉูุงุณฺฉ",
                "ูพฺฉุณ ุจููุฏ ูุงูุชูุงุฑู ูุงูุชุฒ", "ูุฏู ูุชูุณุท ุจุง ฺุชุฑ ูพุฑุฏูโุง",
                "ุดููู ููู ุจุงุฒ", "ุจุงูุช ูุฑุงูุณู ฺฉูุงุณฺฉ", "ฺุชุฑ ูพุฑุฏูโุง ูุชูุณุท-ุจููุฏ"
            ],
            "ูุซูุซ": [
                "ูุงูโุฏุงุฑ ูุชูุณุท", "ูพฺฉุณ ุจููุฏ ูุงูุชูุงุฑู ูุงูุชุฒ", "ูุฏู ูุงุฑฺ ฺฉูุชุงู",
                "ูุงูโุฏุงุฑ ุจููุฏ V-Cut / Butterfly Cut", "ุฏูโุงุณุจ ุจููุฏ ุจุง ูุงู",
                "ุชุงูพโูุงุช", "ุจุงูุช ูุงู", "ฺุชุฑ ฺฉโุทุฑูู ุญุฌู"
            ],
            "ูุฑุจุน": [
                "ูุงูโุฏุงุฑ ูุชูุณุท", "ููุฌ ุทุจุน ูุชูุณุท", "ุตุงู ูุชูุณุท ฺฉูุงุณฺฉ",
                "ูุงูโุฏุงุฑ ุจููุฏ V-Cut / Butterfly Cut", "ููุฌ ุณุงุญู / ูุฑ ุจุงุฒ",
                "ุดููู ฺฉูุงุณฺฉ ุจุง ุจุงูุช ุจุงุฒ", "ุจุงูุช ุชุฑฺฉุจ ุจุง ุดููู", "ูู ุฎ / ููุฌ ูุงูุชุฒ"
            ],
            "ุงููุงุณ": [
                "ูุงูโุฏุงุฑ ูุชูุณุท", "ูพฺฉุณ ุจููุฏ ูุงูุชูุงุฑู ูุงูุชุฒ", "ูุฏู ฺฉุฑูโุง ูุชูุณุท",
                "ูุงูโุฏุงุฑ ุจููุฏ V-Cut / Butterfly Cut", "ุตุงู ุทุจุน ุจููุฏ",
                "ุดููู ููู ุจุงุฒ", "ุจุงูุช ูุฑุงูุณู ฺฉูุงุณฺฉ", "ฺุชุฑ ูพุฑุฏูโุง ูุชูุณุท-ุจููุฏ"
            ]
        }
        
        # ุฌูุณ ูู -> ูุฏูโูุง ุบุฑููฺฉู/ูุงููุงุณุจ ุจุฑุง ุฎุงููโูุง
        self.hair_type_exclusions_female = {
            "ุตุงู ๐": [
                "ูุฑ ุจุงุฒ ุจููุฏ", "ููุฌ ุณุงุญู / ูุฑ ุจุงุฒ", "ูู ุฎ / ููุฌ ูุงูุชุฒ",
                "ุฑุดโุฑุด ุจููุฏ"
            ],
            "ููุฌโุฏุงุฑ ๐": [
                "ุตุงู ูุชูุณุท ฺฉูุงุณฺฉ", "ุตุงู ุทุจุน ุจููุฏ", "ุจูุงูุช ุจููุฏ", "ุดููู ูุฑุงูุณู ฺฏูุฌูโุง"
            ],
            "ูุฑ ๐": [
                "ุตุงู ูุชูุณุท ฺฉูุงุณฺฉ", "ุตุงู ุทุจุน ุจููุฏ", "ุจูุงูุช ุจููุฏ", "ููุฌ ุทุจุน ูุชูุณุท"
            ],
            "ูุฒ ๐": [
                "ุตุงู ูุชูุณุท ฺฉูุงุณฺฉ", "ุตุงู ุทุจุน ุจููุฏ", "ุจูุงูุช ุจููุฏ", "ููุฌ ุณุงุญู / ูุฑ ุจุงุฒ"
            ]
        }
        
        # ููุงูู ุณูโูุญูุฑ ุจุฑุง ุฎุงููโูุง
        self.age_constraints_female = {
            "ุชุง 20": {
                "modern_bonus": 1.4, "bold_styles": 1.3, "classic_penalty": -1.5,
                "long_hair_bonus": 1.2, "short_hair_bonus": 1.1, "fancy_bonus": 1.5
            },
            "20-30": {
                "modern_bonus": 1.3, "bold_styles": 1.2, "classic_penalty": -1.0,
                "long_hair_bonus": 1.1, "short_hair_bonus": 1.0, "fancy_bonus": 1.3
            },
            "30-40": {
                "modern_bonus": 1.0, "bold_styles": 1.0, "classic_penalty": 0,
                "long_hair_bonus": 1.0, "short_hair_bonus": 1.0, "fancy_bonus": 1.0
            },
            "40-50": {
                "conservative_bonus": 1.3, "classic_bonus": 1.2, "modern_penalty": -1.0,
                "long_hair_bonus": 1.2, "short_hair_bonus": 1.1, "fancy_penalty": -1.5
            },
            "50-60": {
                "conservative_bonus": 1.5, "classic_bonus": 1.4, "modern_penalty": -2.0,
                "long_hair_bonus": 1.1, "short_hair_bonus": 1.3, "fancy_penalty": -2.0
            },
            "+60": {
                "conservative_bonus": 1.4, "classic_bonus": 1.3, "modern_penalty": -3.0,
                "long_hair_bonus": 1.0, "short_hair_bonus": 1.4, "fancy_penalty": -3.0
            }
        }
        
        # ุฑูฺฏ ฺุดู -> ุฑูฺฏโูุง ูฺฉูู ุจุฑุง ุฎุงููโูุง
        self.eye_color_complements_female = {
            "ูุดฺฉ ๐": {"ูุดฺฉ ุทุจุน": 2, "ูุดฺฉ ุขุจ": 1, "ููููโุง ุชุฑู": 1},
            "ููููโุง ๐": {
                "ููููโุง ุดฺฉูุงุช": 3, "ููููโุง ูุณฺฉุงููโุง": 2, "ููููโุง ุนุณู": 2,
                "ุจูููุฏ ุทูุง": 1, "ุจูููุฏ ฺฉุฑูโุง (Butter Blonde)": 1,
                "ุดุฑุงุจ": 1, "ุขูุจุงูู": 1, "ูุณ": 2
            },
            "ุขุจ ๐": {
                "ูุดฺฉ ุทุจุน": 3, "ูุดฺฉ ุขุจ": 3, "ููููโุง ุชุฑู": 2,
                "ุจูููุฏ ุทูุง": 2, "ุจูููุฏ ุฑูุดู": 2, "ุฎุงฺฉุณุชุฑ ููุฑูโุง": 2
            },
            "ุณุจุฒ ๐": {
                "ููููโุง ุนุณู": 2, "ููููโุง ููุฏู": 2, "ุจูููุฏ ุนุณู": 2,
                "ุดุฑุงุจ": 3, "ุขูุจุงูู": 2, "ูุณ": 3, "ูุณ ุทูุง": 3
            },
            "ุฎุงฺฉุณุชุฑ ๐": {
                "ูุดฺฉ ุขุจ": 2, "ุจูููุฏ ุฎุงฺฉุณุชุฑ": 2, "ุฎุงฺฉุณุชุฑ ููุฑูโุง": 3,
                "ููุฑูโุง ุฑูุดู": 2, "ุขุจ ุฎุงฺฉุณุชุฑ": 2, "ุจููุด ุงุณุทูุฎูุฏูุณ": 1
            },
            "ุนุณู ๐": {
                "ููููโุง ุนุณู": 3, "ููููโุง ููุฏู": 2, "ุจูููุฏ ุนุณู": 3,
                "ูุณ": 2, "ูุณ ุทูุง": 2, "ุดุฑุงุจ": 2, "ุขูุจุงูู": 2
            }
        }
        
        # ุฑูฺฏ ุงุจุฑู -> ุฑูฺฏโูุง ูฺฉูู ุจุฑุง ุฎุงููโูุง
        self.eyebrow_color_complements_female = {
            "ูุดฺฉ": {"ูุดฺฉ ุทุจุน": 3, "ูุดฺฉ ุขุจ": 2, "ููููโุง ุชุฑู": 1},
            "ููููโุง": {
                "ููููโุง ุดฺฉูุงุช": 2, "ููููโุง ูุณฺฉุงููโุง": 2, "ููููโุง ุนุณู": 2,
                "ููููโุง ุฑูุดู": 2, "ุดุฑุงุจ": 1, "ุขูุจุงูู": 1, "ูุณ": 1
            },
            "ุฌูฺฏูุฏูู": {
                "ููููโุง ุฏูุฏู": 2, "ููููโุง ููุฏู": 2, "ุจูููุฏ ุนุณู": 2,
                "ุฎุงฺฉุณุชุฑ ููุฑูโุง": 1, "ููุฑูโุง ุฑูุดู": 1
            },
            "ุจูููุฏ": {
                "ุจูููุฏ ุทูุง": 3, "ุจูููุฏ ุฑูุดู": 2, "ุจูููุฏ ุนุณู": 2,
                "ููููโุง ุฑูุดู": 1, "ููููโุง ฺฉุงุฑุงูู": 1, "ุณูุฏ ูพูุงุชูู": 2,
                "ุฎุงฺฉุณุชุฑ ููุฑูโุง": 2
            },
            "ูุฑูุฒ ุญูุง": {
                "ูุฑูุฒ ุทุจุน": 2, "ูุฑูุฒ ุชุฑู": 2, "ุดุฑุงุจ": 3, "ุขูุจุงูู": 2,
                "ูุณ": 3, "ูุณ ุทูุง": 3, "ูุณ ูุฑูุฒุฑูฺฏ (Copper Red)": 2
            },
            "ุณูุฏ": {
                "ุณูุฏ ูพูุงุชูู": 3, "ุฎุงฺฉุณุชุฑ ููุฑูโุง": 2, "ููุฑูโุง ุฑูุดู": 2,
                "ูุดฺฉ ุทุจุน": 1, "ุจูููุฏ ุฑูุดู": 1
            }
        }
        
        # ูุถุนุช ุตูุฑุช -> ุชูุธูุงุช ูุฏู ูู
        self.face_condition_adjustments = {
            "ูุงุบุฑ": {"add_volume": True, "avoid_short": False, "bonus": 2},
            "ฺุงู": {"add_length": True, "avoid_volume": True, "bonus": 2},
            "ูุนููู": {"balanced": True, "bonus": 0}
        }
    
    def calculate_color_score_female(self, color: str, data: Dict[str, Any]) -> float:
        """ูุญุงุณุจู ุงูุชุงุฒ ฺฉู ฺฉ ุฑูฺฏ ูู ุจุฑุง ุฎุงููโูุง"""
        score = 0.0
        
        # ูพุงู: ุณุงุฒฺฏุงุฑ ุจุง ุฑูฺฏ ูพูุณุช (ูููโุชุฑู ูุงฺฉุชูุฑ)
        skin_color = data.get("skin_color", "ฺฏูุฏู ๐")
        base_score = self.color_harmony_female.get(skin_color, {}).get(color, 5)
        score += base_score * self.weights_female['skin_color']
        
        # ุจูููุณ: ุณุงุฒฺฏุงุฑ ุจุง ุฑูฺฏ ฺุดู
        eye_color = data.get("eye_color", "")
        eye_bonus = self.eye_color_complements_female.get(eye_color, {}).get(color, 0)
        score += eye_bonus * self.weights_female['eye_color']
        
        # ุจูููุณ: ุณุงุฒฺฏุงุฑ ุจุง ุฑูฺฏ ุงุจุฑู
        eyebrow_color = data.get("eyebrow_color", "")
        eyebrow_bonus = self.eyebrow_color_complements_female.get(eyebrow_color, {}).get(color, 0)
        score += eyebrow_bonus * self.weights_female['eyebrow_color']
        
        # ุชูุธู ุจุฑ ุงุณุงุณ ุณู
        age = data.get("age", "30-40")
        age_mod = self.age_constraints_female.get(age, {})
        
        # ุฑูฺฏโูุง ุฌุณูุฑุงูู ุจุฑุง ุฌูุงูโูุง (ุฑูฺฏโูุง ูุงูุชุฒ)
        fancy_colors = [
            "ุฑุฒฺฏูุฏ", "ุตูุฑุช ูพุงุณุชู", "ุตูุฑุช ูพุฑุฑูฺฏ", "ุจููุด ุงุณุทูุฎูุฏูุณ", "ุจููุด ุชุฑู (Violet)",
            "ุขุจ ุชุฑู (Navy Blue)", "ุขุจ ุฎุงฺฉุณุชุฑ", "ุณุจุฒ ุฒุชูู", "ุณุจุฒ ุฒูุฑุฏ", "ุณูุฏ ูพูุงุชูู", "ุจฺ ุฑูุดู"
        ]
        if color in fancy_colors:
            if "ุชุง 20" in age or "20-30" in age:
                score *= age_mod.get("fancy_bonus", 1.0)  # ุชููุช ุจุฑุง ุฌูุงูุงู
            else:
                score *= age_mod.get("fancy_penalty", 1.0)  # ุฌุฑูู ุจุฑุง ูุงูุณุงูุงู
        
        # ุฑูฺฏโูุง ูุญุงูุธูโฺฉุงุฑุงูู ุจุฑุง ูุงูุณุงูุงู
        conservative_colors = ["ูุดฺฉ ุทุจุน", "ููููโุง ุดฺฉูุงุช", "ููููโุง ูุณฺฉุงููโุง", "ููููโุง ุนุณู", "ุจูููุฏ ุทูุง"]
        if color in conservative_colors:
            if "40-50" in age or "50-60" in age or "+60" in age:
                score *= age_mod.get("conservative_bonus", 1.0)
        
        # ุฑูฺฏโูุง ฺฉูุงุณฺฉ ุจุฑุง ููู (ุจูโุฎุตูุต ูุงูุณุงูุงู)
        classic_colors = ["ูุดฺฉ ุทุจุน", "ููููโุง ุดฺฉูุงุช", "ููููโุง ูุณฺฉุงููโุง", "ุจูููุฏ ุทูุง", "ููููโุง ุนุณู"]
        if color in classic_colors:
            score *= age_mod.get("classic_bonus", 1.0)
        
        return score
    
    def calculate_model_score_female(self, model: str, data: Dict[str, Any]) -> float:
        """ูุญุงุณุจู ุงูุชุงุฒ ฺฉู ฺฉ ูุฏู ูู ุจุฑุง ุฎุงููโูุง"""
        score = 0.0
        
        # ุงูุชุงุฒ ูพุงู ุงุฒ ูุฑู ุตูุฑุช (ูููโุชุฑู ูุงฺฉุชูุฑ)
        face_shape = data.get("face_shape", "ุจุถ")
        if model in self.face_shape_perfect_match_female.get(face_shape, []):
            score += 10 * self.weights_female['face_shape']
        else:
            score += 5 * self.weights_female['face_shape']
        
        # ุงูุชุงุฒ ุงุฒ ุฌูุณ ูู (ููุชุฑ ุบุฑููฺฉูโูุง)
        hair_type = data.get("hair_type", "ุตุงู ๐")
        if model in self.hair_type_exclusions_female.get(hair_type, []):
            return -1000  # ูุฏู ุบุฑููฺฉู
        
        # ุจูููุณ ุงุฒ ูุถุนุช ุตูุฑุช (ูุงุบุฑ/ฺุงู)
        face_condition = data.get("face_condition", "ูุนููู")
        face_adj = self.face_condition_adjustments.get(face_condition, {})
        
        if face_condition == "ูุงุบุฑ":
            if any(word in model for word in ["ุญุฌู", "ูุงูโุฏุงุฑ", "ููุฌ", "ูุฑ", "ุฑุดโุฑุด", "V-Cut"]):
                score += face_adj.get("bonus", 0) * self.weights_female['face_condition']
        elif face_condition == "ฺุงู":
            if any(word in model for word in ["ุตุงู", "ุจููุฏ", "V-Cut", "Sleek", "ุตุงู"]):
                score += face_adj.get("bonus", 0) * self.weights_female['face_condition']
        
        # ุชูุธู ุจุฑ ุงุณุงุณ ุณู
        age = data.get("age", "30-40")
        age_mod = self.age_constraints_female.get(age, {})
        
        # ูุฏูโูุง ูุฏุฑู ู ูุงูุชุฒ ุจุฑุง ุฌูุงูุงู
        modern_models = [
            "ูพฺฉุณ ุจููุฏ ูุงูุชูุงุฑู ูุงูุชุฒ", "ููููโฺฉุงุช", "ฺฉุฑูโุง ูุงูุชุฒ",
            "ูู ุฎ / ููุฌ ูุงูุชุฒ", "ููุฌ ุณุงุญู / ูุฑ ุจุงุฒ", "ฺุชุฑ ฺฉโุทุฑูู ุญุฌู"
        ]
        if model in modern_models:
            score *= age_mod.get("modern_bonus", 1.0)
        
        # ูุฏูโูุง ฺฉูุงุณฺฉ ุจุฑุง ูุงูุณุงูุงู
        classic_models = [
            "ุตุงู ูุชูุณุท ฺฉูุงุณฺฉ", "ุตุงู ุทุจุน ุจููุฏ", "ุดููู ูุฑุงูุณู ฺฏูุฌูโุง",
            "ุดููู ูพุงู ฺฏุฑุฏู ุณุงุฏู", "ุจุงูุช ูุฑุงูุณู ฺฉูุงุณฺฉ", "ุจูุงูุช ุจููุฏ"
        ]
        if model in classic_models:
            score *= age_mod.get("classic_bonus", 1.0)
        
        # ูุฏูโูุง ฺฉูุชุงู ุจุฑุง ุณูู ุจุงูุง (ุฑุงุญุช ู ุดฺฉ)
        short_models = [
            "ูุฏู ูุงุฑฺ ฺฉูุชุงู", "ูพฺฉุณ ุจููุฏ ูุงูุชูุงุฑู ูุงูุชุฒ", "ุจุงุจ ฺฉูุงุณฺฉ ูุงูโุฏุงุฑ ุจุง ฺุชุฑ"
        ]
        if model in short_models:
            score *= age_mod.get("short_hair_bonus", 1.0)
        
        # ูุฏูโูุง ุจููุฏ ุจุฑุง ุฌูุงูุงู
        long_models = [
            "ูุงูโุฏุงุฑ ุจููุฏ V-Cut / Butterfly Cut", "ุตุงู ุทุจุน ุจููุฏ",
            "ููุฌ ุณุงุญู / ูุฑ ุจุงุฒ", "ูุฑ ุจุงุฒ ุจููุฏ", "ุฑุดโุฑุด ุจููุฏ", "ุจูุงูุช ุจููุฏ"
        ]
        if model in long_models:
            score *= age_mod.get("long_hair_bonus", 1.0)
        
        # ุงูุชุงุฒ ูพุงู ุจุฑุง ูพูุดุด
        score += 3 * 0.1
        
        return score
    
    def generate_suggestions_female(self, data: Dict[str, Any]) -> Tuple[List[str], List[str]]:
        """
        ุชููุฏ 3 ูุฏู ูู ู 3 ุฑูฺฏ ูู ุจุฑุชุฑ ุจุฑุง ุฎุงููโูุง
        """
        # ูุญุงุณุจู ุงูุชุงุฒุงุช ูุฏู ูู
        model_scores = []
        for model in female_hair_model_options:
            score = self.calculate_model_score_female(model, data)
            if score > -100:  # ููุท ูุฏูโูุง ูุนุชุจุฑ
                model_scores.append((model, score))
        
        # ูุฑุชุจโุณุงุฒ ู ุงูุชุฎุงุจ 3 ูุฏู ุจุฑุชุฑ
        model_scores.sort(key=lambda x: x[1], reverse=True)
        top_models = [model for model, score in model_scores[:3]]
        
        # ูุญุงุณุจู ุงูุชุงุฒุงุช ุฑูฺฏ ูู (ููุท ุงฺฏุฑ ฺฉุงุฑุจุฑ ุฎูุงุณุชู ุฑูฺฏ ฺฉูู)
        top_colors = []
        if data.get("hair_dye") == "ุขุฑู โ":
            current_color = data.get("hair_color", "")
            # ููุชุฑ ุฑูฺฏโูุง ููุฌูุฏ ู ุบุฑุชฺฉุฑุงุฑ
            available_colors = [c for c in female_hair_colors_all if c != current_color]
            
            color_scores = []
            for color in available_colors:
                score = self.calculate_color_score_female(color, data)
                color_scores.append((color, score))
            
            # ูุฑุชุจโุณุงุฒ ู ุงูุชุฎุงุจ 3 ุฑูฺฏ ุจุฑุชุฑ
            color_scores.sort(key=lambda x: x[1], reverse=True)
            top_colors = [color for color, score in color_scores[:3]]
        else:
            top_colors = ["ุฑูฺฏ ุทุจุน (ุจุฏูู ุชุบุฑ)"]
        
        return top_models, top_colors

# ูููููโุง ุงุฒ ููุชูุฑ ุฒูุงูู
female_style_engine = PersianFemaleStyleEngine()




def get_female_hair_model_help() -> str:
    """ูุชู ุฑุงูููุง ูุฏูโูุง ูู ุฒูุงูู ุจุฑุง ููุงุด ุฏุฑ ุจุฎุด Help.
    ุงู ุชุงุจุน ุณุงุฏู ู ุงูู ุงุณุชุ ุฏุฑ ุตูุฑุช ูุงุฒ ูโุชูู ูุชู ุฑุง ฺฏุณุชุฑุด ุฏู.
    """
    return (
        "โน๏ธ ุฑุงูููุง ุฌุงูุน ูุฏูโูุง ูู ุฒูุงูู:\n\n"
        
        "โจ **ูุฏูโูุง ฺฉูุชุงู (Short)**\n"
        "โข **ุจุงุจ ฺฉูุงุณฺฉ ูุงูโุฏุงุฑ ุจุง ฺุชุฑ** โ ุชุง ฺฏุฑุฏูุ ฺฉูุงุณฺฉ ู ุดฺฉุ ููุงุณุจ ูุฑู ุตูุฑุช ุจุถ/ูุฑุจุนุ ูฺฏูุฏุงุฑ ุขุณุงู.\n"
        "โข **ูพฺฉุณ ุจููุฏ ูุงูุชูุงุฑู ูุงูุชุฒ** โ ุฎู ฺฉูุชุงู ุจุง ุทูู ูุชูุงูุชุ ูุฏุฑู ู ุฌุณูุฑุงููุ ููุงุณุจ ุฌูุงูุงู ู ุตูุฑุช ฺฉูฺฺฉ.\n"
        "โข **ูุฏู ูุงุฑฺ (Mushroom) ฺฉูุชุงู** โ ุญุฌู ุจุงูุง ุฏุฑ ุชุงุฌุ ุฏููพุง ุฏุฑ ุงุทุฑุงูุ ุนุงู ุจุฑุง ูููุง ูุฑ ุง ููุฌโุฏุงุฑ.\n"
        "โข **ููููโฺฉุงุช (Wolf Cut)** โ ฺฉูุชุงู ุจุง ูุงูโูุง ูพุฑุงฺฉูุฏูุ ุธุงูุฑ ุฎุดู ู ุจุงุญุงูุ ููุงุณุจ ูููุง ูุงุฒฺฉ ุชุง ูุชูุณุท.\n"
        "โข **ฺุชุฑ ุตุงู ฺฉูุงุณฺฉ ฺฉูุชุงู** โ ฺุชุฑ ฺฉโุฏุณุช ุชุง ุงุจุฑูุ ููุงููฺฏ ุจุง ุจุงุจ ฺฉูุชุงูุ ุธุงูุฑ ุฏุงูุดุฌู ู ุฌูุงู.\n"
        "โข **ฺุชุฑ ฺฉโุทุฑูู ุญุฌู** โ ฺุชุฑ ูุงูุชูุงุฑู ุจุง ุญุฌูุ ุงุณุชุงู ูุฏุฑู ู ููุฑุ ููุงุณุจ ุตูุฑุชโูุง ฺฏุฑุฏ.\n\n"
        
        "๐ **ูุฏูโูุง ูุชูุณุท (Medium)**\n"
        "โข **ูุงูโุฏุงุฑ ูุชูุณุท** โ ุชุง ุดุงููโูุง ุจุง ูุงูโูุง ููุงูุ ุญุฌู ุฏููุฏูุ ููุงุณุจ ููู ูุฑูโูุง ุตูุฑุช.\n"
        "โข **ููุฌ ุทุจุน ูุชูุณุท** โ ุชุง ุดุงูู ุจุง ููุฌโูุง ููุงูุ ุธุงูุฑ ุทุจุน ู ุฑูุงูุชฺฉุ ููุงุณุจ ูููุง ูุงุฒฺฉ.\n"
        "โข **ุตุงู ูุชูุณุท ฺฉูุงุณฺฉ** โ ุชุง ุดุงููุ ฺฉโุฏุณุช ู ูุฑุชุจุ ุงุณุชุงู ุฑุณู ู ุงุฏุงุฑ.\n"
        "โข **ูุฏู ฺฉุฑูโุง ูุชูุณุท** โ ุชุง ุดุงููุ ฺุชุฑ ููุงูุ ุธุงูุฑ ุฌูุงู ู ุขุฑุงูุ ูุญุจูุจ ุฏุฑ ูุงู ุฏุฎุชุฑุงู ุฌูุงู.\n"
        "โข **ูุฏู ูุชูุณุท ุจุง ฺุชุฑ ูพุฑุฏูโุง** โ ฺุชุฑ ุจููุฏ ฺฉูุงุฑ ุตูุฑุชุ ูุงูโุฏุงุฑ ู ููุงูุ ููุงุณุจ ูุฑ ููุจ.\n"
        "โข **ู ุจููุฏ ุณุงุฏู (U-Cut)** โ ุงูุชูุง ุจู ุดฺฉู Uุ ฺฉูุงุณฺฉ ู ุดฺฉุ ููุงุณุจ ูููุง ุจููุฏ ุชุง ูุชูุณุท.\n"
        "โข **ฺุชุฑ ูพุฑุฏูโุง ูุชูุณุท-ุจููุฏ** โ ฺุชุฑ ุจููุฏ ุชุง ฺฏูููโูุงุ ุธุงูุฑ ุธุฑู ู ุฒูุงููุ ุนุงู ุจุฑุง ุตูุฑุช ุจุถ.\n"
        "โข **ูุงูููุฏ ููุฌโุฏุงุฑ** โ ููุฌโูุง ุจุฒุฑฺฏ ู ุฏุฑุงูุงุชฺฉุ ุงุณุชุงู ูุฌูุณ ู ูพุฑ ุฒุฑู ู ุจุฑู.\n\n"
        
        "๐ **ูุฏูโูุง ุจููุฏ (Long)**\n"
        "โข **ูุงูโุฏุงุฑ ุจููุฏ V-Cut / Butterfly Cut** โ ุงูุชูุง V ูุงููุฏุ ุญุฌู ุฏููุฏู ู ุณุจฺฉุ ูุญุจูุจโุชุฑู ูุฏู ุจููุฏ.\n"
        "โข **ุตุงู ุทุจุน ุจููุฏ** โ ุจููุฏ ู ฺฉโุฏุณุชุ ุณุงูู ู ุจุฑุงูุ ฺฉูุงุณฺฉ ู ููุดู ุดฺฉ.\n"
        "โข **ุฏูโุงุณุจ ุจููุฏ ุจุง ูุงู** โ ุฏูโุงุณุจ ุจุง ูุงูโูุง ฺฉูุงุฑุ ุธุงูุฑ ุงุณูพุฑุช ู ุดฺฉ.\n"
        "โข **ูุฑ ุจุงุฒ ุจููุฏ** โ ูุฑูุง ุจุฒุฑฺฏ ู ุฒุจุงุ ุญุฌู ุจุงูุงุ ููุงุณุจ ููุงุฌุจโูุง ูุฌูุณ.\n"
        "โข **ุฑุดโุฑุด ุจููุฏ (Shaggy)** โ ูุงูโูุง ูุงูุชูุงุฑูุ ุธุงูุฑ ุฎุดู ู ุจุงุญุงูุ ููุงุณุจ ุฌูุงูุงู.\n"
        "โข **ุจูุงูุช ุจููุฏ (Blunt)** โ ุงูุชูุง ฺฉโุฏุณุช ู ุตุงูุ ุธุงูุฑ ุญุฑููโุงุ ูุงุฒ ุจู ูฺฏูุฏุงุฑ ุจุงูุง.\n"
        "โข **ูู ุฎ / ููุฌ ูุงูุชุฒ** โ ููุฌโูุง ูุงููุธู ู ููุฑุ ุงุณุชุงู ุฎุงุจุงู ู ูุฏุฑู.\n"
        "โข **ฺฉุฑูโุง ูุงูุชุฒ** โ ุจููุฏ ุจุง ฺุชุฑโูุง ุจุงุฒุ ุฑูฺฏโูุง ูุงูุชุฒุ ุจุฑุง ุฌูุงูุงู ุฌุณูุฑ.\n"
        "โข **ููุฌ ุณุงุญู / ูุฑ ุจุงุฒ (Beach Waves)** โ ููุฌโูุง ููุงู ู ุทุจุนุ ุงุณุชุงู ุฑุงุญุช ู ุฑูุฒูุฑู.\n\n"
        
        "๐ซ **ุดูููโูุง ู ุจุงูุชโูุง (Updos & Braids)**\n"
        "โข **ุดููู ฺฉูุงุณฺฉ ุจุง ุจุงูุช ุจุงุฒ** โ ุดููู ูุฑุชุจ ุจุง ุจุงูุช ุจุงุฒ ุฏุฑ ฺฉูุงุฑูุงุ ุธุงูุฑ ุฎุงููโุงูู ู ูุฌูุณ.\n"
        "โข **ุดููู ูุฑุงูุณู ฺฏูุฌูโุง** โ ุดููู ุจุงูุง ู ฺฏุฑุฏุ ฺฉูุงุณฺฉ ู ููุดู ููุซุฑ.\n"
        "โข **ุดููู ูพุงู ฺฏุฑุฏู ุณุงุฏู** โ ุดููู ูพุงูุ ูุฑุชุจ ู ุฑุณูุ ููุงุณุจ ูุญู ฺฉุงุฑ.\n"
        "โข **ุดููู ููู ุจุงุฒ** โ ูู ุงุฒ ูููุง ุจุงุฒุ ูู ุจุณุชูุ ุงุณุชุงู ุฑูุงูุชฺฉ ู ูุฌูุณ.\n"
        "โข **ุดููู ุญุฌู ูุฏุฑู** โ ุดููู ุจุง ุญุฌู ุจุงูุงุ ุชุงุฌโุฏุงุฑุ ุจุฑุง ูููุงูโูุง ุฎุงุต.\n"
        "โข **ุจุงูุช ูุฑุงูุณู ฺฉูุงุณฺฉ** โ ุจุงูุช ุณู ุชุงุฑ ุณุงุฏูุ ุนุงู ุจุฑุง ูููุนุชโูุง ุฑุณู.\n"
        "โข **ุจุงูุช ูููุฏ / ุชุงุฌ** โ ุจุงูุช ุจุฑุฌุณุชู ู ุฒุจุงุ ุธุงูุฑ ุณูุทูุช ู ุฎุงุต.\n"
        "โข **ุจุงูุช ูุงู** โ ุจุงูุช ุธุฑู ู ุฒุจุงุ ููุงุณุจ ูููุง ุจููุฏ.\n"
        "โข **ุจุงูุช ุชุฑฺฉุจ ุจุง ุดููู** โ ุชุฑฺฉุจ ุจุงูุช ู ุดูููุ ุงุณุชุงู ูพฺุฏู ู ููุฑ.\n\n"
        
    )

async def unknown_handler(update: 'Update', context: 'ContextTypes.DEFAULT_TYPE'):
    """Handler ูพุดโูุฑุถ ุจุฑุง ูพุงูโูุง ูุงูุดุฎุต.
    ูพุงุณุฎ ุณุงุฏูโุง ูโูุฑุณุชุฏ ู ฺฉุงุฑุจุฑ ุฑุง ุจู ุงุณุชูุงุฏู ุงุฒ ุฏฺฉููโูุง ูุฏุงุช ูโฺฉูุฏ.
    """
    if update.message:
        try:
            await update.message.reply_text(
                "ูุนุฐุฑุช โ ูุชูุฌู ูุดุฏู. ูุทูุงู ฺฉ ุงุฒ ฺฏุฒููโูุง ููุงุด ุฑุง ุจุง ุฏฺฉููโูุง ุงูุชุฎุงุจ ฺฉู ุง /start ุจุฒู."
            )
        except Exception:
            # ูุญุงูุธุช ุฏุฑ ุจุฑุงุจุฑ ุฎุทุงูุง ุบุฑููุชุธุฑู (ูุซูุงู ูพุงู ุบุฑูุงุจู ูพุงุณุฎ)
            logger.exception('Failed to reply in unknown_handler')
    return

# ---------- end of added helpers ----------
# ---------- helpers (ุซุงุจุช ูโูุงูุฏ) ----------
def make_keyboard(rows: List[List[str]], resize: bool = True, one_time: bool = True):
    return ReplyKeyboardMarkup(
        [[KeyboardButton(t) for t in row] for row in rows],
        resize_keyboard=resize,
        one_time_keyboard=one_time
    )

def add_back_cancel(rows: List[List[str]]):
    rows.append([BACK, CANCEL])
    return make_keyboard(rows)

def chunked_options(options: List[str], cols: int = 2) -> List[List[str]]:
    rows: List[List[str]] = []
    row: List[str] = []
    for opt in options:
        row.append(opt)
        if len(row) == cols:
            rows.append(row)
            row = []
    if row:
        rows.append(row)
    return rows

def simple_with_back(options: List[str], cols: int = 2):
    rows = chunked_options(options, cols=cols)
    return add_back_cancel(rows)

def hair_model_keyboard_for_page(page: int, page_size: int = 8, is_female: bool = False):
    if is_female:
        all_models = female_hair_model_options
        if page == 0:
            chunk = female_hair_model_popular
        else:
            start = (page - 1) * page_size
            end = start + page_size
            chunk = female_hair_model_other[start:end]
    else:
        common_models = [
            "ูู ุงุฑุชุด (ุชุฑุงุดุฏู)", "ฺฉุฑููพ", "ุณุงุฏู ฺฉูุงุณฺฉ", "ูุฏู ุฑูุฒูุฑู",
            "ุชูพุฑ", "ุณุฒุงุฑ", "ุขูุฏุฑฺฉุงุช", "ูพูููพุงุฏูุฑ"
        ]
        other_models = [model for model in hair_model_options if model not in common_models]
        all_models = common_models + other_models
        total = len(all_models)
        start = page * page_size
        end = start + page_size
        chunk = all_models[start:end]
    
    rows = chunked_options(chunk, cols=2)
    
    nav: List[str] = []
    if page > 0:
        nav.append(PREV_PAGE)
    
    if is_female:
        if page == 0 and len(female_hair_model_other) > 0:
            nav.append(NEXT_PAGE)
        elif page > 0 and ((page * page_size) < len(female_hair_model_other)):
            nav.append(NEXT_PAGE)
    else:
        if end < len(all_models):
            nav.append(NEXT_PAGE)
    
    if nav:
        rows.append(nav)
    rows.append([HELP, BACK, CANCEL])
    return make_keyboard(rows)

def hair_color_keyboard_for_page(page: int, page_size: int = 8):
    """ุตูุญูโุจูุฏ ุฑูฺฏโูุง ูู ุฒูุงูู - ุจุฏูู ุชุบุฑ"""
    start = page * page_size
    end = start + page_size
    chunk = female_hair_colors_all[start:end]
    
    rows = chunked_options(chunk, cols=2)
    
    nav: List[str] = []
    if page > 0:
        nav.append(PREV_PAGE)
    
    total_pages = (len(female_hair_colors_all) + page_size - 1) // page_size
    
    if page < total_pages - 1:
        nav.append(NEXT_PAGE)
    
    if nav:
        rows.append(nav)
    rows.append([BACK, CANCEL])
    
    return make_keyboard(rows)

# ---------- NEW: Fixed Back Button Logic ----------
def get_previous_state(current_state: int, user_data: Dict[str, Any]) -> int:
    """ุชุนู ุงุณุชุช ูุจู ุจุฑ ุงุณุงุณ ุดุฑุงุท ฺฉุงุฑุจุฑ"""
    gender = user_data.get("gender")
    hair_status = user_data.get("hair_status")
    
    # ูุณุฑ ุฒูุงู
    if gender == "ุฒู":
        prev_map = {
            AGE: GENDER,
            HAIR_COLOR: AGE,
            HAIR_TYPE: HAIR_COLOR,
            HAIR_MODEL_FEMALE: HAIR_TYPE,
            HAIR_DYE: HAIR_MODEL_FEMALE,
            FACE_CONDITION: HAIR_DYE,
            FACE_SHAPE: FACE_CONDITION,
            SKIN_COLOR: FACE_SHAPE,
            EYEBROW_COLOR: SKIN_COLOR,
            EYE_COLOR: EYEBROW_COLOR,
            NOSE_TYPE: EYE_COLOR,
            SUMMARY: NOSE_TYPE,
        }
        return prev_map.get(current_state, GENDER)
    
   
    
    # ูุณุฑ ูุฑุฏุงู - ูุถุนุช ูู "ุฌูู ุชุง ูพุดุช ุณุฑ ุจุฏูู ูู" ุง "ุฏุงุฑุง ูู"
    if hair_status in ["ุฌูู ุชุง ูพุดุช ุณุฑ ุจุฏูู ูู", "ุฏุงุฑุง ูู"]:
        prev_map = {
            AGE: GENDER,
            HAIR_STATUS: AGE,
            HAIR_COLOR: HAIR_STATUS,
            HAIR_TYPE: HAIR_COLOR,
        }
        
        # ุจุฑุง HAIR_MODEL ู HAIR_DYE ุจุง ุชูุฌู ุจู skip_hair_model
        if user_data.get("skip_hair_model"):
            prev_map[HAIR_DYE] = HAIR_TYPE
            prev_map[FACE_CONDITION] = HAIR_DYE
        else:
            prev_map[HAIR_MODEL] = HAIR_TYPE
            prev_map[HAIR_DYE] = HAIR_MODEL
            prev_map[FACE_CONDITION] = HAIR_DYE
        
        prev_map.update({
            FACE_SHAPE: FACE_CONDITION,
            SKIN_COLOR: FACE_SHAPE,
            EYEBROW_COLOR: SKIN_COLOR,
            EYE_COLOR: EYEBROW_COLOR,
            NOSE_TYPE: EYE_COLOR,
            BEARD_PRESENT: NOSE_TYPE,
            BEARD_COLOR: BEARD_PRESENT,
            BEARD_MODEL: BEARD_COLOR,
            BEARD_DYE: BEARD_MODEL,
            SUMMARY: BEARD_DYE if user_data.get("beard") == "ุจูู" else NOSE_TYPE,
        })
        
        return prev_map.get(current_state, GENDER)
    
    # ูพุดโูุฑุถ
    return GENDER

# ---------- conversation (ุซุงุจุช ูโูุงูุฏ) ----------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    context.user_data["history"] = []
    kb = make_keyboard([[READY], [CANCEL]])
    await update.message.reply_text(
        "ุณูุงู! ุจู ุฑุจุงุช ุชูฺฏุฑุงู StyleBot ุฎูุด ุงููุฏ! ๐\n\n"
        "๐ค ุงู ุฑุจุงุช ุจุฑุง ูพุดููุงุฏ ูุฏู ู ุฑูฺฏ ูู ุทุฑุงุญ ุดุฏู.\n"
        "๐ฏ ุจุง ฺฉูฺฉ ูู ูโุชูู ุจูุชุฑู ุงุณุชุงู ุฑู ุจุฑ ุงุณุงุณ ูฺฺฏโูุงุช ูพุฏุง ฺฉู.\n\n"
        "๐ซ ุงฺฏู ุขูุงุฏูโุง ุฏฺฉููโ ยซุขูุงุฏูโุงูยป ุฑู ุงูุชุฎุงุจ ฺฉู.",
        reply_markup=kb,
    )
    return GENDER

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    return await start(update, context)

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    await update.message.reply_text(
        "ูุชูุฌู ุดุฏู! ูุฑ ููุช ุฎูุงุณุช ุจุฑฺฏุฑุฏ ูู ุงูุฌุงู. ๐\n"
        "ุจุฑุง ุดุฑูุน ุฏูุจุงุฑู ุงุฒ /start ุงุณุชูุงุฏู ฺฉู.",
        reply_markup=ReplyKeyboardRemove()
    )
    return ConversationHandler.END

# ---------- NEW: Safe-Back Navigation ----------
async def navigate_back(current_state: int, update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ุจุงุฒฺฏุดุช ุชูุฒ ุจู ุงุณุชุช ูุจู ุจุฏูู ูููพ"""
    history = context.user_data.get("history", [])
    if history and history[-1] == current_state:          # ุญุฐู ุงุณุชุช ูุนู
        history.pop()
    prev_state = history[-1] if history else GENDER
    context.user_data["history"] = history
    context.user_data["is_navigating_back"] = True        # ููฺฏ ุฌููฺฏุฑ ุงุฒ ุซุจุช ูุฌุฏุฏ
    return await route_to_state(prev_state, update, context)

async def route_to_state(state, update: Update, context: ContextTypes.DEFAULT_TYPE):
    if state is None:
        return await ask_gender(update, context)

    states_map = {
        GENDER: ask_gender,
        AGE: ask_age,
        HAIR_STATUS: ask_hair_status,
        HAIR_COLOR: ask_hair_color,
        HAIR_TYPE: ask_hair_type,
        HAIR_MODEL: ask_hair_model,
        HAIR_MODEL_FEMALE: ask_hair_model_female,
        HAIR_DYE: ask_hair_dye,
        FACE_CONDITION: ask_face_condition,
        FACE_SHAPE: ask_face_shape,
        SKIN_COLOR: ask_skin_color,
        EYEBROW_COLOR: ask_eyebrow_color,
        EYE_COLOR: ask_eye_color,
        NOSE_TYPE: ask_nose_type,
        BEARD_PRESENT: ask_beard_present,
        BEARD_COLOR: ask_beard_color,
        BEARD_MODEL: ask_beard_model,
        BEARD_DYE: ask_beard_dye,
        SUMMARY: show_summary,
    }
    handler = states_map.get(state, ask_gender)
    return await handler(update, context)

# GENDER
async def ask_gender(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(gender_options, cols=2)
    await update.message.reply_text(" ุฌูุณุช ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(GENDER)
    return GENDER

async def gender_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(GENDER, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text == READY:
        return await ask_gender(update, context)
    if text not in gender_options:
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=simple_with_back(gender_options, cols=2))
        return GENDER
    
    context.user_data["gender"] = text
    return await ask_age(update, context)

# AGE
async def ask_age(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(age_options)
    await update.message.reply_text("๐ ุจุงุฒูโ ุณู ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(AGE)
    return AGE

async def age_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(AGE, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text == READY:
        return await ask_age(update, context)
    if text not in age_options:
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=simple_with_back(age_options))
        return AGE
    
    context.user_data["age"] = text
    
    if context.user_data.get("gender") == "ุฒู":
        return await ask_hair_color(update, context)
    else:
        return await ask_hair_status(update, context)

# HAIR_STATUS - ููุท ุจุฑุง ูุฑุฏุงู
async def ask_hair_status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(hair_status_options)
    await update.message.reply_text("๐ ูุถุนุช ูููุงุช ุฑู ุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(HAIR_STATUS)
    return HAIR_STATUS

async def hair_status_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(HAIR_STATUS, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text not in hair_status_options:
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=simple_with_back(hair_status_options))
        return HAIR_STATUS
    
    context.user_data["hair_status"] = text
    
    if text == "ุฏุงุฑุง ูู":
        return await ask_hair_color(update, context)
    elif text == "ุฌูู ุชุง ูพุดุช ุณุฑ ุจุฏูู ูู":
        context.user_data["skip_hair_model"] = True
        return await ask_hair_color(update, context)

# HAIR COLOR
async def ask_hair_color(update: Update, context: ContextTypes.DEFAULT_TYPE):
    is_female = context.user_data.get("gender") == "ุฒู"
    
    if is_female:
        context.user_data["hair_color_page"] = 0
        kb = hair_color_keyboard_for_page(0)
        await update.message.reply_text("๐จ ุฑูฺฏ ูู ูุนู ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    else:
        kb = simple_with_back(hair_color_options)
        await update.message.reply_text("๐จ ุฑูฺฏ ูู ูุนู ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(HAIR_COLOR)
    return HAIR_COLOR

async def hair_color_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(HAIR_COLOR, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    
    is_female = context.user_data.get("gender") == "ุฒู"
    
    if is_female:
        page = context.user_data.get("hair_color_page", 0)
        
        if text == NEXT_PAGE:
            page += 1
            context.user_data["hair_color_page"] = page
            kb = hair_color_keyboard_for_page(page)
            await update.message.reply_text("๐ ุตูุญู ุจุนุฏ ุฑูฺฏโูุง:", reply_markup=kb)
            return HAIR_COLOR
        
        if text == PREV_PAGE:
            page = max(0, page - 1)
            context.user_data["hair_color_page"] = page
            kb = hair_color_keyboard_for_page(page)
            await update.message.reply_text("๐ ุตูุญู ูุจู ุฑูฺฏโูุง:", reply_markup=kb)
            return HAIR_COLOR
        
        if text not in female_hair_colors_all:
            kb = hair_color_keyboard_for_page(page)
            await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=kb)
            return HAIR_COLOR
        
        context.user_data["hair_color"] = text
        return await ask_hair_type(update, context)
    else:
        if text not in hair_color_options:
            kb = simple_with_back(hair_color_options)
            await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=kb)
            return HAIR_COLOR
        
        context.user_data["hair_color"] = text
        return await ask_hair_type(update, context)

# HAIR TYPE
async def ask_hair_type(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(hair_type_options)
    await update.message.reply_text("๐ ุฌูุณ ูู ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(HAIR_TYPE)
    return HAIR_TYPE

async def hair_type_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(HAIR_TYPE, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text not in hair_type_options:
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=simple_with_back(hair_type_options))
        return HAIR_TYPE
    
    context.user_data["hair_type"] = text
    
    is_female = context.user_data.get("gender") == "ุฒู"
    skip_model = context.user_data.get("skip_hair_model", False)
    
    if is_female:
        context.user_data["hair_page"] = 0
        return await ask_hair_model_female(update, context)
    elif skip_model:
        return await ask_hair_dye(update, context)
    else:
        return await ask_hair_model(update, context)

# HAIR MODEL FOR MALE
async def ask_hair_model(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["hair_page"] = 0
    kb = hair_model_keyboard_for_page(0, is_female=False)
    await update.message.reply_text("๐ ูุฏู ูู ูุนู ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู (ุตูุญูโฺฏุฐุงุฑ):", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(HAIR_MODEL)
    return HAIR_MODEL

async def hair_model_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(HAIR_MODEL, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text == HELP:
        await update.message.reply_text(
            "โน๏ธ ุฑุงูููุง ูุฏูโูุง ูู:\n\n"
            "โข ูู ุงุฑุชุด (ุชุฑุงุดุฏู): ฺฉูุชุงู ู ฺฉุฏุณุชุ ูฺฏูุฏุงุฑ ุขุณุงู\n"
            "โข ฺฉุฑููพ: ฺฉูุชุงู ู ฺฉูุงุณฺฉุ ููุงุณุจ ุชูุงู ุตูุฑุชโูุง\n"
            "โข ุณุฒุงุฑ: ฺฉูุชุงู ุจุง ฺุชุฑ ุตุงูุ ุธุงูุฑ ุฑูู\n"
            "โข ุชูพุฑ: ฺฉูุชุงู ุชุฏุฑุฌุ ุธุงูุฑ ุทุจุน\n"
            "โข ุณุงุฏู ฺฉูุงุณฺฉ: ูุฏู ููุดู ุดฺฉ ู ููุงุณุจ\n"
            "โข ูุฏู ุฑูุฒูุฑู: ุณุงุฏู ู ูุงุจู ูุฏุฑุช ุฑูุฒุงูู\n"
            "โข ุขูุฏุฑฺฉุงุช: ุจุงูุง ุจููุฏุ ุงุทุฑุงู ฺฉูุชุงูุ ูุฏุฑู\n"
            "โข ูพูููพุงุฏูุฑ: ุญุฌู ุจุงูุง ุฏุฑ ุฌููุ ฺฉูุงุณฺฉ\n"
            "โข ูุฏ: ฺฉูุชุงู ุชุฏุฑุฌ ุงุฒ ุจุงูุง ุจู ูพุงู\n"
            "โข ุชฺฉุณฺุฑ ฺฉูุชุงู: ฺฉูุชุงู ุจุง ุจุงูุช ุทุจุน\n"
            "โข ูุงโุงูุฏุช: ูุฏ ุจุณุงุฑ ุจุงูุงุ ูุฏุฑู\n"
            "โข ุงุณฺฉู ูุฏ: ฺฉูุชุงู ุชุง ูพูุณุชุ ุจุณุงุฑ ุชูุฒ\n"
            "โข ุณุงุฏ ูพุงุฑุช: ุฌุฏุงฺฉููุฏู ูุดุฎุตุ ุดฺฉ\n"
            "โข ฺฉุฑุงูพ ุชฺฉุณฺุฑ: ฺฉูุชุงู ุจุง ุจุงูุช ู ุญุฑฺฉุช\n"
            "โข ฺฉูู: ูููุง ุจู ุนูุจ ุดุงูู ุดุฏู\n"
            "โข ุขู ูฺฏ: ฺฉูุชุงู ู ูุฑุชุจุ ฺฉูุงุณฺฉ\n"
            "โข ฺฉูุจโุงููุฑ: ุดูู ุจู ฺฉ ุณูุชุ ุฑุณู\n"
            "โข ูููุงฺฉ: ุฎุท ูุณุท ุจููุฏุ ุฌุณูุฑุงูู\n"
            "โข ูุงฺฉโูุงฺฉ: ูุณุท ุจููุฏุ ุงุทุฑุงู ฺฉูุชุงู\n"
            "โข ุขูุฑู ฺฉูุชุงู: ุญุฌู ฺฏุฑุฏุ ููุงุณุจ ูููุง ูุฑ\n"
            "โข ุชูุฆุณุช: ูููุง ุชุงุจุฏูุ ููุญุตุฑ ุจู ูุฑุฏ\n"
            "โข ุงุณูพุงฺฉ ฺฉูุชุงู: ูููุง ุงุณุชุงุฏูุ ุฌูุงูุงูู\n"
            "โข ุจูฺฉุณูุฑ: ฺฉูุชุงู ู ูุญฺฉูุ ูุฑุฒุด\n"
            "โข ุขููุงู: ฺฉูุชุงู ู ูุฑุชุจุ ุงุฑููพุง\n"
            "โข ุณูู: ฺฉูุชุงู ู ุดฺฉุ ุญุฑููโุง\n"
            "โข ุณุงุฏ ูพุงุฑุช ุณุงุฏู: ุฌุฏุงฺฉููุฏู ุณุงุฏู\n"
            "โข ุณูฺฉโุจฺฉ ุณุงุฏู: ูููุง ุตุงู ุจู ุนูุจ\n"
            "โข ูุงูโุจู ุณุงุฏู: ฺฏุฑู ุณุงุฏู ุจุงูุง ุณุฑ\n"
            "โข ูุชูุณุท ฺฉูุงุณฺฉ: ุทูู ูุชูุณุทุ ุดฺฉ\n"
            "โข ุจุฑู ูููู: ุดุงูู ุจู ุนูุจุ ุทุจุน\n"
            "โข ูุฑูุฌ ูุงูุฑุชุจ: ฺุชุฑ ูุงูุฑุชุจุ ุฌูุงูุงูู\n"
            "โข ุชุงูพโูุงุช: ูููุง ุฌูุน ุดุฏูุ ูุฏุฑู\n"
            "โข ูู ููุฌโุฏุงุฑ ูุชูุณุท: ููุฌ ุทุจุน\n"
            "โข ุชฺฉุณุชฺุฑ ุจููุฏ: ุจููุฏ ุจุง ุจุงูุช\n"
            "โข ูุงูฺฏ ุชฺฉุณฺุฑ: ุจููุฏ ุจุง ุจุงูุช ุทุจุน\n"
            "โข ฺฉุฑุงูพ ูุฑุงูุณู: ฺฉูุชุงู ู ูุฑุชุจ\n"
            "โข ุจุงุชุฒ: ฺฉูุชุงู ุจุง ุทูู ฺฉููุงุฎุช\n"
            "โข ุชฺฉุณุชฺุฑ: ุจุง ุจุงูุช ู ุญุฑฺฉุช\n"
            "โข ูุงูฺฏ ุณูฺฉโุจฺฉ: ุจููุฏ ู ุตุงู ุจู ุนูุจ\n"
            "โข ูุงูโุจู: ฺฏุฑู ูู ุฏุฑ ุจุงูุง ุณุฑ\n"
            "โข ุจููุฏ ฺฉูุงุณฺฉ: ุจููุฏ ู ุดฺฉ\n"
            "โข ุตุงู ู ุจููุฏ: ุจููุฏ ู ุตุงู\n"
            "โข ูู ููุฌโุฏุงุฑ (ุณูุฑูุฑ): ููุฌ ุทุจุน\n"
            "โข ูุฏูโุฏุงุฑ ุจููุฏ: ุจููุฏ ุจุง ุงุณุชุงู\n"
            "โข ุฏุฑุฏูฺฉ: ุจุงูุชโูุง ุจููุฏ ู ูพฺุฏู"
        )
        await update.message.reply_text("๐ ุญุงูุง ูุฏู ูู ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู ๐")
        return HAIR_MODEL

    page = context.user_data.get("hair_page", 0)
    
    if text == NEXT_PAGE:
        page += 1
        context.user_data["hair_page"] = page
        kb = hair_model_keyboard_for_page(page, is_female=False)
        await update.message.reply_text("๐ ุตูุญู ุจุนุฏ ูุฏู ูู:", reply_markup=kb)
        return HAIR_MODEL
    
    if text == PREV_PAGE:
        page = max(0, page - 1)
        context.user_data["hair_page"] = page
        kb = hair_model_keyboard_for_page(page, is_female=False)
        await update.message.reply_text("๐ ุตูุญู ูุจู ูุฏู ูู:", reply_markup=kb)
        return HAIR_MODEL
    
    if text not in hair_model_options:
        kb = hair_model_keyboard_for_page(page, is_female=False)
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=kb)
        return HAIR_MODEL
    
    context.user_data["hair_model"] = text
    return await ask_hair_dye(update, context)

# HAIR MODEL FOR FEMALE (ุซุงุจุช ูโูุงูุฏ)
async def ask_hair_model_female(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["hair_page"] = 0
    kb = hair_model_keyboard_for_page(0, is_female=True)
    await update.message.reply_text("ูุฏู ูู ูุนู ุฎูุฏุช ุฑู ุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(HAIR_MODEL_FEMALE)
    return HAIR_MODEL_FEMALE

async def hair_model_female_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(HAIR_MODEL_FEMALE, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    
    if text == HELP:
        help_text = get_female_hair_model_help()
        await update.message.reply_text(help_text)
        await update.message.reply_text("๐ธ ุญุงูุง ูุฏู ูู ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู ๐")
        return HAIR_MODEL_FEMALE
    
    page = context.user_data.get("hair_page", 0)
    
    if text == NEXT_PAGE:
        page += 1
        context.user_data["hair_page"] = page
        kb = hair_model_keyboard_for_page(page, is_female=True)
        await update.message.reply_text("๐ ุตูุญู ุจุนุฏ ูุฏู ูู:", reply_markup=kb)
        return HAIR_MODEL_FEMALE
    
    if text == PREV_PAGE:
        page = max(0, page - 1)
        context.user_data["hair_page"] = page
        kb = hair_model_keyboard_for_page(page, is_female=True)
        await update.message.reply_text("๐ ุตูุญู ูุจู ูุฏู ูู:", reply_markup=kb)
        return HAIR_MODEL_FEMALE
    
    all_options = female_hair_model_options
    if text not in all_options:
        kb = hair_model_keyboard_for_page(page, is_female=True)
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=kb)
        return HAIR_MODEL_FEMALE
    
    context.user_data["hair_model"] = text
    return await ask_hair_dye(update, context)

# HAIR DYE
async def ask_hair_dye(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(dye_options)
    await update.message.reply_text("๐จ ูโุฎูุง ูููุงุช ุฑู ุฑูฺฏ ฺฉูุ", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(HAIR_DYE)
    return HAIR_DYE

async def hair_dye_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(HAIR_DYE, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text not in dye_options:
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=simple_with_back(dye_options))
        return HAIR_DYE
    
    context.user_data["hair_dye"] = text
    return await ask_face_condition(update, context)

# FACE_CONDITION
async def ask_face_condition(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(face_condition_options)
    await update.message.reply_text("๐ ูุถุนุช ุตูุฑุช ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(FACE_CONDITION)
    return FACE_CONDITION

async def face_condition_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(FACE_CONDITION, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text not in face_condition_options:
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=simple_with_back(face_condition_options))
        return FACE_CONDITION
    
    context.user_data["face_condition"] = text
    return await ask_face_shape(update, context)

# FACE_SHAPE
async def ask_face_shape(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = add_back_cancel([face_shape_options[0:4], face_shape_options[4:7], [HELP]])
    await update.message.reply_text("๐ ูุฑู ุตูุฑุช ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(FACE_SHAPE)
    return FACE_SHAPE

async def face_shape_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(FACE_SHAPE, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    
    if text == HELP:
        # ููุงุด ุชุตุงูุฑ ุฑุงูููุง ูุฑู ุตูุฑุช
        # ุงฺฏุฑ ฺฉุงุฑุจุฑ ุฒู ุจุงุดุฏุ ุงุฒ ุชุตุงูุฑ ุฒูุงูู ุงุณุชูุงุฏู ฺฉู (ุงุณุงู ูุงูโูุง ุฑุง ุฎูุฏุช ุจุนุฏุงู ุชูุธู ูโฺฉู)
        base_path = r"C:\Users\Ali\Documents\StyleBot\face"
        # ูุงู ูุงูโูุง ุชุตุงูุฑ ูุฑุฏุงูู (ููุงู ูุณุฑ ู ูุงูโูุง ูุนู)
        male_files = [
        "beyziM.jpg",
        "gerdM.jpg",
        "mostatiliM.webp",
        "ghalbiM.jpg",
        "mosalasiM.jpg",
        "morabaeiM.jpg",
        "AlmasiM.jpg"
    ]
        # ูุงู ูุงูโูุง ุชุตุงูุฑ ุฒูุงูู - **ุงุณูโูุง ุฑุง ุทุจู ูุงูโูุง ุณุณุชูุช ุชูุธู ฺฉู**
        female_files = [
        "beyziZ.jpg",
        "gerdZ.jpg",
        "mostatiliZ.jpg",
        "ghalbiZ.jpg",
        "mosalasiZ.jpg",
        "morabaeiZ.jpg",
        "AlmasiZ.jpg"
    ]

        # ฺฉูพุดูโูุง ุฏููุงู ููุงู ฺฉูพุดูโูุง ูุณุฎูู ูุฑุฏุงูู ูุณุชูุฏ (ุชู ุฎูุงุณุชู ุจูุฏ)
        captions = [
            "๐ต ุจุถ:\nุตูุฑุช ฺฉุดุฏู ู ูุชูุงุฑูุ ูพุดุงู ฺฉู ูพููโุชุฑ ุงุฒ ฺุงูู.",
            "๐ข ฺฏุฑุฏ:\nุตูุฑุช ุชูุฑุจุงู ุฏุงุฑูโุง ุดฺฉูุ ุทูู ู ุนุฑุถ ูุฒุฏฺฉ ุจู ูู.",
            "๐ฃ ูุณุชุทู:\nุตูุฑุช ฺฉุดุฏู ู ุฒุงููโุฏุงุฑุ ุทูู ุตูุฑุช ุจุดุชุฑ ุงุฒ ุนุฑุถ.",
            "โค๏ธ ููุจ:\nูพุดุงู ูพูู ู ุจุฑุฌุณุชูุ ฺุงูู ุจุงุฑฺฉ ู ููฺฉโุชุฒ.",
            "๐บ ูุซูุซ:\nฺุงูู ูพูู ู ูุดุฎุตุ ูฺฉ ููุ ูพุดุงู ุจุงุฑฺฉโุชุฑ.",
            "๐ง ูุฑุจุน:\nูฺฉ ูู ู ุฒุงููโุฏุงุฑุ ุทูู ู ุนุฑุถ ุตูุฑุช ุชูุฑุจุงู ุจุฑุงุจุฑ.",
            "๐ ุงููุงุณ:\nฺฏูููโูุง ุจุฑุฌุณุชู ู ูพููุ ฺุงูู ู ูพุดุงู ุจุงุฑฺฉโุชุฑ."
        ]

        gender = context.user_data.get("gender", "ูุฑุฏ")
        # ุงูุชุฎุงุจ ูุงูโูุง ุจุฑ ุงุณุงุณ ุฌูุณุช ฺฉุงุฑุจุฑ
        selected_files = female_files if gender == "ุฒู" else male_files

        photos = []
        for fname, caption in zip(selected_files, captions):
            path = os.path.join(base_path, fname)
            photos.append((path, caption))

        # ุงุฑุณุงู ุชุตุงูุฑ ฺฉโฺฉ ุจุง ููุงู ฺฉูพุดูโูุง
        for path, caption in photos:
            try:
                with open(path, "rb") as photo:
                    await update.message.reply_photo(photo=photo, caption=caption)
            except FileNotFoundError:
                await update.message.reply_text(f"โ๏ธ ูุงู ุชุตูุฑ ุงูุช ูุดุฏ: {path}")
            except Exception as e:
                logger.exception("Error sending face guide photo: %s", e)

        await update.message.reply_text("๐ธ ุญุงูุง ูุฑู ุตูุฑุช ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู ๐")
        return FACE_SHAPE
        return FACE_SHAPE

    if text not in face_shape_options:
        await update.message.reply_text(
            "โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู",
            reply_markup=add_back_cancel([face_shape_options[0:4], face_shape_options[4:7], [HELP]])
        )
        return FACE_SHAPE

    context.user_data["face_shape"] = text
    return await ask_skin_color(update, context)

# SKIN COLOR
async def ask_skin_color(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(skin_color_options)
    await update.message.reply_text("๐ ุฑูฺฏ ูพูุณุช ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(SKIN_COLOR)
    return SKIN_COLOR

async def skin_color_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(SKIN_COLOR, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text not in skin_color_options:
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=simple_with_back(skin_color_options))
        return SKIN_COLOR
    
    context.user_data["skin_color"] = text
    return await ask_eyebrow_color(update, context)

# EYEBROW
async def ask_eyebrow_color(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(eyebrow_color_options)
    await update.message.reply_text(" ุฑูฺฏ ุงุจุฑู ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุชูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(EYEBROW_COLOR)
    return EYEBROW_COLOR

async def eyebrow_color_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(EYEBROW_COLOR, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text not in eyebrow_color_options:
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=simple_with_back(eyebrow_color_options))
        return EYEBROW_COLOR
    
    context.user_data["eyebrow_color"] = text
    return await ask_eye_color(update, context)

# EYE COLOR
async def ask_eye_color(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(eye_color_options)
    await update.message.reply_text("๐ ุฑูฺฏ ฺุดู ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(EYE_COLOR)
    return EYE_COLOR

async def eye_color_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(EYE_COLOR, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text not in eye_color_options:
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=simple_with_back(eye_color_options))
        return EYE_COLOR
    
    context.user_data["eye_color"] = text
    return await ask_nose_type(update, context)

# NOSE
async def ask_nose_type(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(nose_type_options)
    await update.message.reply_text("๐ ุชูพ ุจู ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(NOSE_TYPE)
    return NOSE_TYPE

async def nose_type_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(NOSE_TYPE, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text not in nose_type_options:
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=simple_with_back(nose_type_options))
        return NOSE_TYPE
    
    context.user_data["nose_type"] = text
    
    if context.user_data.get("gender") == "ุฒู":
        return await show_summary(update, context)
    else:
        return await ask_beard_present(update, context)

# BEARD - ููุท ุจุฑุง ูุฑุฏุงู
async def ask_beard_present(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(beard_presence_options)
    await update.message.reply_text("๐ง ุขุง ุฑุด ุง ุณุจู ุฏุงุฑุ", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(BEARD_PRESENT)
    return BEARD_PRESENT

async def beard_present_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(BEARD_PRESENT, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text not in beard_presence_options:
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=simple_with_back(beard_presence_options))
        return BEARD_PRESENT
    
    context.user_data["beard"] = "ุจูู" if text == "ุฏุงุฑู ๐ง" else "ุฎุฑ"
    
    if context.user_data["beard"] == "ุจูู":
        return await ask_beard_color(update, context)
    return await show_summary(update, context)

# BEARD COLOR
async def ask_beard_color(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(beard_color_options)
    await update.message.reply_text("๐จ ุฑูฺฏ ุฑุด ู ุณุจู ูุนู ุฎูุฏุช ุฑูุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(BEARD_COLOR)
    return BEARD_COLOR

async def beard_color_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(BEARD_COLOR, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text not in beard_color_options:
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=simple_with_back(beard_color_options))
        return BEARD_COLOR
    
    context.user_data["beard_color"] = text
    return await ask_beard_model(update, context)

async def ask_beard_model(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = add_back_cancel([beard_model_options[0:3], beard_model_options[3:6]])
    await update.message.reply_text("๐ง ูุฏู ูุนู ุฑุด ู ุณุจู ุฎูุฏุชู ุงูุชุฎุงุจ ฺฉู:", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(BEARD_MODEL)
    return BEARD_MODEL

async def beard_model_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(BEARD_MODEL, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text not in beard_model_options:
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=add_back_cancel([beard_model_options[0:3], beard_model_options[3:6]]))
        return BEARD_MODEL
    
    context.user_data["beard_model"] = text
    return await ask_beard_dye(update, context)

# BEARD DYE
async def ask_beard_dye(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(dye_options)
    await update.message.reply_text("๐จ ูโุฎูุง ุฑุดุช / ุณุจูุช ุฑู ุฑูฺฏ ฺฉูุ", reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(BEARD_DYE)
    return BEARD_DYE

async def beard_dye_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(BEARD_DYE, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    if text not in dye_options:
        await update.message.reply_text("โ ูุทูุงู ฺฉ ฺฏุฒูู ุงูุชุฎุงุจ ฺฉู", reply_markup=simple_with_back(dye_options))
        return BEARD_DYE
    
    context.user_data["beard_dye"] = text
    return await show_summary(update, context)

# SUMMARY & SUGGESTIONS
def build_summary_text(data: Dict[str, Any]) -> str:
    lines = ["๐ ุฎูุงุตู ุงุทูุงุนุงุช ุซุจุช ุดุฏู:\n"]
    keys = [
        ("ุฌูุณุช", "gender"),
        ("ุณู", "age"),
    ]
    
    if data.get("gender") == "ูุฑุฏ":
        keys.append(("ูุถุนุช ูู", "hair_status"))
    
    # ููุท ุงุทูุงุนุงุช ูุฑุจูุทู ุฑุง ูุดูู ุจุฏู
    
    keys.extend([
            ("ุฑูฺฏ ูู", "hair_color"),
            ("ุฌูุณ ูู", "hair_type"),
            ("ูุฏู ูู", "hair_model"),
            ("ุฑูฺฏ ฺฉุฑุฏู ูู", "hair_dye"),
        ])
    
    keys.extend([
        ("ูุถุนุช ุตูุฑุช", "face_condition"),
        ("ูุฑู ุตูุฑุช", "face_shape"),
        ("ุฑูฺฏ ูพูุณุช", "skin_color"),
        ("ุฑูฺฏ ุงุจุฑู", "eyebrow_color"),
        ("ุฑูฺฏ ฺุดู", "eye_color"),
        ("ุชูพ ุจู", "nose_type"),
    ])
    
    if data.get("gender") == "ูุฑุฏ":
        keys.extend([
            ("ุฑุด/ุณุจู", "beard"),
            ("ุฑูฺฏ ุฑุด / ุณุจู", "beard_color"),
            ("ูุฏู ุฑุด / ุณุจู", "beard_model"),
            ("ุฑูฺฏ ฺฉุฑุฏู ุฑุด", "beard_dye"),
        ])
    
    for label, key in keys:
        if key in data and data[key] is not None:
            lines.append(f"โข {label}: {data[key]}")
    
    return "\n".join(lines)

async def show_summary(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = ReplyKeyboardMarkup(
        [[KeyboardButton("ุชุฃุฏ โ"), KeyboardButton("ูุงุฒ ุจู ูุฑุงุด โ๏ธ")],
         [KeyboardButton(BACK), KeyboardButton(CANCEL)]],
        resize_keyboard=True,
        one_time_keyboard=True,
    )
    text = build_summary_text(context.user_data)
    await update.message.reply_text(text, reply_markup=kb)
    
    # ุซุจุช ุฏุฑ ุชุงุฑุฎฺู ููุท ุงฺฏุฑ ุงุฒ ุฏฺฉููโ ุจุงุฒฺฏุดุช ูุงูุฏูโุงู
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(SUMMARY)
    return SUMMARY

async def summary_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(SUMMARY, update, context)   # โ ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ
    
    if text == "ุชุฃุฏ โ":
        suggestions = generate_detailed_suggestions(context.user_data)
        reply = suggestions
        kb = ReplyKeyboardMarkup(
            [[KeyboardButton(START)]],
            resize_keyboard=True,
            one_time_keyboard=False,
        )
        await update.message.reply_text(reply, reply_markup=kb)
        context.user_data.clear()
        return ConversationHandler.END
    
    if text == "ูุงุฒ ุจู ูุฑุงุด โ๏ธ":
        context.user_data.setdefault("history", []).append(GENDER)
        return await ask_gender(update, context)
    
    await update.message.reply_text(
        "โ ูุทูุงู ฺฉ ุฏฺฉูู ุงูุชุฎุงุจ ฺฉู.",
        reply_markup=ReplyKeyboardMarkup(
            [[KeyboardButton("ุชุฃุฏ โ"), KeyboardButton("ูุงุฒ ุจู ูุฑุงุด โ๏ธ")]],
            resize_keyboard=True,
            one_time_keyboard=True,
        ),
    )
    return SUMMARY

# ---------- NEW: Intelligent Suggestion Generator ----------
def generate_detailed_suggestions(data: Dict[str, Any]) -> str:
    """ุชููุฏ ูพุดููุงุฏูุง ุชุฎุตุต ุจุง ุงุณุชูุงุฏู ุงุฒ ููุชูุฑ ููุดููุฏ"""
    gender = data.get("gender")
    
    if gender == "ุฒู":
        # ุจุฑุง ุฒูุงู - ุงูฺฏูุฑุชู ููุดููุฏ ุฌุฏุฏ
        return suggest_female_style(data)
    else:
        # ุจุฑุง ูุฑุฏุงู - ุงูฺฏูุฑุชู ููุดููุฏ ูุจู
        return suggest_male_style(data)

def suggest_female_style(data: Dict[str, Any]) -> str:
    """ุงูฺฏูุฑุชู ูพุดุฑูุชู ุจุฑุง ุฎุงููโูุง - 3 ูุฏู + 3 ุฑูฺฏ"""
    
    # ุฏุฑุงูุช ูพุดููุงุฏูุง ููุดููุฏ ุงุฒ ููุชูุฑ ุฒูุงูู
    top_models, top_colors = female_style_engine.generate_suggestions_female(data)
    
    # ุณุงุฎุช ูพุงู ููุง ุจุง ูุฑูุช ุฏุฑุฎูุงุณุช
    result = "๐ฏ ูพุดููุงุฏูุง ุชุฎุตุต ูู ุจุฑุง ุดูุง:\n\n"
    
    # ุจุฎุด ูุฏู ูู
    result += "๐ ูุฏู ูู ูพุดููุงุฏ:\n"
    if len(top_models) >= 1:
        result += f"ูุฏู ุงูู (ุงูููุช ุงูู): {top_models[0]}\n"
    if len(top_models) >= 2:
        result += f"ูุฏู ุฏูู (ุงูููุช ุฏูู): {top_models[1]}\n"
    if len(top_models) >= 3:
        result += f"ูุฏู ุณูู (ุงูููุช ุณูู): {top_models[2]}\n"
    
    # ุจุฎุด ุฑูฺฏ ูู
    result += "\n๐จ ุจูุชุฑู ุฑูฺฏ ูพุดููุงุฏ ูู:\n"
    if len(top_colors) >= 1:
        result += f"ุฑูฺฏ ุงูู (ุงูููุช ุงูู): {top_colors[0]}\n"
    if len(top_colors) >= 2:
        result += f"ุฑูฺฏ ุฏูู (ุงูููุช ุฏูู): {top_colors[1]}\n"
    if len(top_colors) >= 3:
        result += f"ุฑูฺฏ ุณูู (ุงูููุช ุณูู): {top_colors[2]}\n"
    
    return result

def suggest_male_style(data: Dict[str, Any]) -> str:
    """ุงูฺฏูุฑุชู ูพุดุฑูุชู ุจุฑุง ุขูุงุงู"""
    
    # ูุถุนุช ูู
    hair_status = data.get("hair_status", "ุฏุงุฑุง ูู")
    

    # ---------- ุชุบุฑ 4: ุญุฐู ุฑูฺฏ ูุนู ุงุฒ ูพุดููุงุฏุงุช ----------
    # ูุญุงุณุจู ุจูุชุฑู ุฑูฺฏ ูู
    hair_dye = data.get("hair_dye", "ูู โ")
    suggested_hair_color = None
    if hair_dye == "ุขุฑู โ":
        # ---------- ุชุบุฑ 4: ุญุฐู ุฑูฺฏ ูุนู ุงุฒ ูุณุช ูพุดููุงุฏุงุช ----------
        current_hair_color = data.get("hair_color")
        available_colors = [color for color in AVAILABLE_DYE_COLORS if color != current_hair_color]
        
        # ูุญุงุณุจู ุชูุงู ุฑูฺฏโูุง ู ุงูุชุฎุงุจ ุจูุชุฑู
        color_scores = []
        for color in available_colors:
            score = style_engine.calculate_color_score(color, data)
            color_scores.append((color, score))
        
        color_scores.sort(key=lambda x: x[1], reverse=True)
        suggested_hair_color = color_scores[0][0]
    
    # ูุญุงุณุจู ุจูุชุฑู ูุฏู ูู
    valid_models = hair_model_options.copy()
    
    # ููุชุฑ ุจุฑ ุงุณุงุณ ุฌูุณ ูู
    hair_type = data.get("hair_type", "ุตุงู ๐")
    if hair_type in style_engine.hair_type_exclusions:
        valid_models = [m for m in valid_models if m not in style_engine.hair_type_exclusions[hair_type]]
    
    # ูุญุงุณุจู ุงูุชุงุฒ ูุฏูโูุง
    model_scores = []
    for model in valid_models:
        score = style_engine.calculate_hair_model_score(model, data)
        model_scores.append((model, score))
        model_scores.sort(key=lambda x: x[1], reverse=True)
    suggested_hair_model = model_scores[0][0]
    
    # ูุญุงุณุจู ุจูุชุฑู ูุฏู ุฑุด
    beard_present = data.get("beard", "ุฎุฑ")
    suggested_beard_model = "ุชูโุฑุด"
    suggested_beard_color = "ูุดฺฉ"
    
    # ---------- ุชุบุฑ 5: ูพุดููุงุฏ ุจุฑุง ฺฉุงุฑุจุฑุงู ุจุฏูู ุฑุด ----------
    if beard_present == "ุฎุฑ":
        beard_text = "\n๐ง ูุฏู ุฑุด ูพุดููุงุฏ: ุงุตูุงุญ ฺฉุงูู ุตูุฑุช"
        beard_color_text = "\n๐จ ุจูุชุฑู ุฑูฺฏ ูพุดููุงุฏ ุฑุด: ุทุจุน"
    else:
        beard_dye = data.get("beard_dye", "ูู โ")
        current_beard_color = data.get("beard_color", "ูุดฺฉ")
        current_hair_color = data.get("hair_color", "ูุดฺฉ")
        
        # ุงูุชุฎุงุจ ูุฏู ุฑุด
        valid_beard_models = beard_model_options.copy()
        beard_scores = []
        for model in valid_beard_models:
            score = style_engine.calculate_beard_model_score(model, data)
            beard_scores.append((model, score))
        
        beard_scores.sort(key=lambda x: x[1], reverse=True)
        suggested_beard_model = beard_scores[0][0]
        
        # ุงูุชุฎุงุจ ุฑูฺฏ ุฑุด
        if beard_dye == "ุขุฑู โ":
            # ---------- ุชุบุฑ 4: ุญุฐู ุฑูฺฏ ูุนู ุฑุด ุงุฒ ูพุดููุงุฏุงุช ----------
            suggested_beard_color = style_engine.get_harmonious_beard_color(
                suggested_hair_color or current_hair_color,
                data.get("skin_color", "ฺฏูุฏู ๐"),
                data.get("age", "30-40"),
                current_beard_color
            )

        else:
            suggested_beard_color = "ุทุจุน"
        
        beard_text = f"\n๐ง ูุฏู ุฑุด ูพุดููุงุฏ: {suggested_beard_model}"
        beard_color_text = f"\n๐จ ุจูุชุฑู ุฑูฺฏ ูพุดููุงุฏ ุฑุด: {suggested_beard_color if beard_dye == 'ุขุฑู โ' else 'ุทุจุน'}"
    
    # ุชููุฏ ูุชุฌู ููุง
    if hair_status == "ุฌูู ุชุง ูพุดุช ุณุฑ ุจุฏูู ูู":
        hair_text = "๐ ูุฏู ูู ูพุดููุงุฏ: ุงุตูุงุญ ุณุงุฏู ุฏูุฑ ุณุฑ"
    else:
        hair_text = f"๐ ูุฏู ูู ูพุดููุงุฏ: {suggested_hair_model}"
    
    color_text = f"\n๐จ ุจูุชุฑู ุฑูฺฏ ูพุดููุงุฏ ูู: {suggested_hair_color if hair_dye == 'ุขุฑู โ' else 'ุทุจุน'}"
    
    return f"๐ฏ ูพุดููุงุฏูุง ุชุฎุตุต ูู ุจุฑุง ุดูุง:\n\n{hair_text}{color_text}{beard_text}{beard_color_text}"

# ---------- DATA FOR FEMALE (ุซุงุจุช) ----------
female_hair_colors_all = [
    # ุตูุญู 0 - ุฑูฺฏโูุง ูุนููู ู ุชุฑูุฏ
    "ูุดฺฉ ุทุจุน", "ูุดฺฉ ุขุจ", "ุฌูฺฏูุฏูู", "ุณูุฏ",
    "ููููโุง ุชุฑู", "ููููโุง ุดฺฉูุงุช", "ููููโุง ูุณฺฉุงููโุง", "ููููโุง ุฒุบุงู",
    # ุตูุญู 1
    "ููููโุง ูุชูุณุท", "ููููโุง ุฑูุดู", "ููููโุง ฺฉุงุฑุงูู", "ููููโุง ุทูุง",
    "ููููโุง ุฏูุฏ", "ููููโุง ุนุณู", "ููููโุง ููุฏู", "ุจูููุฏ ุชุฑู",
    # ุตูุญู 2
    "ุจูููุฏ ูุชูุณุท", "ุจูููุฏ ุฑูุดู", "ุจูููุฏ ุทูุง", "ุจูููุฏ ุฎุงฺฉุณุชุฑ",
    "ุจูููุฏ ุนุณู", "ุจูููุฏ ูพูุงุชูู", "ุจูููุฏ ฺฉุฑูโุง (Butter Blonde)", "ุจูููุฏ ุชูุชโูุฑูฺฏ (Strawberry Blonde)",
    # ุตูุญู 3
    "ูุฑูุฒ ุทุจุน", "ูุฑูุฒ ุชุฑู", "ุดุฑุงุจ", "ุขูุจุงูู", "ูุณ", "ูุณ ุฑูุดู",
    "ูุณ ุทูุง", "ูุณ ูุฑูุฒุฑูฺฏ (Copper Red)",
    # ุตูุญู 4
    "ุฑุฒฺฏูุฏ", "ุตูุฑุช ูพุงุณุชู", "ุตูุฑุช ูพุฑุฑูฺฏ", "ุจููุด ุงุณุทูุฎูุฏูุณ",
    "ุจููุด ุชุฑู (Violet)", "ุฎุงฺฉุณุชุฑ ููุฑูโุง", "ููุฑูโุง ุฑูุดู", "ุขุจ ุชุฑู (Navy Blue)",
    # ุตูุญู 5
    "ุขุจ ุฎุงฺฉุณุชุฑ", "ุณุจุฒ ุฒุชูู", "ุณุจุฒ ุฒูุฑุฏ", "ุณูุฏ ูพูุงุชูู", "ุจฺ ุฑูุดู"
]

female_hair_model_popular = [
    "ูุนููู", "ุจุงุจ ฺฉูุงุณฺฉ ูุงูโุฏุงุฑ ุจุง ฺุชุฑ", "ูพฺฉุณ ุจููุฏ ูุงูุชูุงุฑู ูุงูุชุฒ",
    "ูุฏู ูุงุฑฺ ฺฉูุชุงู", "ูุงูโุฏุงุฑ ูุชูุณุท", "ููุฌ ุทุจุน ูุชูุณุท", "ุตุงู ูุชูุณุท ฺฉูุงุณฺฉ",
    "ูุฏู ฺฉุฑูโุง ูุชูุณุท"
]

female_hair_model_other = [
    "ูุฏู ูุชูุณุท ุจุง ฺุชุฑ ูพุฑุฏูโุง", "ูุงูโุฏุงุฑ ุจููุฏ V-Cut / Butterfly Cut", "ุตุงู ุทุจุน ุจููุฏ",
    "ููุฌ ุณุงุญู / ูุฑ ุจุงุฒ", "ุฏูโุงุณุจ ุจููุฏ ุจุง ูุงู", "ูุฑ ุจุงุฒ ุจููุฏ", "ุฑุดโุฑุด ุจููุฏ",
    "ู ุจููุฏ ุณุงุฏู", "ฺุชุฑ ูพุฑุฏูโุง ูุชูุณุท-ุจููุฏ", "ฺุชุฑ ุตุงู ฺฉูุงุณฺฉ ฺฉูุชุงู",
    "ฺุชุฑ ฺฉโุทุฑูู ุญุฌู", "ุดููู ฺฉูุงุณฺฉ ุจุง ุจุงูุช ุจุงุฒ", "ุดููู ูุฑุงูุณู ฺฏูุฌูโุง",
    "ุดููู ูพุงู ฺฏุฑุฏู ุณุงุฏู", "ุดููู ููู ุจุงุฒ", "ุดููู ุญุฌู ูุฏุฑู",
    "ุจุงูุช ูุฑุงูุณู ฺฉูุงุณฺฉ", "ุจุงูุช ูููุฏ / ุชุงุฌ", "ุจุงูุช ูุงู",
    "ุจุงูุช ุชุฑฺฉุจ ุจุง ุดููู", "ููููโฺฉุงุช", "ูุงูููุฏ ููุฌโุฏุงุฑ",
    "ฺฉุฑูโุง ูุงูุชุฒ", "ุจูุงูุช ุจููุฏ", "ูู ุฎ / ููุฌ ูุงูุชุฒ"
]

female_hair_model_options = female_hair_model_popular + female_hair_model_other

# ---------- Error handler ----------
async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.error(f"Error occurred: {context.error}", exc_info=context.error)
    if update and update.effective_message:
        await update.effective_message.reply_text(
            "โ ุฎุทุง ุฑุฎ ุฏุงุฏ! ูุทูุงู ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ."
        )

# build conversation handler
def build_conv_handler():
    return ConversationHandler(
        entry_points=[CommandHandler("start", start), MessageHandler(filters.Text(START), start_command)],
        states={
            GENDER: [MessageHandler(filters.TEXT & ~filters.COMMAND, gender_handler)],
            AGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, age_handler)],
            HAIR_STATUS: [MessageHandler(filters.TEXT & ~filters.COMMAND, hair_status_handler)],
            HAIR_COLOR: [MessageHandler(filters.TEXT & ~filters.COMMAND, hair_color_handler)],
            HAIR_TYPE: [MessageHandler(filters.TEXT & ~filters.COMMAND, hair_type_handler)],
            HAIR_MODEL: [MessageHandler(filters.TEXT & ~filters.COMMAND, hair_model_handler)],
            HAIR_MODEL_FEMALE: [MessageHandler(filters.TEXT & ~filters.COMMAND, hair_model_female_handler)],
            HAIR_DYE: [MessageHandler(filters.TEXT & ~filters.COMMAND, hair_dye_handler)],
            FACE_CONDITION: [MessageHandler(filters.TEXT & ~filters.COMMAND, face_condition_handler)],
            FACE_SHAPE: [MessageHandler(filters.TEXT & ~filters.COMMAND, face_shape_handler)],
            SKIN_COLOR: [MessageHandler(filters.TEXT & ~filters.COMMAND, skin_color_handler)],
            EYEBROW_COLOR: [MessageHandler(filters.TEXT & ~filters.COMMAND, eyebrow_color_handler)],
            EYE_COLOR: [MessageHandler(filters.TEXT & ~filters.COMMAND, eye_color_handler)],
            NOSE_TYPE: [MessageHandler(filters.TEXT & ~filters.COMMAND, nose_type_handler)],
            BEARD_PRESENT: [MessageHandler(filters.TEXT & ~filters.COMMAND, beard_present_handler)],
            BEARD_COLOR: [MessageHandler(filters.TEXT & ~filters.COMMAND, beard_color_handler)],
            BEARD_MODEL: [MessageHandler(filters.TEXT & ~filters.COMMAND, beard_model_handler)],
            BEARD_DYE: [MessageHandler(filters.TEXT & ~filters.COMMAND, beard_dye_handler)],
            SUMMARY: [MessageHandler(filters.TEXT & ~filters.COMMAND, summary_handler)],
        },
        fallbacks=[
            CommandHandler("cancel", cancel),
            MessageHandler(filters.TEXT & ~filters.COMMAND, unknown_handler)
        ],
        allow_reentry=True,
    )

# Setup bot commands menu
async def post_init(application: Application) -> None:
    await application.bot.set_my_commands([
        BotCommand("start", "ุดุฑูุน ูุฌุฏุฏ ุฑุจุงุช")
    ])

if __name__ == "__main__":
    if not BOT_TOKEN or BOT_TOKEN == "YOUR_TOKEN_HERE":
        logger.error("โ ุชูฺฉู ุฑุจุงุช ุฏุฑ ูุชุบุฑ ูุญุท BOT_TOKEN ุชูุธู ูุดุฏู.")
    else:
        app = ApplicationBuilder().token(BOT_TOKEN).post_init(post_init).build()

        conv = build_conv_handler()
        app.add_handler(conv)

        app.add_handler(MessageHandler(filters.Text(START), start_command))

        app.add_handler(CommandHandler("help", lambda update, context: update.message.reply_text(
            "๐ค ุฑุงูููุง ุฑุจุงุช StyleBot:\n"
            "โข ุงุฒ /start ุง ุฏฺฉูู 'ุดุฑูุน' ุจุฑุง ุดุฑูุน ุงุณุชูุงุฏู ฺฉู\n"
            "โข ูโุชูู ุฏุฑ ูุฑ ูุฑุญูู ุจุง ุฏฺฉููโูุง ุจุงุฒฺฏุดุช ู ุงูุตุฑุงู ฺฉูุชุฑู ฺฉู\n"
            "โข ูพุดููุงุฏูุง ุจุฑ ุงุณุงุณ ูฺฺฏโูุง ุดุฎุต ุชู ุชููุฏ ูโุดู"
        )))

        app.add_error_handler(error_handler)

        print("โ Bot is running")
        app.run_polling()
           