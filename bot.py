import os
import logging
import asyncio
import random
from dotenv import load_dotenv
from typing import Dict, Any, List, Tuple
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove, BotCommand
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    ConversationHandler,
    filters,
    Application,
)






load_dotenv()

BOT_TOKEN = os.getenv("BOT_TOKEN", "YOUR_TOKEN_HERE")

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# states
(
    GENDER, AGE, HAIR_STATUS, HAIR_COLOR, HAIR_TYPE, HAIR_MODEL, HAIR_MODEL_FEMALE, HAIR_DYE,
    FACE_CONDITION, FACE_SHAPE, SKIN_COLOR, EYEBROW_COLOR, EYE_COLOR, NOSE_TYPE,
    BEARD_PRESENT, BEARD_COLOR, BEARD_MODEL, BEARD_DYE, SUMMARY,
) = range(19)

# emoji labels
BACK = "Ø¨Ø§Ø²Ú¯Ø´Øª ğŸ”™"
CANCEL = "Ø§Ù†ØµØ±Ø§Ù âŒ"
READY = "Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù… âœ…"
NEXT_PAGE = "Ø¨Ø¹Ø¯ÛŒ â–¶ï¸"
PREV_PAGE = "Ù‚Ø¨Ù„ÛŒ â—€ï¸"
RESTART = "Ø´Ø±ÙˆØ¹ /start"
START = "Ø´Ø±ÙˆØ¹"
HELP = "Ø±Ø§Ù‡Ù†Ù…Ø§ â„¹ï¸"

# option arrays
gender_options = ["Ù…Ø±Ø¯", "Ø²Ù†"]
age_options = ["ØªØ§ 20", "20-30", "30-40", "40-50", "50-60", "+60"]
hair_status_options = ["Ø¯Ø§Ø±Ø§ÛŒ Ù…Ùˆ", "Ø¬Ù„Ùˆ ØªØ§ Ù¾Ø´Øª Ø³Ø± Ø¨Ø¯ÙˆÙ† Ù…Ùˆ"]

# ---------- ØªØºÛŒÛŒØ± 1: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø¨Ù‡ Ø±Ù†Ú¯ Ù…ÙˆÙ‡Ø§ÛŒ Ù…Ø±Ø¯Ø§Ù† ----------
hair_color_options = ["Ù…Ø´Ú©ÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†", "Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±", "Ø¬ÙˆÚ¯Ù†Ø¯ÙˆÙ…ÛŒ", "Ù‚Ø±Ù…Ø² Ø­Ù†Ø§ÛŒÛŒ", "Ø³ÙÛŒØ¯", "Ø®Ø§Ú©Ø³ØªØ±ÛŒ"]

hair_type_options = ["ØµØ§Ù ğŸ’‡", "Ù…ÙˆØ¬â€ŒØ¯Ø§Ø± ğŸ’‡", "ÙØ± ğŸ’‡", "ÙˆØ² ğŸ’‡"]
face_condition_options = ["Ù…Ø¹Ù…ÙˆÙ„ÛŒ", "Ù„Ø§ØºØ±", "Ú†Ø§Ù‚"]
face_shape_options = ["Ø¨ÛŒØ¶ÛŒ", "Ú¯ÙØ±Ø¯", "Ù…Ø³ØªØ·ÛŒÙ„", "Ù‚Ù„Ø¨ÛŒ", "Ù…Ø«Ù„Ø«ÛŒ", "Ù…Ø±Ø¨Ø¹ÛŒ", "Ø§Ù„Ù…Ø§Ø³ÛŒ"]
skin_color_options = ["Ø±ÙˆØ´Ù† ğŸŒ", "Ø³Ø¨Ø²Ù‡ ğŸŒ", "Ú¯Ù†Ø¯Ù…ÛŒ ğŸŒ", "Ø¨Ø±Ù†Ø²Ù‡ ğŸŒ", "ØªÛŒØ±Ù‡ ğŸŒ", "Ø³Ø±Ø® ğŸŒ"]
eyebrow_color_options = ["Ù…Ø´Ú©ÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ", "Ø¬ÙˆÚ¯Ù†Ø¯ÙˆÙ…ÛŒ", "Ø¨Ù„ÙˆÙ†Ø¯", "Ù‚Ø±Ù…Ø² Ø­Ù†Ø§ÛŒÛŒ", "Ø³ÙÛŒØ¯"]
eye_color_options = ["Ù…Ø´Ú©ÛŒ ğŸ‘", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ğŸ‘", "Ø¢Ø¨ÛŒ ğŸ‘", "Ø³Ø¨Ø² ğŸ‘", "Ø®Ø§Ú©Ø³ØªØ±ÛŒ ğŸ‘", "Ø¹Ø³Ù„ÛŒ ğŸ‘"]
nose_type_options = ["Ø§Ø³ØªØ®ÙˆØ§Ù†ÛŒ ğŸ‘ƒ", "Ú¯ÙˆØ´ØªÛŒ ğŸ‘ƒ", "Ù…Ø¹Ù…ÙˆÙ„ÛŒ ğŸ‘ƒ"]
dye_options = ["Ø¢Ø±Ù‡ âœ…", "Ù†Ù‡ âŒ"]
beard_presence_options = ["Ø¯Ø§Ø±Ù… ğŸ§”", "Ù†Ø¯Ø§Ø±Ù… âŒ"]

# ---------- Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ (Ø«Ø§Ø¨Øª) ----------
# ---------- ØªØºÛŒÛŒØ± 2: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø¨Ù‡ AVAILABLE_DYE_COLORS ----------
AVAILABLE_DYE_COLORS = ["Ù…Ø´Ú©ÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†", "Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±", "Ø®Ø§Ú©Ø³ØªØ±ÛŒ", "Ø­Ù†Ø§ÛŒÛŒ", "Ø´ÛŒØ±ÛŒ"]

# Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÛŒ Ù…Ø±Ø¯Ø§Ù†Ù‡ (Ø«Ø§Ø¨Øª)
hair_model_options = [
    "Ù…ÙˆÛŒ Ø§Ø±ØªØ´ÛŒ (ØªØ±Ø§Ø´ÛŒØ¯Ù‡)", "Ú©Ø±ÙˆÙ¾", "Ø³Ø²Ø§Ø±", "ØªÛŒÙ¾Ø±", "Ø³Ø§Ø¯Ù‡ Ú©Ù„Ø§Ø³ÛŒÚ©", "Ù…Ø¯Ù„ Ø±ÙˆØ²Ù…Ø±Ù‡",
    "Ø¢Ù†Ø¯Ø±Ú©Ø§Øª", "Ù¾ÙˆÙ…Ù¾Ø§Ø¯ÙˆØ±", "ÙÛŒØ¯", "ØªÚ©Ø³Ú†Ø± Ú©ÙˆØªØ§Ù‡", "Ù‡Ø§ÛŒâ€ŒØ§Ù†Ø¯Øª", "Ø§Ø³Ú©ÛŒÙ† ÙÛŒØ¯", "Ø³Ø§ÛŒØ¯ Ù¾Ø§Ø±Øª",
    "Ú©Ø±Ø§Ù¾ ØªÚ©Ø³Ú†Ø±", "Ú©ÙˆÛŒÙ", "Ø¢ÛŒÙˆÛŒ Ù„ÛŒÚ¯", "Ú©Ù…Ø¨â€ŒØ§ÙˆÙØ±", "Ù…ÙˆÙ‡Ø§Ú©", "ÙØ§Ú©â€ŒÙ‡Ø§Ú©", "Ø¢ÙØ±Ùˆ Ú©ÙˆØªØ§Ù‡",
    "ØªÙˆØ¦ÛŒØ³Øª", "Ø§Ø³Ù¾Ø§ÛŒÚ©ÛŒ Ú©ÙˆØªØ§Ù‡", "Ø¨ÙˆÚ©Ø³ÙˆØ±ÛŒ", "Ø¢Ù„Ù…Ø§Ù†ÛŒ", "Ø³ÙˆÙ†", "Ø³Ø§ÛŒØ¯ Ù¾Ø§Ø±Øª Ø³Ø§Ø¯Ù‡",
    "Ø³Ù„ÛŒÚ©â€ŒØ¨Ú© Ø³Ø§Ø¯Ù‡", "Ù…Ø§Ù†â€ŒØ¨Ù† Ø³Ø§Ø¯Ù‡", "Ù…ØªÙˆØ³Ø· Ú©Ù„Ø§Ø³ÛŒÚ©", "Ø¨Ø±Ùˆ ÙÙÙ„Ùˆ", "ÙØ±ÛŒÙ†Ø¬ Ù†Ø§Ù…Ø±ØªØ¨",
    "ØªØ§Ù¾â€ŒÙ†Ø§Øª", "Ù…ÙˆÛŒ Ù…ÙˆØ¬â€ŒØ¯Ø§Ø± Ù…ØªÙˆØ³Ø·", "ØªÚ©Ø³ØªÚ†Ø± Ø¨Ù„Ù†Ø¯", "Ù„Ø§Ù†Ú¯ ØªÚ©Ø³Ú†Ø±", "Ú©Ø±Ø§Ù¾ ÙØ±Ø§Ù†Ø³ÙˆÛŒ",
    "Ø¨Ø§ØªØ²", "ØªÚ©Ø³ØªÚ†Ø±", "Ù„Ø§Ù†Ú¯ Ø³Ù„ÛŒÚ©â€ŒØ¨Ú©", "Ù…Ø§Ù†â€ŒØ¨Ù†", "Ø¨Ù„Ù†Ø¯ Ú©Ù„Ø§Ø³ÛŒÚ©", "ØµØ§Ù Ùˆ Ø¨Ù„Ù†Ø¯",
    "Ù…ÙˆÛŒ Ù…ÙˆØ¬â€ŒØ¯Ø§Ø± (Ø³ÙˆØ±ÙØ±)", "Ù…Ø¯Ù„â€ŒØ¯Ø§Ø± Ø¨Ù„Ù†Ø¯", "Ø¯Ø±Ø¯Ù„Ú©"
]

# Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ´ (Ø«Ø§Ø¨Øª)
beard_model_options = [
    "Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ú©ÙˆØªØ§Ù‡", "Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ø¨Ù„Ù†Ø¯", "ØªÙ‡â€ŒØ±ÛŒØ´", "Ø³Ø¨ÛŒÙ„",
    "Ø±ÛŒØ´ Ú†Ø§Ù†Ù‡â€ŒØ§ÛŒ (Goatee)", "Ø±ÛŒØ´ Ù¾Ø±ÙˆÙØ³ÙˆØ±ÛŒ Ú©Ù„Ø§Ø³ÛŒÚ©"
]

# Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ´ (Ø«Ø§Ø¨Øª)
beard_color_options = ["Ù…Ø´Ú©ÛŒ", "Ø¨ÙˆØ±/ Ø¨Ù„ÙˆÙ†Ø¯", "Ø³ÙÛŒØ¯", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ", "Ù‚Ø±Ù…Ø² Ø­Ù†Ø§ÛŒÛŒ", "Ø¬ÙˆÚ¯Ù†Ø¯ÙˆÙ…ÛŒ"]

# ---------- NEW: Intelligent Style Engine ----------
class PersianStyleEngine:
    """
    Ù…ÙˆØªÙˆØ± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø¢Ù‚Ø§ÛŒØ§Ù† Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆÛŒÚ˜Ù‡ Ø§ÛŒØ±Ø§Ù†
    """
    
    def __init__(self):
        # ÙˆØ²Ù†â€ŒØ¯Ù‡ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ù‡ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ (Ø¬Ù…Ø¹ Ú©Ù„ = 1.0)
        self.weights = {
            'face_shape': 0.35,      # Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ù…Ø¯Ù„ Ù…Ùˆ
            'hair_type': 0.25,       # ØªØ¹ÛŒÛŒÙ†â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø¯Ù„ Ù…Ùˆ
            'skin_color': 0.20,      # Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø±Ù†Ú¯
            'age': 0.10,             # Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø³Ù†ÛŒ
            'eye_color': 0.05,       # Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø±Ù†Ú¯ÛŒ
            'eyebrow_color': 0.03,   # Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø±Ù†Ú¯ÛŒ
            'nose_type': 0.01,       # Ø¬Ø²Ø¦ÛŒØ§Øª ØµÙˆØ±Øª
            'face_condition': 0.01,  # Ø¬Ø²Ø¦ÛŒØ§Øª ØµÙˆØ±Øª
        }
        
        # ---------- ØªØºÛŒÛŒØ± 2: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø¨Ù‡ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ ----------
        # Ù‚ÙˆØ§Ù†ÛŒÙ† Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø±Ù†Ú¯â€ŒÙ‡Ø§
        self.color_harmony_rules = {
            # Ø±Ù†Ú¯ Ù¾ÙˆØ³Øª -> (Ø±Ù†Ú¯ Ù…Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ: Ø§Ù†Ø±Ú˜ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ)
            "Ø±ÙˆØ´Ù† ğŸŒ": {
                "Ù…Ø´Ú©ÛŒ": 6, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 7, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 9, "Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±": 10,
                "Ø®Ø§Ú©Ø³ØªØ±ÛŒ": 8, "Ø­Ù†Ø§ÛŒÛŒ": 5, "Ø´ÛŒØ±ÛŒ": 9
            },
            "Ø³Ø¨Ø²Ù‡ ğŸŒ": {
                "Ù…Ø´Ú©ÛŒ": 10, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 7, "Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±": 3,
                "Ø®Ø§Ú©Ø³ØªØ±ÛŒ": 6, "Ø­Ù†Ø§ÛŒÛŒ": 8, "Ø´ÛŒØ±ÛŒ": 5
            },
            "Ú¯Ù†Ø¯Ù…ÛŒ ğŸŒ": {
                "Ù…Ø´Ú©ÛŒ": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 10, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 8, "Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±": 6,
                "Ø®Ø§Ú©Ø³ØªØ±ÛŒ": 7, "Ø­Ù†Ø§ÛŒÛŒ": 7, "Ø´ÛŒØ±ÛŒ": 6
            },
            "Ø¨Ø±Ù†Ø²Ù‡ ğŸŒ": {
                "Ù…Ø´Ú©ÛŒ": 10, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 7, "Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±": 2,
                "Ø®Ø§Ú©Ø³ØªØ±ÛŒ": 5, "Ø­Ù†Ø§ÛŒÛŒ": 6, "Ø´ÛŒØ±ÛŒ": 4
            },
            "ØªÛŒØ±Ù‡ ğŸŒ": {
                "Ù…Ø´Ú©ÛŒ": 10, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 8, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 4, "Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±": 1,
                "Ø®Ø§Ú©Ø³ØªØ±ÛŒ": 4, "Ø­Ù†Ø§ÛŒÛŒ": 5, "Ø´ÛŒØ±ÛŒ": 3
            },
            "Ø³Ø±Ø® ğŸŒ": {
                "Ù…Ø´Ú©ÛŒ": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 5, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 6, "Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±": 2,
                "Ø®Ø§Ú©Ø³ØªØ±ÛŒ": 7, "Ø­Ù†Ø§ÛŒÛŒ": 7, "Ø´ÛŒØ±ÛŒ": 5
            }
        }
        
        # Ù‚ÙˆØ§Ù†ÛŒÙ† Ø³Ù†â€ŒÙ…Ø­ÙˆØ±
        self.age_constraints = {
            "ØªØ§ 20": {"bold_styles": 1.2, "conservative_penalty": -2, "modern_bonus": 1.5},
            "20-30": {"bold_styles": 1.1, "conservative_penalty": -1, "modern_bonus": 1.3},
            "30-40": {"bold_styles": 1.0, "conservative_penalty": 0, "modern_bonus": 1.0},
            "40-50": {"conservative_bonus": 1.2, "bold_penalty": -1, "classic_bonus": 1.3},
            "50-60": {"conservative_bonus": 1.4, "bold_penalty": -2, "classic_bonus": 1.5},
            "+60": {"conservative_bonus": 1.3, "bold_penalty": -3, "classic_bonus": 1.4},
        }
        
        # ÙØ±Ù… ØµÙˆØ±Øª -> Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡ Ø³Ø§Ø²Ú¯Ø§Ø± (Ø§Ù…ØªÛŒØ§Ø² Ù¾Ø§ÛŒÙ‡ 10)
        self.face_shape_perfect_match = {
            "Ø¨ÛŒØ¶ÛŒ": ["Ø¢Ù†Ø¯Ø±Ú©Ø§Øª", "Ø³Ø§ÛŒØ¯ Ù¾Ø§Ø±Øª", "Ù¾ÙˆÙ…Ù¾Ø§Ø¯ÙˆØ±", "Ø³Ø§Ø¯Ù‡ Ú©Ù„Ø§Ø³ÛŒÚ©", "Ù…Ø¯Ù„ Ø±ÙˆØ²Ù…Ø±Ù‡", "Ú©Ø±ÙˆÙ¾", "Ø¢ÛŒÙˆÛŒ Ù„ÛŒÚ¯"],
            "Ú¯ÙØ±Ø¯": ["Ø¢Ù†Ø¯Ø±Ú©Ø§Øª", "ÙÛŒØ¯", "Ù‡Ø§ÛŒâ€ŒØ§Ù†Ø¯Øª", "ØªÛŒÙ¾Ø±", "Ø§Ø³Ú©ÛŒÙ† ÙÛŒØ¯", "Ú©Ø±ÙˆÙ¾"],
            "Ù…Ø³ØªØ·ÛŒÙ„": ["Ú©Ø±ÙˆÙ¾", "Ø³Ø²Ø§Ø±", "ØªÚ©Ø³Ú†Ø± Ú©ÙˆØªØ§Ù‡", "Ù…ØªÙˆØ³Ø· Ú©Ù„Ø§Ø³ÛŒÚ©", "Ø¢ÛŒÙˆÛŒ Ù„ÛŒÚ¯", "Ø¢Ù„Ù…Ø§Ù†ÛŒ", "Ø³ÙˆÙ†"],
            "Ù‚Ù„Ø¨ÛŒ": ["Ø³Ø§ÛŒØ¯ Ù¾Ø§Ø±Øª", "ÙØ±ÛŒÙ†Ø¬ Ù†Ø§Ù…Ø±ØªØ¨", "ØªÛŒÙ¾Ø±", "Ú©ÙˆÛŒÙ", "Ø³Ù„ÛŒÚ©â€ŒØ¨Ú© Ø³Ø§Ø¯Ù‡", "Ú©Ø±ÙˆÙ¾", "Ú©Ø±Ø§Ù¾ ÙØ±Ø§Ù†Ø³ÙˆÛŒ"],
            "Ù…Ø«Ù„Ø«ÛŒ": ["ØªØ§Ù¾â€ŒÙ†Ø§Øª", "Ù¾ÙˆÙ…Ù¾Ø§Ø¯ÙˆØ±", "Ù…ÙˆÛŒ Ù…ÙˆØ¬â€ŒØ¯Ø§Ø± Ù…ØªÙˆØ³Ø·", "Ù…ÙˆÙ‡Ø§Ú©", "ÙØ§Ú©â€ŒÙ‡Ø§Ú©", "Ø¯Ø±Ø¯Ù„Ú©"],
            "Ù…Ø±Ø¨Ø¹ÛŒ": ["Ú©Ø±ÙˆÙ¾", "Ù…ÙˆÛŒ Ø§Ø±ØªØ´ÛŒ (ØªØ±Ø§Ø´ÛŒØ¯Ù‡)", "Ø§Ø³Ú©ÛŒÙ† ÙÛŒØ¯", "Ø¢Ù†Ø¯Ø±Ú©Ø§Øª", "ØªÛŒÙ¾Ø±", "Ø¨Ø§ØªØ²", "Ø¢Ù„Ù…Ø§Ù†ÛŒ"],
            "Ø§Ù„Ù…Ø§Ø³ÛŒ": ["Ø³Ø§ÛŒØ¯ Ù¾Ø§Ø±Øª", "Ø¨Ø±Ùˆ ÙÙÙ„Ùˆ", "ÙØ±ÛŒÙ†Ø¬ Ù†Ø§Ù…Ø±ØªØ¨", "Ú©Ù…Ø¨â€ŒØ§ÙˆÙØ±", "Ø³Ø§ÛŒØ¯ Ù¾Ø§Ø±Øª Ø³Ø§Ø¯Ù‡", "Ú©Ø±Ø§Ù¾ ÙØ±Ø§Ù†Ø³ÙˆÛŒ"]
        }
        
        # Ø¬Ù†Ø³ Ù…Ùˆ -> Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ ØºÛŒØ±Ù…Ù…Ú©Ù† (Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯)
        self.hair_type_exclusions = {
            "ØµØ§Ù ğŸ’‡": ["Ø¢ÙØ±Ùˆ Ú©ÙˆØªØ§Ù‡", "ØªÙˆØ¦ÛŒØ³Øª", "Ø¯Ø±Ø¯Ù„Ú©"],
            "Ù…ÙˆØ¬â€ŒØ¯Ø§Ø± ğŸ’‡": ["Ù…ÙˆÛŒ Ø§Ø±ØªØ´ÛŒ (ØªØ±Ø§Ø´ÛŒØ¯Ù‡)", "Ø§Ø³Ú©ÛŒÙ† ÙÛŒØ¯"],
            "ÙØ± ğŸ’‡": ["Ø³Ù„ÛŒÚ©â€ŒØ¨Ú© Ø³Ø§Ø¯Ù‡", "Ø¢ÛŒÙˆÛŒ Ù„ÛŒÚ¯", "Ú©Ù…Ø¨â€ŒØ§ÙˆÙØ±", "Ø§Ø³Ú©ÛŒÙ† ÙÛŒØ¯"],
            "ÙˆØ² ğŸ’‡": ["Ø³Ù„ÛŒÚ©â€ŒØ¨Ú© Ø³Ø§Ø¯Ù‡", "Ù¾ÙˆÙ…Ù¾Ø§Ø¯ÙˆØ±", "Ú©ÙˆÛŒÙ", "Ù„Ø§Ù†Ú¯ Ø³Ù„ÛŒÚ©â€ŒØ¨Ú©"]
        }
        
        # Ø±Ù†Ú¯ Ú†Ø´Ù… -> Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…Ú©Ù…Ù„ (Ø¨ÙˆÙ†ÙˆØ³)
        self.eye_color_complements = {
            "Ù…Ø´Ú©ÛŒ ğŸ‘": {"Ù…Ø´Ú©ÛŒ": 2, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 1},
            "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ğŸ‘": {"Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±": 2, "Ø­Ù†Ø§ÛŒÛŒ": 1, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 1},
            "Ø¢Ø¨ÛŒ ğŸ‘": {"Ù…Ø´Ú©ÛŒ": 3, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 2},
            "Ø³Ø¨Ø² ğŸ‘": {"Ø­Ù†Ø§ÛŒÛŒ": 2, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 1},
            "Ø®Ø§Ú©Ø³ØªØ±ÛŒ ğŸ‘": {"Ø®Ø§Ú©Ø³ØªØ±ÛŒ": 2, "Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±": 1},
            "Ø¹Ø³Ù„ÛŒ ğŸ‘": {"Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 2, "Ø­Ù†Ø§ÛŒÛŒ": 1}
        }
        
        # Ø±Ù†Ú¯ Ø§Ø¨Ø±Ùˆ -> Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…Ú©Ù…Ù„
        self.eyebrow_color_complements = {
            "Ù…Ø´Ú©ÛŒ": {"Ù…Ø´Ú©ÛŒ": 2, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 1},
            "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ": {"Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 2, "Ø­Ù†Ø§ÛŒÛŒ": 1, "Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±": 1},
            "Ø¬ÙˆÚ¯Ù†Ø¯ÙˆÙ…ÛŒ": {"Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 2, "Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±": 1},
            "Ø¨Ù„ÙˆÙ†Ø¯": {"Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±": 3, "Ø´ÛŒØ±ÛŒ": 2, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 1},
            "Ù‚Ø±Ù…Ø² Ø­Ù†Ø§ÛŒÛŒ": {"Ø­Ù†Ø§ÛŒÛŒ": 3, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 1},
            "Ø³ÙÛŒØ¯": {"Ø®Ø§Ú©Ø³ØªØ±ÛŒ": 2, "Ø´ÛŒØ±ÛŒ": 2}
        }
        
        # Ù†ÙˆØ¹ Ø¨ÛŒÙ†ÛŒ -> Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯
        self.nose_type_harmony = {
            "Ø§Ø³ØªØ®ÙˆØ§Ù†ÛŒ ğŸ‘ƒ": {"Ù¾ÙˆÙ…Ù¾Ø§Ø¯ÙˆØ±": 2, "Ø³Ø§ÛŒØ¯ Ù¾Ø§Ø±Øª": 1, "Ù…ÙˆÙ‡Ø§Ú©": 2, "ÙØ§Ú©â€ŒÙ‡Ø§Ú©": 1},
            "Ú¯ÙˆØ´ØªÛŒ ğŸ‘ƒ": {"Ú©Ø±ÙˆÙ¾": 2, "ØªÛŒÙ¾Ø±": 2, "ÙØ±ÛŒÙ†Ø¬ Ù†Ø§Ù…Ø±ØªØ¨": 2, "Ø¨Ø±Ùˆ ÙÙÙ„Ùˆ": 1},
            "Ù…Ø¹Ù…ÙˆÙ„ÛŒ ğŸ‘ƒ": {"Ù…Ø¯Ù„ Ø±ÙˆØ²Ù…Ø±Ù‡": 2, "Ø³Ø§Ø¯Ù‡ Ú©Ù„Ø§Ø³ÛŒÚ©": 1, "Ù…ØªÙˆØ³Ø· Ú©Ù„Ø§Ø³ÛŒÚ©": 1}
        }
        
        # Ù…Ø¯Ù„ Ø±ÛŒØ´ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ±Ù… ØµÙˆØ±Øª
        self.beard_face_match = {
            "Ø¨ÛŒØ¶ÛŒ": ["Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ú©ÙˆØªØ§Ù‡", "Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ø¨Ù„Ù†Ø¯", "Ø±ÛŒØ´ Ú†Ø§Ù†Ù‡â€ŒØ§ÛŒ (Goatee)"],
            "Ú¯ÙØ±Ø¯": ["Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ø¨Ù„Ù†Ø¯", "ØªÙ‡â€ŒØ±ÛŒØ´", "Ø³Ø¨ÛŒÙ„"],
            "Ù…Ø³ØªØ·ÛŒÙ„": ["Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ú©ÙˆØªØ§Ù‡", "ØªÙ‡â€ŒØ±ÛŒØ´", "Ø±ÛŒØ´ Ú†Ø§Ù†Ù‡â€ŒØ§ÛŒ (Goatee)"],
            "Ù‚Ù„Ø¨ÛŒ": ["Ø±ÛŒØ´ Ú†Ø§Ù†Ù‡â€ŒØ§ÛŒ (Goatee)", "Ø³Ø¨ÛŒÙ„", "ØªÙ‡â€ŒØ±ÛŒØ´"],
            "Ù…Ø«Ù„Ø«ÛŒ": ["Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ø¨Ù„Ù†Ø¯", "Ø³Ø¨ÛŒÙ„", "Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ú©ÙˆØªØ§Ù‡"],
            "Ù…Ø±Ø¨Ø¹ÛŒ": ["Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ú©ÙˆØªØ§Ù‡", "ØªÙ‡â€ŒØ±ÛŒØ´", "Ø³Ø¨ÛŒÙ„"],
            "Ø§Ù„Ù…Ø§Ø³ÛŒ": ["Ø±ÛŒØ´ Ú†Ø§Ù†Ù‡â€ŒØ§ÛŒ (Goatee)", "Ø³Ø¨ÛŒÙ„", "ØªÙ‡â€ŒØ±ÛŒØ´"]
        }
        
        # Ù…Ø¯Ù„ Ø±ÛŒØ´ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ù†
        self.beard_age_match = {
            "ØªØ§ 20": ["ØªÙ‡â€ŒØ±ÛŒØ´", "Ø³Ø¨ÛŒÙ„", "Ø±ÛŒØ´ Ú†Ø§Ù†Ù‡â€ŒØ§ÛŒ (Goatee)"],
            "20-30": ["Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ú©ÙˆØªØ§Ù‡", "ØªÙ‡â€ŒØ±ÛŒØ´", "Ø±ÛŒØ´ Ú†Ø§Ù†Ù‡â€ŒØ§ÛŒ (Goatee)"],
            "30-40": ["Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ú©ÙˆØªØ§Ù‡", "Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ø¨Ù„Ù†Ø¯", "Ø±ÛŒØ´ Ú†Ø§Ù†Ù‡â€ŒØ§ÛŒ (Goatee)"],
            "40-50": ["Ø±ÛŒØ´ Ù¾Ø±ÙˆÙØ³ÙˆØ±ÛŒ Ú©Ù„Ø§Ø³ÛŒÚ©", "Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ú©ÙˆØªØ§Ù‡", "ØªÙ‡â€ŒØ±ÛŒØ´"],
            "50-60": ["Ø±ÛŒØ´ Ù¾Ø±ÙˆÙØ³ÙˆØ±ÛŒ Ú©Ù„Ø§Ø³ÛŒÚ©", "Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ú©ÙˆØªØ§Ù‡", "Ø³Ø¨ÛŒÙ„"],
            "+60": ["Ø±ÛŒØ´ Ù¾Ø±ÙˆÙØ³ÙˆØ±ÛŒ Ú©Ù„Ø§Ø³ÛŒÚ©", "Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ú©Ø§Ù…Ù„ Ú©ÙˆØªØ§Ù‡", "ØªÙ‡â€ŒØ±ÛŒØ´"]
        }
    
    def calculate_color_score(self, color: str, data: Dict[str, Any]) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ÛŒ ÛŒÚ© Ø±Ù†Ú¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù‡Ù…Ù‡ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§"""
        score = 0.0
        
        # Ù¾Ø§ÛŒÙ‡: Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ Ø±Ù†Ú¯ Ù¾ÙˆØ³Øª
        skin_color = data.get("skin_color", "Ú¯Ù†Ø¯Ù…ÛŒ ğŸŒ")
        score += self.color_harmony_rules.get(skin_color, {}).get(color, 5) * self.weights['skin_color']
        
        # Ø¨ÙˆÙ†ÙˆØ³: Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ Ø±Ù†Ú¯ Ú†Ø´Ù…
        eye_color = data.get("eye_color", "")
        eye_bonus = self.eye_color_complements.get(eye_color, {}).get(color, 0)
        score += eye_bonus * self.weights['eye_color']
        
        # Ø¨ÙˆÙ†ÙˆØ³: Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ Ø±Ù†Ú¯ Ø§Ø¨Ø±Ùˆ
        eyebrow_color = data.get("eyebrow_color", "")
        eyebrow_bonus = self.eyebrow_color_complements.get(eyebrow_color, {}).get(color, 0)
        score += eyebrow_bonus * self.weights['eyebrow_color']
        
        # ØªÙ†Ø¸ÛŒÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ù†
        age = data.get("age", "30-40")
        age_mod = self.age_constraints.get(age, {})
        
        # Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø¬Ø³ÙˆØ±Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø¬ÙˆØ§Ù†â€ŒÙ‡Ø§
        if color in ["Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±", "Ø­Ù†Ø§ÛŒÛŒ", "Ø´ÛŒØ±ÛŒ"]:
            if "ØªØ§ 20" in age or "20-30" in age:
                score *= 1.1
            elif "40-50" in age or "50-60" in age or "+60" in age:
                score *= 0.8
        
        # Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø§ÙØ¸Ù‡â€ŒÚ©Ø§Ø±Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù…ÛŒØ§Ù†Ø³Ø§Ù„â€ŒÙ‡Ø§
        if color in ["Ù…Ø´Ú©ÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡"]:
            if "40-50" in age or "50-60" in age or "+60" in age:
                score *= 1.1
            elif "ØªØ§ 20" in age:
                score *= 0.9
        
        return score
    
    def calculate_hair_model_score(self, model: str, data: Dict[str, Any]) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ÛŒ ÛŒÚ© Ù…Ø¯Ù„ Ù…Ùˆ"""
        score = 0.0
        
        # Ø§Ù…ØªÛŒØ§Ø² Ù¾Ø§ÛŒÙ‡ Ø§Ø² ÙØ±Ù… ØµÙˆØ±Øª
        face_shape = data.get("face_shape", "Ø¨ÛŒØ¶ÛŒ")
        if model in self.face_shape_perfect_match.get(face_shape, []):
            score += 10 * self.weights['face_shape']
        else:
            score += 5 * self.weights['face_shape']
        
        # Ø§Ù…ØªÛŒØ§Ø² Ø§Ø² Ø¬Ù†Ø³ Ù…Ùˆ
        hair_type = data.get("hair_type", "ØµØ§Ù ğŸ’‡")
        if model in self.hair_type_exclusions.get(hair_type, []):
            # Ù…Ø¯Ù„ ØºÛŒØ±Ù…Ù…Ú©Ù† - Ø§Ù…ØªÛŒØ§Ø² Ù…Ù†ÙÛŒ Ø´Ø¯ÛŒØ¯
            return -1000
        
        # Ø¨ÙˆÙ†ÙˆØ³ Ø§Ø² Ù†ÙˆØ¹ Ø¨ÛŒÙ†ÛŒ
        nose_type = data.get("nose_type", "Ù…Ø¹Ù…ÙˆÙ„ÛŒ ğŸ‘ƒ")
        nose_bonus = self.nose_type_harmony.get(nose_type, {}).get(model, 0)
        score += nose_bonus * self.weights['nose_type']
        
        # ØªÙ†Ø¸ÛŒÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ù†
        age = data.get("age", "30-40")
        age_mod = self.age_constraints.get(age, {})
        
        # Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¬Ø³ÙˆØ±Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø¬ÙˆØ§Ù†â€ŒÙ‡Ø§
        bold_models = ["Ù…ÙˆÙ‡Ø§Ú©", "ÙØ§Ú©â€ŒÙ‡Ø§Ú©", "Ø§Ø³Ù¾Ø§ÛŒÚ©ÛŒ Ú©ÙˆØªØ§Ù‡", "ØªØ§Ù¾â€ŒÙ†Ø§Øª", "Ø¯Ø±Ø¯Ù„Ú©"]
        if model in bold_models:
            score += age_mod.get("bold_styles", 1.0) * 3
            score += age_mod.get("bold_penalty", 0) * 2
        
        # Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ú©Ù„Ø§Ø³ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø¨Ø²Ø±Ú¯Ø³Ø§Ù„Ø§Ù†
        classic_models = ["Ø³Ø§Ø¯Ù‡ Ú©Ù„Ø§Ø³ÛŒÚ©", "Ú©Ù…Ø¨â€ŒØ§ÙˆÙØ±", "Ø³Ø§ÛŒØ¯ Ù¾Ø§Ø±Øª Ø³Ø§Ø¯Ù‡", "Ø³Ù„ÛŒÚ©â€ŒØ¨Ú© Ø³Ø§Ø¯Ù‡"]
        if model in classic_models:
            score += age_mod.get("classic_bonus", 1.0) * 3
            score += age_mod.get("conservative_penalty", 0) * -2
        
        # Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ø¯Ø±Ù† Ø¨Ø±Ø§ÛŒ Ø¬ÙˆØ§Ù†â€ŒÙ‡Ø§
        modern_models = ["Ø¢Ù†Ø¯Ø±Ú©Ø§Øª", "Ù¾ÙˆÙ…Ù¾Ø§Ø¯ÙˆØ±", "ÙÛŒØ¯", "ØªÚ©Ø³Ú†Ø± Ú©ÙˆØªØ§Ù‡", "Ù‡Ø§ÛŒâ€ŒØ§Ù†Ø¯Øª"]
        if model in modern_models:
            score *= age_mod.get("modern_bonus", 1.0)
        
        # Ø§Ù…ØªÛŒØ§Ø² Ù¾Ø§ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡
        score += 3 * 0.1  # ÙˆØ²Ù† Ú©ÙˆÚ†Ú© Ø¨Ø±Ø§ÛŒ Ù¾ÙˆØ´Ø´ Ø¹Ù…ÙˆÙ…ÛŒ
        
        return score
    
    def calculate_beard_model_score(self, model: str, data: Dict[str, Any]) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ÛŒ ÛŒÚ© Ù…Ø¯Ù„ Ø±ÛŒØ´"""
        score = 0.0
        
        # Ø§Ù…ØªÛŒØ§Ø² Ø§Ø² ÙØ±Ù… ØµÙˆØ±Øª
        face_shape = data.get("face_shape", "Ø¨ÛŒØ¶ÛŒ")
        if model in self.beard_face_match.get(face_shape, []):
            score += 8 * 0.6
        else:
            score += 4 * 0.6
        
        # Ø§Ù…ØªÛŒØ§Ø² Ø§Ø² Ø³Ù†
        age = data.get("age", "30-40")
        if model in self.beard_age_match.get(age, []):
            score += 8 * 0.4
        else:
            score += 3 * 0.4
        
        # Ø±ÛŒØ´ Ù¾Ø±ÙˆÙØ³ÙˆØ±ÛŒ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ 40+
        if model == "Ø±ÛŒØ´ Ù¾Ø±ÙˆÙØ³ÙˆØ±ÛŒ Ú©Ù„Ø§Ø³ÛŒÚ©":
            if "40-50" in age or "50-60" in age or "+60" in age:
                score += 5
            else:
                score -= 5
        
        return score
    
    def get_harmonious_beard_color(self, hair_color: str, skin_color: str, age: str, current_beard_color: str) -> str:
        
        # Ø³Ù†Ø§Ø±ÛŒÙˆ 1: Ø±ÛŒØ´ Ø³ÙÛŒØ¯ Ùˆ Ù…Ùˆ Ù…Ø´Ú©ÛŒ (Ø¬ÙˆØ§Ù†â€ŒØ³Ø§Ø²ÛŒ)
        if ("50-60" in age or "+60" in age) and current_beard_color == "Ø³ÙÛŒØ¯":
            # Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÙˆÙ„ÛŒÙ‡ Ø±Ù†Ú¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ
            suggested = hair_color if random.random() < 0.6 else "Ù…Ø´Ú©ÛŒ"

            # Ø­Ø°Ù Ø±Ù†Ú¯ ÙØ¹Ù„ÛŒ Ø±ÛŒØ´ Ø§Ø² Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯
            if suggested == current_beard_color:
                alternatives = [c for c in AVAILABLE_DYE_COLORS if c != current_beard_color]
                suggested = random.choice(alternatives)

        return suggested

        
        # Ø³Ù†Ø§Ø±ÛŒÙˆ 2: Ù…Ùˆ Ø¨Ù„ÙˆÙ†Ø¯ Ùˆ Ù¾ÙˆØ³Øª Ø±ÙˆØ´Ù†
        if "Ø¨Ù„ÙˆÙ†Ø¯" in hair_color and "Ø±ÙˆØ´Ù†" in skin_color:
            # Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÙˆÙ„ÛŒÙ‡ Ø±Ù†Ú¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ
             suggested = "Ø¨ÙˆØ±/ Ø¨Ù„ÙˆÙ†Ø¯" if random.random() < 0.7 else "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ"

            # Ø­Ø°Ù Ø±Ù†Ú¯ ÙØ¹Ù„ÛŒ Ø±ÛŒØ´ Ø§Ø² Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯
             if suggested == current_beard_color:
                alternatives = [c for c in AVAILABLE_DYE_COLORS if c != current_beard_color]
                suggested = random.choice(alternatives)

        return suggested

        
        # Ø³Ù†Ø§Ø±ÛŒÙˆ 3: Ù…Ùˆ Ù…Ø´Ú©ÛŒ Ùˆ Ú†Ø´Ù…/Ø§Ø¨Ø±Ùˆ Ù…Ø´Ú©ÛŒ (Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ú©Ø§Ù…Ù„)
        if hair_color == "Ù…Ø´Ú©ÛŒ":
        # Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÙˆÙ„ÛŒÙ‡ Ø±Ù†Ú¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ
           suggested = "Ù…Ø´Ú©ÛŒ"

        # Ø­Ø°Ù Ø±Ù†Ú¯ ÙØ¹Ù„ÛŒ Ø±ÛŒØ´ Ø§Ø² Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯
           if suggested == current_beard_color:
             alternatives = [c for c in AVAILABLE_DYE_COLORS if c != current_beard_color]
             suggested = random.choice(alternatives)

    # Ø¨Ø±Ú¯Ø´Øª Ø±Ù†Ú¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ
        return suggested

        
        # Ø³Ù†Ø§Ø±ÛŒÙˆ 4: Ù¾ÛŒØ´â€ŒÙØ±Ø¶ - Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø¨Ø§ Ø±Ù†Ú¯ Ù…Ùˆ
        color_map = {
            "Ù…Ø´Ú©ÛŒ": "Ù…Ø´Ú©ÛŒ",
            "Ù‚Ù‡ÙˆÙ‡ Ø§ÛŒ ØªÛŒØ±Ù‡":"Ù‚Ù‡ÙˆÙ‡ Ø§ÛŒ ØªÛŒØ±Ù‡",
            "Ù‚Ù‡ÙˆÙ‡ Ø§ÛŒ Ø±ÙˆØ´Ù†": "Ù‚Ù‡ÙˆÙ‡ Ø§ÛŒ Ø±ÙˆØ´Ù†",
            "Ø¨Ù„ÙˆÙ†Ø¯/Ø¨ÙˆØ±": "Ø¨ÙˆØ±/ Ø¨Ù„ÙˆÙ†Ø¯",
            "Ø®Ø§Ú©Ø³ØªØ±ÛŒ": "Ø³ÙÛŒØ¯",
            "Ø­Ù†Ø§ÛŒÛŒ": "Ù‚Ø±Ù…Ø² Ø­Ù†Ø§ÛŒÛŒ",
            "Ø´ÛŒØ±ÛŒ": "Ø¨ÙˆØ±/ Ø¨Ù„ÙˆÙ†Ø¯"
        }
        suggested = color_map.get(hair_color, "Ù…Ø´Ú©ÛŒ")
        if suggested == current_beard_color:
                alternatives = [c for c in AVAILABLE_DYE_COLORS if c != current_beard_color]
                suggested = random.choice(alternatives)

        
                return suggested
 
# Ù†Ù…ÙˆÙ†Ù‡â€ŒØ§ÛŒ Ø§Ø² Ù…ÙˆØªÙˆØ±
style_engine = PersianStyleEngine()


class PersianFemaleStyleEngine:
    """
    Ù…ÙˆØªÙˆØ± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§ Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆÛŒÚ˜Ù‡ Ø§ÛŒØ±Ø§Ù†
    """
    
    def __init__(self):
        # ÙˆØ²Ù†â€ŒØ¯Ù‡ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ù‡ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§ (Ø¬Ù…Ø¹ Ú©Ù„ = 1.0)
        # ØªÙ…Ø±Ú©Ø² Ø¨ÛŒØ´ØªØ± Ø±ÙˆÛŒ ÙØ±Ù… ØµÙˆØ±ØªØŒ Ø¬Ù†Ø³ Ù…ÙˆØŒ Ø±Ù†Ú¯ Ù¾ÙˆØ³Øª Ùˆ Ø³Ù†
        self.weights_female = {
            'face_shape': 0.30,      # Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ù…Ø¯Ù„ Ù…Ùˆ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§
            'hair_type': 0.25,       # ØªØ¹ÛŒÛŒÙ†â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¯Ù„ Ù…Ùˆ
            'skin_color': 0.20,      # Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø±Ù†Ú¯ Ù…Ùˆ
            'age': 0.15,             # Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø³Ù†ÛŒ Ùˆ Ø³Ø¨Ú©
            'face_condition': 0.05,  # ÙˆØ¶Ø¹ÛŒØª ØµÙˆØ±Øª (Ù„Ø§ØºØ±/Ú†Ø§Ù‚)
            'eye_color': 0.03,       # Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø±Ù†Ú¯ÛŒ
            'eyebrow_color': 0.02,   # Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø±Ù†Ú¯ÛŒ
        }
        
        # Ù‚ÙˆØ§Ù†ÛŒÙ† Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø±Ù†Ú¯ Ù…Ùˆ Ø¨Ø§ Ù¾ÙˆØ³Øª Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§ (Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ± Ø¯Ø± Ø§ÛŒØ±Ø§Ù†)
        self.color_harmony_female = {
            "Ø±ÙˆØ´Ù† ğŸŒ": {
                "Ù…Ø´Ú©ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ": 9, "Ù…Ø´Ú©ÛŒ Ø¢Ø¨ÛŒ": 8, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø´Ú©Ù„Ø§ØªÛŒ": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ù†Ø³Ú©Ø§ÙÙ‡â€ŒØ§ÛŒ": 10,
                "Ø¨Ù„ÙˆÙ†Ø¯ Ø·Ù„Ø§ÛŒÛŒ": 10, "Ø¨Ù„ÙˆÙ†Ø¯ Ú©Ø±Ù‡â€ŒØ§ÛŒ (Butter Blonde)": 9, "Ø¨Ù„ÙˆÙ†Ø¯ Ø±ÙˆØ´Ù†": 8,
                "Ø±Ø²Ú¯Ù„Ø¯": 9, "ØµÙˆØ±ØªÛŒ Ù¾Ø§Ø³ØªÙ„ÛŒ": 8, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ú©Ø§Ø±Ø§Ù…Ù„ÛŒ": 10,
                "Ø³ÙÛŒØ¯ Ù¾Ù„Ø§ØªÛŒÙ†Ù‡": 7, "Ø¢Ø¨ÛŒ Ø®Ø§Ú©Ø³ØªØ±ÛŒ": 6
            },
            "Ø³Ø¨Ø²Ù‡ ğŸŒ": {
                "Ù…Ø´Ú©ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ": 10, "Ù…Ø´Ú©ÛŒ Ø¢Ø¨ÛŒ": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø´Ú©Ù„Ø§ØªÛŒ": 10,
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ù†Ø³Ú©Ø§ÙÙ‡â€ŒØ§ÛŒ": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¯ÙˆØ¯ÛŒ": 8, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¹Ø³Ù„ÛŒ": 9,
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ÙÙ†Ø¯Ù‚ÛŒ": 8, "Ø¨Ù„ÙˆÙ†Ø¯ ØªÛŒØ±Ù‡": 7, "Ø¨Ù„ÙˆÙ†Ø¯ Ù…ØªÙˆØ³Ø·": 6,
                "Ù‚Ø±Ù…Ø² Ø·Ø¨ÛŒØ¹ÛŒ": 7, "Ù‚Ø±Ù…Ø² ØªÛŒØ±Ù‡": 8, "Ø´Ø±Ø§Ø¨ÛŒ": 9, "Ø¢Ù„Ø¨Ø§Ù„ÙˆÛŒÛŒ": 8,
                "Ù…Ø³ÛŒ": 9, "Ù…Ø³ÛŒ Ø·Ù„Ø§ÛŒÛŒ": 8, "Ø¨Ù†ÙØ´ Ø§Ø³Ø·ÙˆØ®ÙˆØ¯ÙˆØ³ÛŒ": 7
            },
            "Ú¯Ù†Ø¯Ù…ÛŒ ğŸŒ": {
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø´Ú©Ù„Ø§ØªÛŒ": 10, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ù†Ø³Ú©Ø§ÙÙ‡â€ŒØ§ÛŒ": 9,
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ù…ØªÙˆØ³Ø·": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 8, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ú©Ø§Ø±Ø§Ù…Ù„ÛŒ": 9,
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø·Ù„Ø§ÛŒÛŒ": 8, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¯ÙˆØ¯ÛŒ": 7, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¹Ø³Ù„ÛŒ": 9,
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ÙÙ†Ø¯Ù‚ÛŒ": 8, "Ø¨Ù„ÙˆÙ†Ø¯ ØªÛŒØ±Ù‡": 8, "Ø¨Ù„ÙˆÙ†Ø¯ Ù…ØªÙˆØ³Ø·": 7,
                "Ø¨Ù„ÙˆÙ†Ø¯ Ø·Ù„Ø§ÛŒÛŒ": 8, "Ø¨Ù„ÙˆÙ†Ø¯ Ø¹Ø³Ù„ÛŒ": 9, "Ù‚Ø±Ù…Ø² Ø·Ø¨ÛŒØ¹ÛŒ": 8,
                "Ù‚Ø±Ù…Ø² ØªÛŒØ±Ù‡": 9, "Ø´Ø±Ø§Ø¨ÛŒ": 10, "Ø¢Ù„Ø¨Ø§Ù„ÙˆÛŒÛŒ": 9, "Ù…Ø³ÛŒ": 10,
                "Ù…Ø³ÛŒ Ø·Ù„Ø§ÛŒÛŒ": 9, "Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ": 6
            },
            "Ø¨Ø±Ù†Ø²Ù‡ ğŸŒ": {
                "Ù…Ø´Ú©ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ": 10, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø´Ú©Ù„Ø§ØªÛŒ": 9,
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ù†Ø³Ú©Ø§ÙÙ‡â€ŒØ§ÛŒ": 8, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ù…ØªÙˆØ³Ø·": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 7,
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ú©Ø§Ø±Ø§Ù…Ù„ÛŒ": 8, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø·Ù„Ø§ÛŒÛŒ": 7, "Ø¨Ù„ÙˆÙ†Ø¯ ØªÛŒØ±Ù‡": 6,
                "Ù‚Ø±Ù…Ø² Ø·Ø¨ÛŒØ¹ÛŒ": 9, "Ù‚Ø±Ù…Ø² ØªÛŒØ±Ù‡": 10, "Ø´Ø±Ø§Ø¨ÛŒ": 9, "Ø¢Ù„Ø¨Ø§Ù„ÙˆÛŒÛŒ": 10,
                "Ù…Ø³ÛŒ": 9, "Ù…Ø³ÛŒ Ù‚Ø±Ù…Ø²Ø±Ù†Ú¯ (Copper Red)": 10, "Ø¨Ù†ÙØ´ ØªÛŒØ±Ù‡ (Violet)": 8
            },
            "ØªÛŒØ±Ù‡ ğŸŒ": {
                "Ù…Ø´Ú©ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ": 10, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø´Ú©Ù„Ø§ØªÛŒ": 8,
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ù†Ø³Ú©Ø§ÙÙ‡â€ŒØ§ÛŒ": 7, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ù…ØªÙˆØ³Ø·": 8, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 5,
                "Ù‚Ø±Ù…Ø² Ø·Ø¨ÛŒØ¹ÛŒ": 8, "Ù‚Ø±Ù…Ø² ØªÛŒØ±Ù‡": 9, "Ø´Ø±Ø§Ø¨ÛŒ": 8, "Ø¢Ù„Ø¨Ø§Ù„ÙˆÛŒÛŒ": 9,
                "Ù…Ø³ÛŒ": 8, "Ù…Ø³ÛŒ Ù‚Ø±Ù…Ø²Ø±Ù†Ú¯ (Copper Red)": 9, "Ø¨Ù†ÙØ´ ØªÛŒØ±Ù‡ (Violet)": 9
            },
            "Ø³Ø±Ø® ğŸŒ": {
                "Ù…Ø´Ú©ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 7, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø´Ú©Ù„Ø§ØªÛŒ": 8,
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¯ÙˆØ¯ÛŒ": 9, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¹Ø³Ù„ÛŒ": 8, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ÙÙ†Ø¯Ù‚ÛŒ": 7,
                "Ø¨Ù„ÙˆÙ†Ø¯ Ù…ØªÙˆØ³Ø·": 6, "Ø¨Ù„ÙˆÙ†Ø¯ Ø¹Ø³Ù„ÛŒ": 7, "Ù‚Ø±Ù…Ø² Ø·Ø¨ÛŒØ¹ÛŒ": 9,
                "Ù‚Ø±Ù…Ø² ØªÛŒØ±Ù‡": 10, "Ø´Ø±Ø§Ø¨ÛŒ": 9, "Ø¢Ù„Ø¨Ø§Ù„ÙˆÛŒÛŒ": 8,
                "Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ": 8, "Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 7
            }
        }
        
        # ÙØ±Ù… ØµÙˆØ±Øª -> Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡ Ø³Ø§Ø²Ú¯Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§
        self.face_shape_perfect_match_female = {
            "Ø¨ÛŒØ¶ÛŒ": [
                "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ù…ØªÙˆØ³Ø·", "Ù…ÙˆØ¬ Ø·Ø¨ÛŒØ¹ÛŒ Ù…ØªÙˆØ³Ø·", "ØµØ§Ù Ù…ØªÙˆØ³Ø· Ú©Ù„Ø§Ø³ÛŒÚ©",
                "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ø¨Ù„Ù†Ø¯ V-Cut / Butterfly Cut", "ØµØ§Ù Ø·Ø¨ÛŒØ¹ÛŒ Ø¨Ù„Ù†Ø¯",
                "Ø´ÛŒÙ†ÛŒÙˆÙ† Ù†ÛŒÙ…Ù‡ Ø¨Ø§Ø²", "Ø´ÛŒÙ†ÛŒÙˆÙ† Ù¾Ø§ÛŒÛŒÙ† Ú¯Ø±Ø¯Ù† Ø³Ø§Ø¯Ù‡", "Ø¨Ø§ÙØª ÙØ±Ø§Ù†Ø³ÙˆÛŒ Ú©Ù„Ø§Ø³ÛŒÚ©"
            ],
            "Ú¯ÙØ±Ø¯": [
                "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ù…ØªÙˆØ³Ø·", "Ù¾ÛŒÚ©Ø³ÛŒ Ø¨Ù„Ù†Ø¯ Ù†Ø§Ù…ØªÙ‚Ø§Ø±Ù† ÙØ§Ù†ØªØ²ÛŒ", "Ù…Ø¯Ù„ Ù‚Ø§Ø±Ú†ÛŒ Ú©ÙˆØªØ§Ù‡",
                "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ø¨Ù„Ù†Ø¯ V-Cut / Butterfly Cut", "Ø±ÛŒØ´â€ŒØ±ÛŒØ´ Ø¨Ù„Ù†Ø¯",
                "Ø´ÛŒÙ†ÛŒÙˆÙ† Ù†ÛŒÙ…Ù‡ Ø¨Ø§Ø²", "ÙˆÙÙ„Ùâ€ŒÚ©Ø§Øª", "Ú†ØªØ±ÛŒ ÛŒÚ©â€ŒØ·Ø±ÙÙ‡ Ø­Ø¬ÛŒÙ…"
            ],
            "Ù…Ø³ØªØ·ÛŒÙ„": [
                "Ù…ÙˆØ¬ Ø·Ø¨ÛŒØ¹ÛŒ Ù…ØªÙˆØ³Ø·", "ØµØ§Ù Ù…ØªÙˆØ³Ø· Ú©Ù„Ø§Ø³ÛŒÚ©", "Ù…Ø¯Ù„ Ú©Ø±Ù‡â€ŒØ§ÛŒ Ù…ØªÙˆØ³Ø·",
                "Ù…ÙˆØ¬ Ø³Ø§Ø­Ù„ÛŒ / ÙØ± Ø¨Ø§Ø²", "ÙØ± Ø¨Ø§Ø² Ø¨Ù„Ù†Ø¯", "Ø´ÛŒÙ†ÛŒÙˆÙ† ÙØ±Ø§Ù†Ø³ÙˆÛŒ Ú¯ÙˆØ¬Ù‡â€ŒØ§ÛŒ",
                "Ø¨Ø§ÙØª Ù‡Ù„Ù†Ø¯ÛŒ / ØªØ§Ø¬ÛŒ", "Ú†ØªØ±ÛŒ Ù¾Ø±Ø¯Ù‡â€ŒØ§ÛŒ Ù…ØªÙˆØ³Ø·-Ø¨Ù„Ù†Ø¯"
            ],
            "Ù‚Ù„Ø¨ÛŒ": [
                "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ù…ØªÙˆØ³Ø·", "Ù…ÙˆØ¬ Ø·Ø¨ÛŒØ¹ÛŒ Ù…ØªÙˆØ³Ø·", "ØµØ§Ù Ù…ØªÙˆØ³Ø· Ú©Ù„Ø§Ø³ÛŒÚ©",
                "Ù¾ÛŒÚ©Ø³ÛŒ Ø¨Ù„Ù†Ø¯ Ù†Ø§Ù…ØªÙ‚Ø§Ø±Ù† ÙØ§Ù†ØªØ²ÛŒ", "Ù…Ø¯Ù„ Ù…ØªÙˆØ³Ø· Ø¨Ø§ Ú†ØªØ±ÛŒ Ù¾Ø±Ø¯Ù‡â€ŒØ§ÛŒ",
                "Ø´ÛŒÙ†ÛŒÙˆÙ† Ù†ÛŒÙ…Ù‡ Ø¨Ø§Ø²", "Ø¨Ø§ÙØª ÙØ±Ø§Ù†Ø³ÙˆÛŒ Ú©Ù„Ø§Ø³ÛŒÚ©", "Ú†ØªØ±ÛŒ Ù¾Ø±Ø¯Ù‡â€ŒØ§ÛŒ Ù…ØªÙˆØ³Ø·-Ø¨Ù„Ù†Ø¯"
            ],
            "Ù…Ø«Ù„Ø«ÛŒ": [
                "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ù…ØªÙˆØ³Ø·", "Ù¾ÛŒÚ©Ø³ÛŒ Ø¨Ù„Ù†Ø¯ Ù†Ø§Ù…ØªÙ‚Ø§Ø±Ù† ÙØ§Ù†ØªØ²ÛŒ", "Ù…Ø¯Ù„ Ù‚Ø§Ø±Ú†ÛŒ Ú©ÙˆØªØ§Ù‡",
                "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ø¨Ù„Ù†Ø¯ V-Cut / Butterfly Cut", "Ø¯Ù…â€ŒØ§Ø³Ø¨ÛŒ Ø¨Ù„Ù†Ø¯ Ø¨Ø§ Ù„Ø§ÛŒÙ‡",
                "ØªØ§Ù¾â€ŒÙ†Ø§Øª", "Ø¨Ø§ÙØª Ù…Ø§Ù‡ÛŒ", "Ú†ØªØ±ÛŒ ÛŒÚ©â€ŒØ·Ø±ÙÙ‡ Ø­Ø¬ÛŒÙ…"
            ],
            "Ù…Ø±Ø¨Ø¹ÛŒ": [
                "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ù…ØªÙˆØ³Ø·", "Ù…ÙˆØ¬ Ø·Ø¨ÛŒØ¹ÛŒ Ù…ØªÙˆØ³Ø·", "ØµØ§Ù Ù…ØªÙˆØ³Ø· Ú©Ù„Ø§Ø³ÛŒÚ©",
                "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ø¨Ù„Ù†Ø¯ V-Cut / Butterfly Cut", "Ù…ÙˆØ¬ Ø³Ø§Ø­Ù„ÛŒ / ÙØ± Ø¨Ø§Ø²",
                "Ø´ÛŒÙ†ÛŒÙˆÙ† Ú©Ù„Ø§Ø³ÛŒÚ© Ø¨Ø§ Ø¨Ø§ÙØª Ø¨Ø§Ø²", "Ø¨Ø§ÙØª ØªØ±Ú©ÛŒØ¨ÛŒ Ø¨Ø§ Ø´ÛŒÙ†ÛŒÙˆÙ†", "ÙˆÛŒÙˆ ÛŒØ®ÛŒ / Ù…ÙˆØ¬ ÙØ§Ù†ØªØ²ÛŒ"
            ],
            "Ø§Ù„Ù…Ø§Ø³ÛŒ": [
                "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ù…ØªÙˆØ³Ø·", "Ù¾ÛŒÚ©Ø³ÛŒ Ø¨Ù„Ù†Ø¯ Ù†Ø§Ù…ØªÙ‚Ø§Ø±Ù† ÙØ§Ù†ØªØ²ÛŒ", "Ù…Ø¯Ù„ Ú©Ø±Ù‡â€ŒØ§ÛŒ Ù…ØªÙˆØ³Ø·",
                "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ø¨Ù„Ù†Ø¯ V-Cut / Butterfly Cut", "ØµØ§Ù Ø·Ø¨ÛŒØ¹ÛŒ Ø¨Ù„Ù†Ø¯",
                "Ø´ÛŒÙ†ÛŒÙˆÙ† Ù†ÛŒÙ…Ù‡ Ø¨Ø§Ø²", "Ø¨Ø§ÙØª ÙØ±Ø§Ù†Ø³ÙˆÛŒ Ú©Ù„Ø§Ø³ÛŒÚ©", "Ú†ØªØ±ÛŒ Ù¾Ø±Ø¯Ù‡â€ŒØ§ÛŒ Ù…ØªÙˆØ³Ø·-Ø¨Ù„Ù†Ø¯"
            ]
        }
        
        # Ø¬Ù†Ø³ Ù…Ùˆ -> Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ ØºÛŒØ±Ù…Ù…Ú©Ù†/Ù†Ø§Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§
        self.hair_type_exclusions_female = {
            "ØµØ§Ù ğŸ’‡": [
                "ÙØ± Ø¨Ø§Ø² Ø¨Ù„Ù†Ø¯", "Ù…ÙˆØ¬ Ø³Ø§Ø­Ù„ÛŒ / ÙØ± Ø¨Ø§Ø²", "ÙˆÛŒÙˆ ÛŒØ®ÛŒ / Ù…ÙˆØ¬ ÙØ§Ù†ØªØ²ÛŒ",
                "Ø±ÛŒØ´â€ŒØ±ÛŒØ´ Ø¨Ù„Ù†Ø¯"
            ],
            "Ù…ÙˆØ¬â€ŒØ¯Ø§Ø± ğŸ’‡": [
                "ØµØ§Ù Ù…ØªÙˆØ³Ø· Ú©Ù„Ø§Ø³ÛŒÚ©", "ØµØ§Ù Ø·Ø¨ÛŒØ¹ÛŒ Ø¨Ù„Ù†Ø¯", "Ø¨Ù„Ø§Ù†Øª Ø¨Ù„Ù†Ø¯", "Ø´ÛŒÙ†ÛŒÙˆÙ† ÙØ±Ø§Ù†Ø³ÙˆÛŒ Ú¯ÙˆØ¬Ù‡â€ŒØ§ÛŒ"
            ],
            "ÙØ± ğŸ’‡": [
                "ØµØ§Ù Ù…ØªÙˆØ³Ø· Ú©Ù„Ø§Ø³ÛŒÚ©", "ØµØ§Ù Ø·Ø¨ÛŒØ¹ÛŒ Ø¨Ù„Ù†Ø¯", "Ø¨Ù„Ø§Ù†Øª Ø¨Ù„Ù†Ø¯", "Ù…ÙˆØ¬ Ø·Ø¨ÛŒØ¹ÛŒ Ù…ØªÙˆØ³Ø·"
            ],
            "ÙˆØ² ğŸ’‡": [
                "ØµØ§Ù Ù…ØªÙˆØ³Ø· Ú©Ù„Ø§Ø³ÛŒÚ©", "ØµØ§Ù Ø·Ø¨ÛŒØ¹ÛŒ Ø¨Ù„Ù†Ø¯", "Ø¨Ù„Ø§Ù†Øª Ø¨Ù„Ù†Ø¯", "Ù…ÙˆØ¬ Ø³Ø§Ø­Ù„ÛŒ / ÙØ± Ø¨Ø§Ø²"
            ]
        }
        
        # Ù‚ÙˆØ§Ù†ÛŒÙ† Ø³Ù†â€ŒÙ…Ø­ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§
        self.age_constraints_female = {
            "ØªØ§ 20": {
                "modern_bonus": 1.4, "bold_styles": 1.3, "classic_penalty": -1.5,
                "long_hair_bonus": 1.2, "short_hair_bonus": 1.1, "fancy_bonus": 1.5
            },
            "20-30": {
                "modern_bonus": 1.3, "bold_styles": 1.2, "classic_penalty": -1.0,
                "long_hair_bonus": 1.1, "short_hair_bonus": 1.0, "fancy_bonus": 1.3
            },
            "30-40": {
                "modern_bonus": 1.0, "bold_styles": 1.0, "classic_penalty": 0,
                "long_hair_bonus": 1.0, "short_hair_bonus": 1.0, "fancy_bonus": 1.0
            },
            "40-50": {
                "conservative_bonus": 1.3, "classic_bonus": 1.2, "modern_penalty": -1.0,
                "long_hair_bonus": 1.2, "short_hair_bonus": 1.1, "fancy_penalty": -1.5
            },
            "50-60": {
                "conservative_bonus": 1.5, "classic_bonus": 1.4, "modern_penalty": -2.0,
                "long_hair_bonus": 1.1, "short_hair_bonus": 1.3, "fancy_penalty": -2.0
            },
            "+60": {
                "conservative_bonus": 1.4, "classic_bonus": 1.3, "modern_penalty": -3.0,
                "long_hair_bonus": 1.0, "short_hair_bonus": 1.4, "fancy_penalty": -3.0
            }
        }
        
        # Ø±Ù†Ú¯ Ú†Ø´Ù… -> Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…Ú©Ù…Ù„ Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§
        self.eye_color_complements_female = {
            "Ù…Ø´Ú©ÛŒ ğŸ‘": {"Ù…Ø´Ú©ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ": 2, "Ù…Ø´Ú©ÛŒ Ø¢Ø¨ÛŒ": 1, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 1},
            "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ğŸ‘": {
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø´Ú©Ù„Ø§ØªÛŒ": 3, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ù†Ø³Ú©Ø§ÙÙ‡â€ŒØ§ÛŒ": 2, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¹Ø³Ù„ÛŒ": 2,
                "Ø¨Ù„ÙˆÙ†Ø¯ Ø·Ù„Ø§ÛŒÛŒ": 1, "Ø¨Ù„ÙˆÙ†Ø¯ Ú©Ø±Ù‡â€ŒØ§ÛŒ (Butter Blonde)": 1,
                "Ø´Ø±Ø§Ø¨ÛŒ": 1, "Ø¢Ù„Ø¨Ø§Ù„ÙˆÛŒÛŒ": 1, "Ù…Ø³ÛŒ": 2
            },
            "Ø¢Ø¨ÛŒ ğŸ‘": {
                "Ù…Ø´Ú©ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ": 3, "Ù…Ø´Ú©ÛŒ Ø¢Ø¨ÛŒ": 3, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 2,
                "Ø¨Ù„ÙˆÙ†Ø¯ Ø·Ù„Ø§ÛŒÛŒ": 2, "Ø¨Ù„ÙˆÙ†Ø¯ Ø±ÙˆØ´Ù†": 2, "Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ": 2
            },
            "Ø³Ø¨Ø² ğŸ‘": {
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¹Ø³Ù„ÛŒ": 2, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ÙÙ†Ø¯Ù‚ÛŒ": 2, "Ø¨Ù„ÙˆÙ†Ø¯ Ø¹Ø³Ù„ÛŒ": 2,
                "Ø´Ø±Ø§Ø¨ÛŒ": 3, "Ø¢Ù„Ø¨Ø§Ù„ÙˆÛŒÛŒ": 2, "Ù…Ø³ÛŒ": 3, "Ù…Ø³ÛŒ Ø·Ù„Ø§ÛŒÛŒ": 3
            },
            "Ø®Ø§Ú©Ø³ØªØ±ÛŒ ğŸ‘": {
                "Ù…Ø´Ú©ÛŒ Ø¢Ø¨ÛŒ": 2, "Ø¨Ù„ÙˆÙ†Ø¯ Ø®Ø§Ú©Ø³ØªØ±ÛŒ": 2, "Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ": 3,
                "Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 2, "Ø¢Ø¨ÛŒ Ø®Ø§Ú©Ø³ØªØ±ÛŒ": 2, "Ø¨Ù†ÙØ´ Ø§Ø³Ø·ÙˆØ®ÙˆØ¯ÙˆØ³ÛŒ": 1
            },
            "Ø¹Ø³Ù„ÛŒ ğŸ‘": {
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¹Ø³Ù„ÛŒ": 3, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ÙÙ†Ø¯Ù‚ÛŒ": 2, "Ø¨Ù„ÙˆÙ†Ø¯ Ø¹Ø³Ù„ÛŒ": 3,
                "Ù…Ø³ÛŒ": 2, "Ù…Ø³ÛŒ Ø·Ù„Ø§ÛŒÛŒ": 2, "Ø´Ø±Ø§Ø¨ÛŒ": 2, "Ø¢Ù„Ø¨Ø§Ù„ÙˆÛŒÛŒ": 2
            }
        }
        
        # Ø±Ù†Ú¯ Ø§Ø¨Ø±Ùˆ -> Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…Ú©Ù…Ù„ Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§
        self.eyebrow_color_complements_female = {
            "Ù…Ø´Ú©ÛŒ": {"Ù…Ø´Ú©ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ": 3, "Ù…Ø´Ú©ÛŒ Ø¢Ø¨ÛŒ": 2, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡": 1},
            "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ": {
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø´Ú©Ù„Ø§ØªÛŒ": 2, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ù†Ø³Ú©Ø§ÙÙ‡â€ŒØ§ÛŒ": 2, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¹Ø³Ù„ÛŒ": 2,
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 2, "Ø´Ø±Ø§Ø¨ÛŒ": 1, "Ø¢Ù„Ø¨Ø§Ù„ÙˆÛŒÛŒ": 1, "Ù…Ø³ÛŒ": 1
            },
            "Ø¬ÙˆÚ¯Ù†Ø¯ÙˆÙ…ÛŒ": {
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¯ÙˆØ¯ÙŠ": 2, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ÙÙ†Ø¯Ù‚ÛŒ": 2, "Ø¨Ù„ÙˆÙ†Ø¯ Ø¹Ø³Ù„ÛŒ": 2,
                "Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ": 1, "Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 1
            },
            "Ø¨Ù„ÙˆÙ†Ø¯": {
                "Ø¨Ù„ÙˆÙ†Ø¯ Ø·Ù„Ø§ÛŒÛŒ": 3, "Ø¨Ù„ÙˆÙ†Ø¯ Ø±ÙˆØ´Ù†": 2, "Ø¨Ù„ÙˆÙ†Ø¯ Ø¹Ø³Ù„ÛŒ": 2,
                "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 1, "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ú©Ø§Ø±Ø§Ù…Ù„ÛŒ": 1, "Ø³ÙÛŒØ¯ Ù¾Ù„Ø§ØªÛŒÙ†Ù‡": 2,
                "Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ": 2
            },
            "Ù‚Ø±Ù…Ø² Ø­Ù†Ø§ÛŒÛŒ": {
                "Ù‚Ø±Ù…Ø² Ø·Ø¨ÛŒØ¹ÛŒ": 2, "Ù‚Ø±Ù…Ø² ØªÛŒØ±Ù‡": 2, "Ø´Ø±Ø§Ø¨ÛŒ": 3, "Ø¢Ù„Ø¨Ø§Ù„ÙˆÛŒÛŒ": 2,
                "Ù…Ø³ÛŒ": 3, "Ù…Ø³ÛŒ Ø·Ù„Ø§ÛŒÛŒ": 3, "Ù…Ø³ÛŒ Ù‚Ø±Ù…Ø²Ø±Ù†Ú¯ (Copper Red)": 2
            },
            "Ø³ÙÛŒØ¯": {
                "Ø³ÙÛŒØ¯ Ù¾Ù„Ø§ØªÛŒÙ†Ù‡": 3, "Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ": 2, "Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†": 2,
                "Ù…Ø´Ú©ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ": 1, "Ø¨Ù„ÙˆÙ†Ø¯ Ø±ÙˆØ´Ù†": 1
            }
        }
        
        # ÙˆØ¶Ø¹ÛŒØª ØµÙˆØ±Øª -> ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø¯Ù„ Ù…Ùˆ
        self.face_condition_adjustments = {
            "Ù„Ø§ØºØ±": {"add_volume": True, "avoid_short": False, "bonus": 2},
            "Ú†Ø§Ù‚": {"add_length": True, "avoid_volume": True, "bonus": 2},
            "Ù…Ø¹Ù…ÙˆÙ„ÛŒ": {"balanced": True, "bonus": 0}
        }
    
    def calculate_color_score_female(self, color: str, data: Dict[str, Any]) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ÛŒ ÛŒÚ© Ø±Ù†Ú¯ Ù…Ùˆ Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§"""
        score = 0.0
        
        # Ù¾Ø§ÛŒÙ‡: Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ Ø±Ù†Ú¯ Ù¾ÙˆØ³Øª (Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† ÙØ§Ú©ØªÙˆØ±)
        skin_color = data.get("skin_color", "Ú¯Ù†Ø¯Ù…ÛŒ ğŸŒ")
        base_score = self.color_harmony_female.get(skin_color, {}).get(color, 5)
        score += base_score * self.weights_female['skin_color']
        
        # Ø¨ÙˆÙ†ÙˆØ³: Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ Ø±Ù†Ú¯ Ú†Ø´Ù…
        eye_color = data.get("eye_color", "")
        eye_bonus = self.eye_color_complements_female.get(eye_color, {}).get(color, 0)
        score += eye_bonus * self.weights_female['eye_color']
        
        # Ø¨ÙˆÙ†ÙˆØ³: Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ Ø±Ù†Ú¯ Ø§Ø¨Ø±Ùˆ
        eyebrow_color = data.get("eyebrow_color", "")
        eyebrow_bonus = self.eyebrow_color_complements_female.get(eyebrow_color, {}).get(color, 0)
        score += eyebrow_bonus * self.weights_female['eyebrow_color']
        
        # ØªÙ†Ø¸ÛŒÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ù†
        age = data.get("age", "30-40")
        age_mod = self.age_constraints_female.get(age, {})
        
        # Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø¬Ø³ÙˆØ±Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø¬ÙˆØ§Ù†â€ŒÙ‡Ø§ (Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ ÙØ§Ù†ØªØ²ÛŒ)
        fancy_colors = [
            "Ø±Ø²Ú¯Ù„Ø¯", "ØµÙˆØ±ØªÛŒ Ù¾Ø§Ø³ØªÙ„ÛŒ", "ØµÙˆØ±ØªÛŒ Ù¾Ø±Ø±Ù†Ú¯", "Ø¨Ù†ÙØ´ Ø§Ø³Ø·ÙˆØ®ÙˆØ¯ÙˆØ³ÛŒ", "Ø¨Ù†ÙØ´ ØªÛŒØ±Ù‡ (Violet)",
            "Ø¢Ø¨ÛŒ ØªÛŒØ±Ù‡ (Navy Blue)", "Ø¢Ø¨ÛŒ Ø®Ø§Ú©Ø³ØªØ±ÛŒ", "Ø³Ø¨Ø² Ø²ÛŒØªÙˆÙ†ÛŒ", "Ø³Ø¨Ø² Ø²Ù…Ø±Ø¯ÛŒ", "Ø³ÙÛŒØ¯ Ù¾Ù„Ø§ØªÛŒÙ†Ù‡", "Ø¨Ú˜ Ø±ÙˆØ´Ù†"
        ]
        if color in fancy_colors:
            if "ØªØ§ 20" in age or "20-30" in age:
                score *= age_mod.get("fancy_bonus", 1.0)  # ØªÙ‚ÙˆÛŒØª Ø¨Ø±Ø§ÛŒ Ø¬ÙˆØ§Ù†Ø§Ù†
            else:
                score *= age_mod.get("fancy_penalty", 1.0)  # Ø¬Ø±ÛŒÙ…Ù‡ Ø¨Ø±Ø§ÛŒ Ù…ÛŒØ§Ù†Ø³Ø§Ù„Ø§Ù†
        
        # Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø§ÙØ¸Ù‡â€ŒÚ©Ø§Ø±Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù…ÛŒØ§Ù†Ø³Ø§Ù„Ø§Ù†
        conservative_colors = ["Ù…Ø´Ú©ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø´Ú©Ù„Ø§ØªÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ù†Ø³Ú©Ø§ÙÙ‡â€ŒØ§ÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¹Ø³Ù„ÛŒ", "Ø¨Ù„ÙˆÙ†Ø¯ Ø·Ù„Ø§ÛŒÛŒ"]
        if color in conservative_colors:
            if "40-50" in age or "50-60" in age or "+60" in age:
                score *= age_mod.get("conservative_bonus", 1.0)
        
        # Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ú©Ù„Ø§Ø³ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ (Ø¨Ù‡â€ŒØ®ØµÙˆØµ Ù…ÛŒØ§Ù†Ø³Ø§Ù„Ø§Ù†)
        classic_colors = ["Ù…Ø´Ú©ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø´Ú©Ù„Ø§ØªÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ù†Ø³Ú©Ø§ÙÙ‡â€ŒØ§ÛŒ", "Ø¨Ù„ÙˆÙ†Ø¯ Ø·Ù„Ø§ÛŒÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¹Ø³Ù„ÛŒ"]
        if color in classic_colors:
            score *= age_mod.get("classic_bonus", 1.0)
        
        return score
    
    def calculate_model_score_female(self, model: str, data: Dict[str, Any]) -> float:
        """Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ÛŒ ÛŒÚ© Ù…Ø¯Ù„ Ù…Ùˆ Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§"""
        score = 0.0
        
        # Ø§Ù…ØªÛŒØ§Ø² Ù¾Ø§ÛŒÙ‡ Ø§Ø² ÙØ±Ù… ØµÙˆØ±Øª (Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† ÙØ§Ú©ØªÙˆØ±)
        face_shape = data.get("face_shape", "Ø¨ÛŒØ¶ÛŒ")
        if model in self.face_shape_perfect_match_female.get(face_shape, []):
            score += 10 * self.weights_female['face_shape']
        else:
            score += 5 * self.weights_female['face_shape']
        
        # Ø§Ù…ØªÛŒØ§Ø² Ø§Ø² Ø¬Ù†Ø³ Ù…Ùˆ (ÙÛŒÙ„ØªØ± ØºÛŒØ±Ù…Ù…Ú©Ù†â€ŒÙ‡Ø§)
        hair_type = data.get("hair_type", "ØµØ§Ù ğŸ’‡")
        if model in self.hair_type_exclusions_female.get(hair_type, []):
            return -1000  # Ù…Ø¯Ù„ ØºÛŒØ±Ù…Ù…Ú©Ù†
        
        # Ø¨ÙˆÙ†ÙˆØ³ Ø§Ø² ÙˆØ¶Ø¹ÛŒØª ØµÙˆØ±Øª (Ù„Ø§ØºØ±/Ú†Ø§Ù‚)
        face_condition = data.get("face_condition", "Ù…Ø¹Ù…ÙˆÙ„ÛŒ")
        face_adj = self.face_condition_adjustments.get(face_condition, {})
        
        if face_condition == "Ù„Ø§ØºØ±":
            if any(word in model for word in ["Ø­Ø¬ÛŒÙ…", "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø±", "Ù…ÙˆØ¬", "ÙØ±", "Ø±ÛŒØ´â€ŒØ±ÛŒØ´", "V-Cut"]):
                score += face_adj.get("bonus", 0) * self.weights_female['face_condition']
        elif face_condition == "Ú†Ø§Ù‚":
            if any(word in model for word in ["ØµØ§Ù", "Ø¨Ù„Ù†Ø¯", "V-Cut", "Sleek", "ØµØ§Ù"]):
                score += face_adj.get("bonus", 0) * self.weights_female['face_condition']
        
        # ØªÙ†Ø¸ÛŒÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ù†
        age = data.get("age", "30-40")
        age_mod = self.age_constraints_female.get(age, {})
        
        # Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ø¯Ø±Ù† Ùˆ ÙØ§Ù†ØªØ²ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬ÙˆØ§Ù†Ø§Ù†
        modern_models = [
            "Ù¾ÛŒÚ©Ø³ÛŒ Ø¨Ù„Ù†Ø¯ Ù†Ø§Ù…ØªÙ‚Ø§Ø±Ù† ÙØ§Ù†ØªØ²ÛŒ", "ÙˆÙÙ„Ùâ€ŒÚ©Ø§Øª", "Ú©Ø±Ù‡â€ŒØ§ÛŒ ÙØ§Ù†ØªØ²ÛŒ",
            "ÙˆÛŒÙˆ ÛŒØ®ÛŒ / Ù…ÙˆØ¬ ÙØ§Ù†ØªØ²ÛŒ", "Ù…ÙˆØ¬ Ø³Ø§Ø­Ù„ÛŒ / ÙØ± Ø¨Ø§Ø²", "Ú†ØªØ±ÛŒ ÛŒÚ©â€ŒØ·Ø±ÙÙ‡ Ø­Ø¬ÛŒÙ…"
        ]
        if model in modern_models:
            score *= age_mod.get("modern_bonus", 1.0)
        
        # Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ú©Ù„Ø§Ø³ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ù…ÛŒØ§Ù†Ø³Ø§Ù„Ø§Ù†
        classic_models = [
            "ØµØ§Ù Ù…ØªÙˆØ³Ø· Ú©Ù„Ø§Ø³ÛŒÚ©", "ØµØ§Ù Ø·Ø¨ÛŒØ¹ÛŒ Ø¨Ù„Ù†Ø¯", "Ø´ÛŒÙ†ÛŒÙˆÙ† ÙØ±Ø§Ù†Ø³ÙˆÛŒ Ú¯ÙˆØ¬Ù‡â€ŒØ§ÛŒ",
            "Ø´ÛŒÙ†ÛŒÙˆÙ† Ù¾Ø§ÛŒÛŒÙ† Ú¯Ø±Ø¯Ù† Ø³Ø§Ø¯Ù‡", "Ø¨Ø§ÙØª ÙØ±Ø§Ù†Ø³ÙˆÛŒ Ú©Ù„Ø§Ø³ÛŒÚ©", "Ø¨Ù„Ø§Ù†Øª Ø¨Ù„Ù†Ø¯"
        ]
        if model in classic_models:
            score *= age_mod.get("classic_bonus", 1.0)
        
        # Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø³Ù†ÛŒÙ† Ø¨Ø§Ù„Ø§ (Ø±Ø§Ø­ØªÛŒ Ùˆ Ø´ÛŒÚ©)
        short_models = [
            "Ù…Ø¯Ù„ Ù‚Ø§Ø±Ú†ÛŒ Ú©ÙˆØªØ§Ù‡", "Ù¾ÛŒÚ©Ø³ÛŒ Ø¨Ù„Ù†Ø¯ Ù†Ø§Ù…ØªÙ‚Ø§Ø±Ù† ÙØ§Ù†ØªØ²ÛŒ", "Ø¨Ø§Ø¨ Ú©Ù„Ø§Ø³ÛŒÚ© Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ø¨Ø§ Ú†ØªØ±ÛŒ"
        ]
        if model in short_models:
            score *= age_mod.get("short_hair_bonus", 1.0)
        
        # Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ù„Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ø¬ÙˆØ§Ù†Ø§Ù†
        long_models = [
            "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ø¨Ù„Ù†Ø¯ V-Cut / Butterfly Cut", "ØµØ§Ù Ø·Ø¨ÛŒØ¹ÛŒ Ø¨Ù„Ù†Ø¯",
            "Ù…ÙˆØ¬ Ø³Ø§Ø­Ù„ÛŒ / ÙØ± Ø¨Ø§Ø²", "ÙØ± Ø¨Ø§Ø² Ø¨Ù„Ù†Ø¯", "Ø±ÛŒØ´â€ŒØ±ÛŒØ´ Ø¨Ù„Ù†Ø¯", "Ø¨Ù„Ø§Ù†Øª Ø¨Ù„Ù†Ø¯"
        ]
        if model in long_models:
            score *= age_mod.get("long_hair_bonus", 1.0)
        
        # Ø§Ù…ØªÛŒØ§Ø² Ù¾Ø§ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ù¾ÙˆØ´Ø´
        score += 3 * 0.1
        
        return score
    
    def generate_suggestions_female(self, data: Dict[str, Any]) -> Tuple[List[str], List[str]]:
        """
        ØªÙˆÙ„ÛŒØ¯ 3 Ù…Ø¯Ù„ Ù…Ùˆ Ùˆ 3 Ø±Ù†Ú¯ Ù…Ùˆ Ø¨Ø±ØªØ± Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§
        """
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ù…Ø¯Ù„ Ù…Ùˆ
        model_scores = []
        for model in female_hair_model_options:
            score = self.calculate_model_score_female(model, data)
            if score > -100:  # ÙÙ‚Ø· Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±
                model_scores.append((model, score))
        
        # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ 3 Ù…Ø¯Ù„ Ø¨Ø±ØªØ±
        model_scores.sort(key=lambda x: x[1], reverse=True)
        top_models = [model for model, score in model_scores[:3]]
        
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ø±Ù†Ú¯ Ù…Ùˆ (ÙÙ‚Ø· Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø®ÙˆØ§Ø³ØªÙ‡ Ø±Ù†Ú¯ Ú©Ù†Ù‡)
        top_colors = []
        if data.get("hair_dye") == "Ø¢Ø±Ù‡ âœ…":
            current_color = data.get("hair_color", "")
            # ÙÛŒÙ„ØªØ± Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ùˆ ØºÛŒØ±ØªÚ©Ø±Ø§Ø±ÛŒ
            available_colors = [c for c in female_hair_colors_all if c != current_color]
            
            color_scores = []
            for color in available_colors:
                score = self.calculate_color_score_female(color, data)
                color_scores.append((color, score))
            
            # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ 3 Ø±Ù†Ú¯ Ø¨Ø±ØªØ±
            color_scores.sort(key=lambda x: x[1], reverse=True)
            top_colors = [color for color, score in color_scores[:3]]
        else:
            top_colors = ["Ø±Ù†Ú¯ Ø·Ø¨ÛŒØ¹ÛŒ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)"]
        
        return top_models, top_colors

# Ù†Ù…ÙˆÙ†Ù‡â€ŒØ§ÛŒ Ø§Ø² Ù…ÙˆØªÙˆØ± Ø²Ù†Ø§Ù†Ù‡
female_style_engine = PersianFemaleStyleEngine()




def get_female_hair_model_help() -> str:
    """Ù…ØªÙ† Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÛŒ Ø²Ù†Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø¨Ø®Ø´ Help.
    Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø³Ø§Ø¯Ù‡ Ùˆ Ø§Ù…Ù† Ø§Ø³ØªØ› Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù…ØªÙ† Ø±Ø§ Ú¯Ø³ØªØ±Ø´ Ø¯Ù‡ÛŒ.
    """
    return (
        "â„¹ï¸ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¬Ø§Ù…Ø¹ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÛŒ Ø²Ù†Ø§Ù†Ù‡:\n\n"
        
        "âœ¨ **Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ú©ÙˆØªØ§Ù‡ (Short)**\n"
        "â€¢ **Ø¨Ø§Ø¨ Ú©Ù„Ø§Ø³ÛŒÚ© Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ø¨Ø§ Ú†ØªØ±ÛŒ** â€” ØªØ§ Ú¯Ø±Ø¯Ù†ØŒ Ú©Ù„Ø§Ø³ÛŒÚ© Ùˆ Ø´ÛŒÚ©ØŒ Ù…Ù†Ø§Ø³Ø¨ ÙØ±Ù… ØµÙˆØ±Øª Ø¨ÛŒØ¶ÛŒ/Ù…Ø±Ø¨Ø¹ÛŒØŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø¢Ø³Ø§Ù†.\n"
        "â€¢ **Ù¾ÛŒÚ©Ø³ÛŒ Ø¨Ù„Ù†Ø¯ Ù†Ø§Ù…ØªÙ‚Ø§Ø±Ù† ÙØ§Ù†ØªØ²ÛŒ** â€” Ø®ÛŒÙ„ÛŒ Ú©ÙˆØªØ§Ù‡ Ø¨Ø§ Ø·ÙˆÙ„ Ù…ØªÙØ§ÙˆØªØŒ Ù…Ø¯Ø±Ù† Ùˆ Ø¬Ø³ÙˆØ±Ø§Ù†Ù‡ØŒ Ù…Ù†Ø§Ø³Ø¨ Ø¬ÙˆØ§Ù†Ø§Ù† Ùˆ ØµÙˆØ±Øª Ú©ÙˆÚ†Ú©.\n"
        "â€¢ **Ù…Ø¯Ù„ Ù‚Ø§Ø±Ú†ÛŒ (Mushroom) Ú©ÙˆØªØ§Ù‡** â€” Ø­Ø¬Ù… Ø¨Ø§Ù„Ø§ Ø¯Ø± ØªØ§Ø¬ØŒ Ø¯Ù…Ù¾Ø§ÛŒÛŒ Ø¯Ø± Ø§Ø·Ø±Ø§ÙØŒ Ø¹Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…ÙˆÙ‡Ø§ÛŒ ÙØ± ÛŒØ§ Ù…ÙˆØ¬â€ŒØ¯Ø§Ø±.\n"
        "â€¢ **ÙˆÙÙ„Ùâ€ŒÚ©Ø§Øª (Wolf Cut)** â€” Ú©ÙˆØªØ§Ù‡ Ø¨Ø§ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø§Ú©Ù†Ø¯Ù‡ØŒ Ø¸Ø§Ù‡Ø± Ø®Ø´Ù† Ùˆ Ø¨Ø§Ø­Ø§Ù„ØŒ Ù…Ù†Ø§Ø³Ø¨ Ù…ÙˆÙ‡Ø§ÛŒ Ù†Ø§Ø²Ú© ØªØ§ Ù…ØªÙˆØ³Ø·.\n"
        "â€¢ **Ú†ØªØ±ÛŒ ØµØ§Ù Ú©Ù„Ø§Ø³ÛŒÚ© Ú©ÙˆØªØ§Ù‡** â€” Ú†ØªØ±ÛŒ ÛŒÚ©â€ŒØ¯Ø³Øª ØªØ§ Ø§Ø¨Ø±ÙˆØŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ø¨Ø§ Ø¨Ø§Ø¨ Ú©ÙˆØªØ§Ù‡ØŒ Ø¸Ø§Ù‡Ø± Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ Ùˆ Ø¬ÙˆØ§Ù†.\n"
        "â€¢ **Ú†ØªØ±ÛŒ ÛŒÚ©â€ŒØ·Ø±ÙÙ‡ Ø­Ø¬ÛŒÙ…** â€” Ú†ØªØ±ÛŒ Ù†Ø§Ù…ØªÙ‚Ø§Ø±Ù† Ø¨Ø§ Ø­Ø¬Ù…ØŒ Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ø¯Ø±Ù† Ùˆ Ù‡Ù†Ø±ÛŒØŒ Ù…Ù†Ø§Ø³Ø¨ ØµÙˆØ±Øªâ€ŒÙ‡Ø§ÛŒ Ú¯Ø±Ø¯.\n\n"
        
        "ğŸ’ **Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…ØªÙˆØ³Ø· (Medium)**\n"
        "â€¢ **Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ù…ØªÙˆØ³Ø·** â€” ØªØ§ Ø´Ø§Ù†Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù…Ù„Ø§ÛŒÙ…ØŒ Ø­Ø¬Ù… Ø¯Ù‡Ù†Ø¯Ù‡ØŒ Ù…Ù†Ø§Ø³Ø¨ Ù‡Ù…Ù‡ ÙØ±Ù…â€ŒÙ‡Ø§ÛŒ ØµÙˆØ±Øª.\n"
        "â€¢ **Ù…ÙˆØ¬ Ø·Ø¨ÛŒØ¹ÛŒ Ù…ØªÙˆØ³Ø·** â€” ØªØ§ Ø´Ø§Ù†Ù‡ Ø¨Ø§ Ù…ÙˆØ¬â€ŒÙ‡Ø§ÛŒ Ù…Ù„Ø§ÛŒÙ…ØŒ Ø¸Ø§Ù‡Ø± Ø·Ø¨ÛŒØ¹ÛŒ Ùˆ Ø±Ù…Ø§Ù†ØªÛŒÚ©ØŒ Ù…Ù†Ø§Ø³Ø¨ Ù…ÙˆÙ‡Ø§ÛŒ Ù†Ø§Ø²Ú©.\n"
        "â€¢ **ØµØ§Ù Ù…ØªÙˆØ³Ø· Ú©Ù„Ø§Ø³ÛŒÚ©** â€” ØªØ§ Ø´Ø§Ù†Ù‡ØŒ ÛŒÚ©â€ŒØ¯Ø³Øª Ùˆ Ù…Ø±ØªØ¨ØŒ Ø§Ø³ØªØ§ÛŒÙ„ Ø±Ø³Ù…ÛŒ Ùˆ Ø§Ø¯Ø§Ø±ÛŒ.\n"
        "â€¢ **Ù…Ø¯Ù„ Ú©Ø±Ù‡â€ŒØ§ÛŒ Ù…ØªÙˆØ³Ø·** â€” ØªØ§ Ø´Ø§Ù†Ù‡ØŒ Ú†ØªØ±ÛŒ Ù…Ù„Ø§ÛŒÙ…ØŒ Ø¸Ø§Ù‡Ø± Ø¬ÙˆØ§Ù†ÛŒ Ùˆ Ø¢Ø±Ø§Ù…ØŒ Ù…Ø­Ø¨ÙˆØ¨ Ø¯Ø± Ù…ÛŒØ§Ù† Ø¯Ø®ØªØ±Ø§Ù† Ø¬ÙˆØ§Ù†.\n"
        "â€¢ **Ù…Ø¯Ù„ Ù…ØªÙˆØ³Ø· Ø¨Ø§ Ú†ØªØ±ÛŒ Ù¾Ø±Ø¯Ù‡â€ŒØ§ÛŒ** â€” Ú†ØªØ±ÛŒ Ø¨Ù„Ù†Ø¯ Ú©Ù†Ø§Ø± ØµÙˆØ±ØªØŒ Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ùˆ Ù…Ù„Ø§ÛŒÙ…ØŒ Ù…Ù†Ø§Ø³Ø¨ ÙØ± Ù‚Ù„Ø¨ÛŒ.\n"
        "â€¢ **ÛŒÙˆ Ø¨Ù„Ù†Ø¯ Ø³Ø§Ø¯Ù‡ (U-Cut)** â€” Ø§Ù†ØªÙ‡Ø§ÛŒ Ø¨Ù‡ Ø´Ú©Ù„ UØŒ Ú©Ù„Ø§Ø³ÛŒÚ© Ùˆ Ø´ÛŒÚ©ØŒ Ù…Ù†Ø§Ø³Ø¨ Ù…ÙˆÙ‡Ø§ÛŒ Ø¨Ù„Ù†Ø¯ ØªØ§ Ù…ØªÙˆØ³Ø·.\n"
        "â€¢ **Ú†ØªØ±ÛŒ Ù¾Ø±Ø¯Ù‡â€ŒØ§ÛŒ Ù…ØªÙˆØ³Ø·-Ø¨Ù„Ù†Ø¯** â€” Ú†ØªØ±ÛŒ Ø¨Ù„Ù†Ø¯ ØªØ§ Ú¯ÙˆÙ†Ù‡â€ŒÙ‡Ø§ØŒ Ø¸Ø§Ù‡Ø± Ø¸Ø±ÛŒÙ Ùˆ Ø²Ù†Ø§Ù†Ù‡ØŒ Ø¹Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ ØµÙˆØ±Øª Ø¨ÛŒØ¶ÛŒ.\n"
        "â€¢ **Ù‡Ø§Ù„ÛŒÙˆÙˆØ¯ÛŒ Ù…ÙˆØ¬â€ŒØ¯Ø§Ø±** â€” Ù…ÙˆØ¬â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ Ùˆ Ø¯Ø±Ø§Ù…Ø§ØªÛŒÚ©ØŒ Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ø¬Ù„Ø³ÛŒ Ùˆ Ù¾Ø± Ø²Ø±Ù‚ Ùˆ Ø¨Ø±Ù‚.\n\n"
        
        "ğŸ’‡ **Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ù„Ù†Ø¯ (Long)**\n"
        "â€¢ **Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ø¨Ù„Ù†Ø¯ V-Cut / Butterfly Cut** â€” Ø§Ù†ØªÙ‡Ø§ÛŒ V Ù…Ø§Ù†Ù†Ø¯ØŒ Ø­Ø¬Ù… Ø¯Ù‡Ù†Ø¯Ù‡ Ùˆ Ø³Ø¨Ú©ØŒ Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ±ÛŒÙ† Ù…Ø¯Ù„ Ø¨Ù„Ù†Ø¯.\n"
        "â€¢ **ØµØ§Ù Ø·Ø¨ÛŒØ¹ÛŒ Ø¨Ù„Ù†Ø¯** â€” Ø¨Ù„Ù†Ø¯ Ùˆ ÛŒÚ©â€ŒØ¯Ø³ØªØŒ Ø³Ø§Ù„Ù… Ùˆ Ø¨Ø±Ø§Ù‚ØŒ Ú©Ù„Ø§Ø³ÛŒÚ© Ùˆ Ù‡Ù…ÛŒØ´Ù‡ Ø´ÛŒÚ©.\n"
        "â€¢ **Ø¯Ù…â€ŒØ§Ø³Ø¨ÛŒ Ø¨Ù„Ù†Ø¯ Ø¨Ø§ Ù„Ø§ÛŒÙ‡** â€” Ø¯Ù…â€ŒØ§Ø³Ø¨ÛŒ Ø¨Ø§ Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†Ø§Ø±ÛŒØŒ Ø¸Ø§Ù‡Ø± Ø§Ø³Ù¾Ø±Øª Ùˆ Ø´ÛŒÚ©.\n"
        "â€¢ **ÙØ± Ø¨Ø§Ø² Ø¨Ù„Ù†Ø¯** â€” ÙØ±Ù‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ Ùˆ Ø²ÛŒØ¨Ø§ØŒ Ø­Ø¬Ù… Ø¨Ø§Ù„Ø§ØŒ Ù…Ù†Ø§Ø³Ø¨ Ù…ÙˆØ§Ø¬Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ù„Ø³ÛŒ.\n"
        "â€¢ **Ø±ÛŒØ´â€ŒØ±ÛŒØ´ Ø¨Ù„Ù†Ø¯ (Shaggy)** â€” Ù„Ø§ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…ØªÙ‚Ø§Ø±Ù†ØŒ Ø¸Ø§Ù‡Ø± Ø®Ø´Ù† Ùˆ Ø¨Ø§Ø­Ø§Ù„ØŒ Ù…Ù†Ø§Ø³Ø¨ Ø¬ÙˆØ§Ù†Ø§Ù†.\n"
        "â€¢ **Ø¨Ù„Ø§Ù†Øª Ø¨Ù„Ù†Ø¯ (Blunt)** â€” Ø§Ù†ØªÙ‡Ø§ÛŒ ÛŒÚ©â€ŒØ¯Ø³Øª Ùˆ ØµØ§ÙØŒ Ø¸Ø§Ù‡Ø± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒØŒ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø¨Ø§Ù„Ø§.\n"
        "â€¢ **ÙˆÛŒÙˆ ÛŒØ®ÛŒ / Ù…ÙˆØ¬ ÙØ§Ù†ØªØ²ÛŒ** â€” Ù…ÙˆØ¬â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…Ù†Ø¸Ù… Ùˆ Ù‡Ù†Ø±ÛŒØŒ Ø§Ø³ØªØ§ÛŒÙ„ Ø®ÛŒØ§Ø¨Ø§Ù†ÛŒ Ùˆ Ù…Ø¯Ø±Ù†.\n"
        "â€¢ **Ú©Ø±Ù‡â€ŒØ§ÛŒ ÙØ§Ù†ØªØ²ÛŒ** â€” Ø¨Ù„Ù†Ø¯ Ø¨Ø§ Ú†ØªØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒØŒ Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ ÙØ§Ù†ØªØ²ÛŒØŒ Ø¨Ø±Ø§ÛŒ Ø¬ÙˆØ§Ù†Ø§Ù† Ø¬Ø³ÙˆØ±.\n"
        "â€¢ **Ù…ÙˆØ¬ Ø³Ø§Ø­Ù„ÛŒ / ÙØ± Ø¨Ø§Ø² (Beach Waves)** â€” Ù…ÙˆØ¬â€ŒÙ‡Ø§ÛŒ Ù…Ù„Ø§ÛŒÙ… Ùˆ Ø·Ø¨ÛŒØ¹ÛŒØŒ Ø§Ø³ØªØ§ÛŒÙ„ Ø±Ø§Ø­Øª Ùˆ Ø±ÙˆØ²Ù…Ø±Ù‡.\n\n"
        
        "ğŸ’« **Ø´ÛŒÙ†ÛŒÙˆÙ†â€ŒÙ‡Ø§ Ùˆ Ø¨Ø§ÙØªâ€ŒÙ‡Ø§ (Updos & Braids)**\n"
        "â€¢ **Ø´ÛŒÙ†ÛŒÙˆÙ† Ú©Ù„Ø§Ø³ÛŒÚ© Ø¨Ø§ Ø¨Ø§ÙØª Ø¨Ø§Ø²** â€” Ø´ÛŒÙ†ÛŒÙˆÙ† Ù…Ø±ØªØ¨ Ø¨Ø§ Ø¨Ø§ÙØª Ø¨Ø§Ø² Ø¯Ø± Ú©Ù†Ø§Ø±Ù‡Ø§ØŒ Ø¸Ø§Ù‡Ø± Ø®Ø§Ù†Ù…â€ŒØ§Ù†Ù‡ Ùˆ Ù…Ø¬Ù„Ø³ÛŒ.\n"
        "â€¢ **Ø´ÛŒÙ†ÛŒÙˆÙ† ÙØ±Ø§Ù†Ø³ÙˆÛŒ Ú¯ÙˆØ¬Ù‡â€ŒØ§ÛŒ** â€” Ø´ÛŒÙ†ÛŒÙˆÙ† Ø¨Ø§Ù„Ø§ Ùˆ Ú¯Ø±Ø¯ØŒ Ú©Ù„Ø§Ø³ÛŒÚ© Ùˆ Ù‡Ù…ÛŒØ´Ù‡ Ù…ÙˆØ«Ø±.\n"
        "â€¢ **Ø´ÛŒÙ†ÛŒÙˆÙ† Ù¾Ø§ÛŒÛŒÙ† Ú¯Ø±Ø¯Ù† Ø³Ø§Ø¯Ù‡** â€” Ø´ÛŒÙ†ÛŒÙˆÙ† Ù¾Ø§ÛŒÛŒÙ†ØŒ Ù…Ø±ØªØ¨ Ùˆ Ø±Ø³Ù…ÛŒØŒ Ù…Ù†Ø§Ø³Ø¨ Ù…Ø­Ù„ Ú©Ø§Ø±.\n"
        "â€¢ **Ø´ÛŒÙ†ÛŒÙˆÙ† Ù†ÛŒÙ…Ù‡ Ø¨Ø§Ø²** â€” Ù†ÛŒÙ…ÛŒ Ø§Ø² Ù…ÙˆÙ‡Ø§ Ø¨Ø§Ø²ØŒ Ù†ÛŒÙ…ÛŒ Ø¨Ø³ØªÙ‡ØŒ Ø§Ø³ØªØ§ÛŒÙ„ Ø±Ù…Ø§Ù†ØªÛŒÚ© Ùˆ Ù…Ø¬Ù„Ø³ÛŒ.\n"
        "â€¢ **Ø´ÛŒÙ†ÛŒÙˆÙ† Ø­Ø¬ÛŒÙ… Ù…Ø¯Ø±Ù†** â€” Ø´ÛŒÙ†ÛŒÙˆÙ† Ø¨Ø§ Ø­Ø¬Ù… Ø¨Ø§Ù„Ø§ØŒ ØªØ§Ø¬â€ŒØ¯Ø§Ø±ØŒ Ø¨Ø±Ø§ÛŒ Ù…Ù‡Ù…Ø§Ù†ÛŒâ€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ.\n"
        "â€¢ **Ø¨Ø§ÙØª ÙØ±Ø§Ù†Ø³ÙˆÛŒ Ú©Ù„Ø§Ø³ÛŒÚ©** â€” Ø¨Ø§ÙØª Ø³Ù‡ ØªØ§Ø± Ø³Ø§Ø¯Ù‡ØŒ Ø¹Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø±Ø³Ù…ÛŒ.\n"
        "â€¢ **Ø¨Ø§ÙØª Ù‡Ù„Ù†Ø¯ÛŒ / ØªØ§Ø¬ÛŒ** â€” Ø¨Ø§ÙØª Ø¨Ø±Ø¬Ø³ØªÙ‡ Ùˆ Ø²ÛŒØ¨Ø§ØŒ Ø¸Ø§Ù‡Ø± Ø³Ù„Ø·Ù†ØªÛŒ Ùˆ Ø®Ø§Øµ.\n"
        "â€¢ **Ø¨Ø§ÙØª Ù…Ø§Ù‡ÛŒ** â€” Ø¨Ø§ÙØª Ø¸Ø±ÛŒÙ Ùˆ Ø²ÛŒØ¨Ø§ØŒ Ù…Ù†Ø§Ø³Ø¨ Ù…ÙˆÙ‡Ø§ÛŒ Ø¨Ù„Ù†Ø¯.\n"
        "â€¢ **Ø¨Ø§ÙØª ØªØ±Ú©ÛŒØ¨ÛŒ Ø¨Ø§ Ø´ÛŒÙ†ÛŒÙˆÙ†** â€” ØªØ±Ú©ÛŒØ¨ Ø¨Ø§ÙØª Ùˆ Ø´ÛŒÙ†ÛŒÙˆÙ†ØŒ Ø§Ø³ØªØ§ÛŒÙ„ Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ùˆ Ù‡Ù†Ø±ÛŒ.\n\n"
        
    )

async def unknown_handler(update: 'Update', context: 'ContextTypes.DEFAULT_TYPE'):
    """Handler Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ.
    Ù¾Ø§Ø³Ø® Ø³Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÛŒâ€ŒÙØ±Ø³ØªØ¯ Ùˆ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ù‡Ø¯Ø§ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
    """
    if update.message:
        try:
            await update.message.reply_text(
                "Ù…Ø¹Ø°Ø±Øª â€” Ù…ØªÙˆØ¬Ù‡ Ù†Ø´Ø¯Ù…. Ù„Ø·ÙØ§Ù‹ ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ÛŒ Ø±Ø§ Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ÛŒØ§ /start Ø¨Ø²Ù†."
            )
        except Exception:
            # Ù…Ø­Ø§ÙØ¸Øª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ø®Ø·Ø§Ù‡Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ (Ù…Ø«Ù„Ø§Ù‹ Ù¾ÛŒØ§Ù… ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ù¾Ø§Ø³Ø®)
            logger.exception('Failed to reply in unknown_handler')
    return

# ---------- end of added helpers ----------
# ---------- helpers (Ø«Ø§Ø¨Øª Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯) ----------
def make_keyboard(rows: List[List[str]], resize: bool = True, one_time: bool = True):
    return ReplyKeyboardMarkup(
        [[KeyboardButton(t) for t in row] for row in rows],
        resize_keyboard=resize,
        one_time_keyboard=one_time
    )

def add_back_cancel(rows: List[List[str]]):
    rows.append([BACK, CANCEL])
    return make_keyboard(rows)

def chunked_options(options: List[str], cols: int = 2) -> List[List[str]]:
    rows: List[List[str]] = []
    row: List[str] = []
    for opt in options:
        row.append(opt)
        if len(row) == cols:
            rows.append(row)
            row = []
    if row:
        rows.append(row)
    return rows

def simple_with_back(options: List[str], cols: int = 2):
    rows = chunked_options(options, cols=cols)
    return add_back_cancel(rows)

def hair_model_keyboard_for_page(page: int, page_size: int = 8, is_female: bool = False):
    if is_female:
        all_models = female_hair_model_options
        if page == 0:
            chunk = female_hair_model_popular
        else:
            start = (page - 1) * page_size
            end = start + page_size
            chunk = female_hair_model_other[start:end]
    else:
        common_models = [
            "Ù…ÙˆÛŒ Ø§Ø±ØªØ´ÛŒ (ØªØ±Ø§Ø´ÛŒØ¯Ù‡)", "Ú©Ø±ÙˆÙ¾", "Ø³Ø§Ø¯Ù‡ Ú©Ù„Ø§Ø³ÛŒÚ©", "Ù…Ø¯Ù„ Ø±ÙˆØ²Ù…Ø±Ù‡",
            "ØªÛŒÙ¾Ø±", "Ø³Ø²Ø§Ø±", "Ø¢Ù†Ø¯Ø±Ú©Ø§Øª", "Ù¾ÙˆÙ…Ù¾Ø§Ø¯ÙˆØ±"
        ]
        other_models = [model for model in hair_model_options if model not in common_models]
        all_models = common_models + other_models
        total = len(all_models)
        start = page * page_size
        end = start + page_size
        chunk = all_models[start:end]
    
    rows = chunked_options(chunk, cols=2)
    
    nav: List[str] = []
    if page > 0:
        nav.append(PREV_PAGE)
    
    if is_female:
        if page == 0 and len(female_hair_model_other) > 0:
            nav.append(NEXT_PAGE)
        elif page > 0 and ((page * page_size) < len(female_hair_model_other)):
            nav.append(NEXT_PAGE)
    else:
        if end < len(all_models):
            nav.append(NEXT_PAGE)
    
    if nav:
        rows.append(nav)
    rows.append([HELP, BACK, CANCEL])
    return make_keyboard(rows)

def hair_color_keyboard_for_page(page: int, page_size: int = 8):
    """ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÛŒ Ø²Ù†Ø§Ù†Ù‡ - Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±"""
    start = page * page_size
    end = start + page_size
    chunk = female_hair_colors_all[start:end]
    
    rows = chunked_options(chunk, cols=2)
    
    nav: List[str] = []
    if page > 0:
        nav.append(PREV_PAGE)
    
    total_pages = (len(female_hair_colors_all) + page_size - 1) // page_size
    
    if page < total_pages - 1:
        nav.append(NEXT_PAGE)
    
    if nav:
        rows.append(nav)
    rows.append([BACK, CANCEL])
    
    return make_keyboard(rows)

# ---------- NEW: Fixed Back Button Logic ----------
def get_previous_state(current_state: int, user_data: Dict[str, Any]) -> int:
    """ØªØ¹ÛŒÛŒÙ† Ø§Ø³ØªÛŒØª Ù‚Ø¨Ù„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ø±Ø§ÛŒØ· Ú©Ø§Ø±Ø¨Ø±"""
    gender = user_data.get("gender")
    hair_status = user_data.get("hair_status")
    
    # Ù…Ø³ÛŒØ± Ø²Ù†Ø§Ù†
    if gender == "Ø²Ù†":
        prev_map = {
            AGE: GENDER,
            HAIR_COLOR: AGE,
            HAIR_TYPE: HAIR_COLOR,
            HAIR_MODEL_FEMALE: HAIR_TYPE,
            HAIR_DYE: HAIR_MODEL_FEMALE,
            FACE_CONDITION: HAIR_DYE,
            FACE_SHAPE: FACE_CONDITION,
            SKIN_COLOR: FACE_SHAPE,
            EYEBROW_COLOR: SKIN_COLOR,
            EYE_COLOR: EYEBROW_COLOR,
            NOSE_TYPE: EYE_COLOR,
            SUMMARY: NOSE_TYPE,
        }
        return prev_map.get(current_state, GENDER)
    
   
    
    # Ù…Ø³ÛŒØ± Ù…Ø±Ø¯Ø§Ù† - ÙˆØ¶Ø¹ÛŒØª Ù…Ùˆ "Ø¬Ù„Ùˆ ØªØ§ Ù¾Ø´Øª Ø³Ø± Ø¨Ø¯ÙˆÙ† Ù…Ùˆ" ÛŒØ§ "Ø¯Ø§Ø±Ø§ÛŒ Ù…Ùˆ"
    if hair_status in ["Ø¬Ù„Ùˆ ØªØ§ Ù¾Ø´Øª Ø³Ø± Ø¨Ø¯ÙˆÙ† Ù…Ùˆ", "Ø¯Ø§Ø±Ø§ÛŒ Ù…Ùˆ"]:
        prev_map = {
            AGE: GENDER,
            HAIR_STATUS: AGE,
            HAIR_COLOR: HAIR_STATUS,
            HAIR_TYPE: HAIR_COLOR,
        }
        
        # Ø¨Ø±Ø§ÛŒ HAIR_MODEL Ùˆ HAIR_DYE Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ skip_hair_model
        if user_data.get("skip_hair_model"):
            prev_map[HAIR_DYE] = HAIR_TYPE
            prev_map[FACE_CONDITION] = HAIR_DYE
        else:
            prev_map[HAIR_MODEL] = HAIR_TYPE
            prev_map[HAIR_DYE] = HAIR_MODEL
            prev_map[FACE_CONDITION] = HAIR_DYE
        
        prev_map.update({
            FACE_SHAPE: FACE_CONDITION,
            SKIN_COLOR: FACE_SHAPE,
            EYEBROW_COLOR: SKIN_COLOR,
            EYE_COLOR: EYEBROW_COLOR,
            NOSE_TYPE: EYE_COLOR,
            BEARD_PRESENT: NOSE_TYPE,
            BEARD_COLOR: BEARD_PRESENT,
            BEARD_MODEL: BEARD_COLOR,
            BEARD_DYE: BEARD_MODEL,
            SUMMARY: BEARD_DYE if user_data.get("beard") == "Ø¨Ù„Ù‡" else NOSE_TYPE,
        })
        
        return prev_map.get(current_state, GENDER)
    
    # Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    return GENDER

# ---------- conversation (Ø«Ø§Ø¨Øª Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯) ----------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    context.user_data["history"] = []
    kb = make_keyboard([[READY], [CANCEL]])
    await update.message.reply_text(
        "Ø³Ù„Ø§Ù…! Ø¨Ù‡ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… StyleBot Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ! ğŸ‘‹\n\n"
        "ğŸ¤– Ø§ÛŒÙ† Ø±Ø¨Ø§Øª Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…Ø¯Ù„ Ùˆ Ø±Ù†Ú¯ Ù…Ùˆ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡.\n"
        "ğŸ¯ Ø¨Ø§ Ú©Ù…Ú© Ù…Ù† Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¨Ù‡ØªØ±ÛŒÙ† Ø§Ø³ØªØ§ÛŒÙ„ Ø±Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§Øª Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒ.\n\n"
        "ğŸ’« Ø§Ú¯Ù‡ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Â«Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù…Â» Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.",
        reply_markup=kb,
    )
    return GENDER

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    return await start(update, context)

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    await update.message.reply_text(
        "Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…! Ù‡Ø± ÙˆÙ‚Øª Ø®ÙˆØ§Ø³ØªÛŒ Ø¨Ø±Ú¯Ø±Ø¯ÛŒ Ù…Ù† Ø§ÛŒÙ†Ø¬Ø§Ù…. ğŸ‘‹\n"
        "Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø² /start Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.",
        reply_markup=ReplyKeyboardRemove()
    )
    return ConversationHandler.END

# ---------- NEW: Safe-Back Navigation ----------
async def navigate_back(current_state: int, update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¨Ø§Ø²Ú¯Ø´Øª ØªÙ…ÛŒØ² Ø¨Ù‡ Ø§Ø³ØªÛŒØª Ù‚Ø¨Ù„ÛŒ Ø¨Ø¯ÙˆÙ† Ù„ÙˆÙ¾"""
    history = context.user_data.get("history", [])
    if history and history[-1] == current_state:          # Ø­Ø°Ù Ø§Ø³ØªÛŒØª ÙØ¹Ù„ÛŒ
        history.pop()
    prev_state = history[-1] if history else GENDER
    context.user_data["history"] = history
    context.user_data["is_navigating_back"] = True        # ÙÙ„Ú¯ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø«Ø¨Øª Ù…Ø¬Ø¯Ø¯
    return await route_to_state(prev_state, update, context)

async def route_to_state(state, update: Update, context: ContextTypes.DEFAULT_TYPE):
    if state is None:
        return await ask_gender(update, context)

    states_map = {
        GENDER: ask_gender,
        AGE: ask_age,
        HAIR_STATUS: ask_hair_status,
        HAIR_COLOR: ask_hair_color,
        HAIR_TYPE: ask_hair_type,
        HAIR_MODEL: ask_hair_model,
        HAIR_MODEL_FEMALE: ask_hair_model_female,
        HAIR_DYE: ask_hair_dye,
        FACE_CONDITION: ask_face_condition,
        FACE_SHAPE: ask_face_shape,
        SKIN_COLOR: ask_skin_color,
        EYEBROW_COLOR: ask_eyebrow_color,
        EYE_COLOR: ask_eye_color,
        NOSE_TYPE: ask_nose_type,
        BEARD_PRESENT: ask_beard_present,
        BEARD_COLOR: ask_beard_color,
        BEARD_MODEL: ask_beard_model,
        BEARD_DYE: ask_beard_dye,
        SUMMARY: show_summary,
    }
    handler = states_map.get(state, ask_gender)
    return await handler(update, context)

# GENDER
async def ask_gender(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(gender_options, cols=2)
    await update.message.reply_text(" Ø¬Ù†Ø³ÛŒØª Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(GENDER)
    return GENDER

async def gender_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(GENDER, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text == READY:
        return await ask_gender(update, context)
    if text not in gender_options:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=simple_with_back(gender_options, cols=2))
        return GENDER
    
    context.user_data["gender"] = text
    return await ask_age(update, context)

# AGE
async def ask_age(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(age_options)
    await update.message.reply_text("ğŸ‚ Ø¨Ø§Ø²Ù‡â€ŒÛŒ Ø³Ù† Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(AGE)
    return AGE

async def age_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(AGE, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text == READY:
        return await ask_age(update, context)
    if text not in age_options:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=simple_with_back(age_options))
        return AGE
    
    context.user_data["age"] = text
    
    if context.user_data.get("gender") == "Ø²Ù†":
        return await ask_hair_color(update, context)
    else:
        return await ask_hair_status(update, context)

# HAIR_STATUS - ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø¯Ø§Ù†
async def ask_hair_status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(hair_status_options)
    await update.message.reply_text("ğŸ’ˆ ÙˆØ¶Ø¹ÛŒØª Ù…ÙˆÙ‡Ø§Øª Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(HAIR_STATUS)
    return HAIR_STATUS

async def hair_status_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(HAIR_STATUS, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text not in hair_status_options:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=simple_with_back(hair_status_options))
        return HAIR_STATUS
    
    context.user_data["hair_status"] = text
    
    if text == "Ø¯Ø§Ø±Ø§ÛŒ Ù…Ùˆ":
        return await ask_hair_color(update, context)
    elif text == "Ø¬Ù„Ùˆ ØªØ§ Ù¾Ø´Øª Ø³Ø± Ø¨Ø¯ÙˆÙ† Ù…Ùˆ":
        context.user_data["skip_hair_model"] = True
        return await ask_hair_color(update, context)

# HAIR COLOR
async def ask_hair_color(update: Update, context: ContextTypes.DEFAULT_TYPE):
    is_female = context.user_data.get("gender") == "Ø²Ù†"
    
    if is_female:
        context.user_data["hair_color_page"] = 0
        kb = hair_color_keyboard_for_page(0)
        await update.message.reply_text("ğŸ¨ Ø±Ù†Ú¯ Ù…ÙˆÛŒ ÙØ¹Ù„ÛŒ Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    else:
        kb = simple_with_back(hair_color_options)
        await update.message.reply_text("ğŸ¨ Ø±Ù†Ú¯ Ù…ÙˆÛŒ ÙØ¹Ù„ÛŒ Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(HAIR_COLOR)
    return HAIR_COLOR

async def hair_color_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(HAIR_COLOR, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    
    is_female = context.user_data.get("gender") == "Ø²Ù†"
    
    if is_female:
        page = context.user_data.get("hair_color_page", 0)
        
        if text == NEXT_PAGE:
            page += 1
            context.user_data["hair_color_page"] = page
            kb = hair_color_keyboard_for_page(page)
            await update.message.reply_text("ğŸ“„ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ÛŒ Ø±Ù†Ú¯â€ŒÙ‡Ø§:", reply_markup=kb)
            return HAIR_COLOR
        
        if text == PREV_PAGE:
            page = max(0, page - 1)
            context.user_data["hair_color_page"] = page
            kb = hair_color_keyboard_for_page(page)
            await update.message.reply_text("ğŸ“„ ØµÙØ­Ù‡ Ù‚Ø¨Ù„ÛŒ Ø±Ù†Ú¯â€ŒÙ‡Ø§:", reply_markup=kb)
            return HAIR_COLOR
        
        if text not in female_hair_colors_all:
            kb = hair_color_keyboard_for_page(page)
            await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=kb)
            return HAIR_COLOR
        
        context.user_data["hair_color"] = text
        return await ask_hair_type(update, context)
    else:
        if text not in hair_color_options:
            kb = simple_with_back(hair_color_options)
            await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=kb)
            return HAIR_COLOR
        
        context.user_data["hair_color"] = text
        return await ask_hair_type(update, context)

# HAIR TYPE
async def ask_hair_type(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(hair_type_options)
    await update.message.reply_text("ğŸŒ€ Ø¬Ù†Ø³ Ù…ÙˆÛŒ Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(HAIR_TYPE)
    return HAIR_TYPE

async def hair_type_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(HAIR_TYPE, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text not in hair_type_options:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=simple_with_back(hair_type_options))
        return HAIR_TYPE
    
    context.user_data["hair_type"] = text
    
    is_female = context.user_data.get("gender") == "Ø²Ù†"
    skip_model = context.user_data.get("skip_hair_model", False)
    
    if is_female:
        context.user_data["hair_page"] = 0
        return await ask_hair_model_female(update, context)
    elif skip_model:
        return await ask_hair_dye(update, context)
    else:
        return await ask_hair_model(update, context)

# HAIR MODEL FOR MALE
async def ask_hair_model(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["hair_page"] = 0
    kb = hair_model_keyboard_for_page(0, is_female=False)
    await update.message.reply_text("ğŸ’ˆ Ù…Ø¯Ù„ Ù…ÙˆÛŒ ÙØ¹Ù„ÛŒ Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† (ØµÙØ­Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ):", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(HAIR_MODEL)
    return HAIR_MODEL

async def hair_model_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(HAIR_MODEL, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text == HELP:
        await update.message.reply_text(
            "â„¹ï¸ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ùˆ:\n\n"
            "â€¢ Ù…ÙˆÛŒ Ø§Ø±ØªØ´ÛŒ (ØªØ±Ø§Ø´ÛŒØ¯Ù‡): Ú©ÙˆØªØ§Ù‡ Ùˆ ÛŒÚ©Ø¯Ø³ØªØŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø¢Ø³Ø§Ù†\n"
            "â€¢ Ú©Ø±ÙˆÙ¾: Ú©ÙˆØªØ§Ù‡ Ùˆ Ú©Ù„Ø§Ø³ÛŒÚ©ØŒ Ù…Ù†Ø§Ø³Ø¨ ØªÙ…Ø§Ù… ØµÙˆØ±Øªâ€ŒÙ‡Ø§\n"
            "â€¢ Ø³Ø²Ø§Ø±: Ú©ÙˆØªØ§Ù‡ Ø¨Ø§ Ú†ØªØ±ÛŒ ØµØ§ÙØŒ Ø¸Ø§Ù‡Ø± Ø±ÙˆÙ…ÛŒ\n"
            "â€¢ ØªÛŒÙ¾Ø±: Ú©ÙˆØªØ§Ù‡ÛŒ ØªØ¯Ø±ÛŒØ¬ÛŒØŒ Ø¸Ø§Ù‡Ø± Ø·Ø¨ÛŒØ¹ÛŒ\n"
            "â€¢ Ø³Ø§Ø¯Ù‡ Ú©Ù„Ø§Ø³ÛŒÚ©: Ù…Ø¯Ù„ Ù‡Ù…ÛŒØ´Ù‡ Ø´ÛŒÚ© Ùˆ Ù…Ù†Ø§Ø³Ø¨\n"
            "â€¢ Ù…Ø¯Ù„ Ø±ÙˆØ²Ù…Ø±Ù‡: Ø³Ø§Ø¯Ù‡ Ùˆ Ù‚Ø§Ø¨Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡\n"
            "â€¢ Ø¢Ù†Ø¯Ø±Ú©Ø§Øª: Ø¨Ø§Ù„Ø§ Ø¨Ù„Ù†Ø¯ØŒ Ø§Ø·Ø±Ø§Ù Ú©ÙˆØªØ§Ù‡ØŒ Ù…Ø¯Ø±Ù†\n"
            "â€¢ Ù¾ÙˆÙ…Ù¾Ø§Ø¯ÙˆØ±: Ø­Ø¬Ù… Ø¨Ø§Ù„Ø§ Ø¯Ø± Ø¬Ù„ÙˆØŒ Ú©Ù„Ø§Ø³ÛŒÚ©\n"
            "â€¢ ÙÛŒØ¯: Ú©ÙˆØªØ§Ù‡ÛŒ ØªØ¯Ø±ÛŒØ¬ÛŒ Ø§Ø² Ø¨Ø§Ù„Ø§ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†\n"
            "â€¢ ØªÚ©Ø³Ú†Ø± Ú©ÙˆØªØ§Ù‡: Ú©ÙˆØªØ§Ù‡ Ø¨Ø§ Ø¨Ø§ÙØª Ø·Ø¨ÛŒØ¹ÛŒ\n"
            "â€¢ Ù‡Ø§ÛŒâ€ŒØ§Ù†Ø¯Øª: ÙÛŒØ¯ Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ù„Ø§ØŒ Ù…Ø¯Ø±Ù†\n"
            "â€¢ Ø§Ø³Ú©ÛŒÙ† ÙÛŒØ¯: Ú©ÙˆØªØ§Ù‡ ØªØ§ Ù¾ÙˆØ³ØªØŒ Ø¨Ø³ÛŒØ§Ø± ØªÙ…ÛŒØ²\n"
            "â€¢ Ø³Ø§ÛŒØ¯ Ù¾Ø§Ø±Øª: Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ù…Ø´Ø®ØµØŒ Ø´ÛŒÚ©\n"
            "â€¢ Ú©Ø±Ø§Ù¾ ØªÚ©Ø³Ú†Ø±: Ú©ÙˆØªØ§Ù‡ Ø¨Ø§ Ø¨Ø§ÙØª Ùˆ Ø­Ø±Ú©Øª\n"
            "â€¢ Ú©ÙˆÛŒÙ: Ù…ÙˆÙ‡Ø§ Ø¨Ù‡ Ø¹Ù‚Ø¨ Ø´Ø§Ù†Ù‡ Ø´Ø¯Ù‡\n"
            "â€¢ Ø¢ÛŒÙˆÛŒ Ù„ÛŒÚ¯: Ú©ÙˆØªØ§Ù‡ Ùˆ Ù…Ø±ØªØ¨ØŒ Ú©Ù„Ø§Ø³ÛŒÚ©\n"
            "â€¢ Ú©Ù…Ø¨â€ŒØ§ÙˆÙØ±: Ø´Ù†Ù‡ Ø¨Ù‡ ÛŒÚ© Ø³Ù…ØªØŒ Ø±Ø³Ù…ÛŒ\n"
            "â€¢ Ù…ÙˆÙ‡Ø§Ú©: Ø®Ø· ÙˆØ³Ø· Ø¨Ù„Ù†Ø¯ØŒ Ø¬Ø³ÙˆØ±Ø§Ù†Ù‡\n"
            "â€¢ ÙØ§Ú©â€ŒÙ‡Ø§Ú©: ÙˆØ³Ø· Ø¨Ù„Ù†Ø¯ØŒ Ø§Ø·Ø±Ø§Ù Ú©ÙˆØªØ§Ù‡\n"
            "â€¢ Ø¢ÙØ±Ùˆ Ú©ÙˆØªØ§Ù‡: Ø­Ø¬Ù… Ú¯Ø±Ø¯ØŒ Ù…Ù†Ø§Ø³Ø¨ Ù…ÙˆÙ‡Ø§ÛŒ ÙØ±\n"
            "â€¢ ØªÙˆØ¦ÛŒØ³Øª: Ù…ÙˆÙ‡Ø§ÛŒ ØªØ§Ø¨ÛŒØ¯Ù‡ØŒ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯\n"
            "â€¢ Ø§Ø³Ù¾Ø§ÛŒÚ©ÛŒ Ú©ÙˆØªØ§Ù‡: Ù…ÙˆÙ‡Ø§ÛŒ Ø§ÛŒØ³ØªØ§Ø¯Ù‡ØŒ Ø¬ÙˆØ§Ù†Ø§Ù†Ù‡\n"
            "â€¢ Ø¨ÙˆÚ©Ø³ÙˆØ±ÛŒ: Ú©ÙˆØªØ§Ù‡ Ùˆ Ù…Ø­Ú©Ù…ØŒ ÙˆØ±Ø²Ø´ÛŒ\n"
            "â€¢ Ø¢Ù„Ù…Ø§Ù†ÛŒ: Ú©ÙˆØªØ§Ù‡ Ùˆ Ù…Ø±ØªØ¨ØŒ Ø§Ø±ÙˆÙ¾Ø§ÛŒÛŒ\n"
            "â€¢ Ø³ÙˆÙ†: Ú©ÙˆØªØ§Ù‡ Ùˆ Ø´ÛŒÚ©ØŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ\n"
            "â€¢ Ø³Ø§ÛŒØ¯ Ù¾Ø§Ø±Øª Ø³Ø§Ø¯Ù‡: Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ø³Ø§Ø¯Ù‡\n"
            "â€¢ Ø³Ù„ÛŒÚ©â€ŒØ¨Ú© Ø³Ø§Ø¯Ù‡: Ù…ÙˆÙ‡Ø§ÛŒ ØµØ§Ù Ø¨Ù‡ Ø¹Ù‚Ø¨\n"
            "â€¢ Ù…Ø§Ù†â€ŒØ¨Ù† Ø³Ø§Ø¯Ù‡: Ú¯Ø±Ù‡ Ø³Ø§Ø¯Ù‡ Ø¨Ø§Ù„Ø§ÛŒ Ø³Ø±\n"
            "â€¢ Ù…ØªÙˆØ³Ø· Ú©Ù„Ø§Ø³ÛŒÚ©: Ø·ÙˆÙ„ Ù…ØªÙˆØ³Ø·ØŒ Ø´ÛŒÚ©\n"
            "â€¢ Ø¨Ø±Ùˆ ÙÙÙ„Ùˆ: Ø´Ø§Ù†Ù‡ Ø¨Ù‡ Ø¹Ù‚Ø¨ØŒ Ø·Ø¨ÛŒØ¹ÛŒ\n"
            "â€¢ ÙØ±ÛŒÙ†Ø¬ Ù†Ø§Ù…Ø±ØªØ¨: Ú†ØªØ±ÛŒ Ù†Ø§Ù…Ø±ØªØ¨ØŒ Ø¬ÙˆØ§Ù†Ø§Ù†Ù‡\n"
            "â€¢ ØªØ§Ù¾â€ŒÙ†Ø§Øª: Ù…ÙˆÙ‡Ø§ÛŒ Ø¬Ù…Ø¹ Ø´Ø¯Ù‡ØŒ Ù…Ø¯Ø±Ù†\n"
            "â€¢ Ù…ÙˆÛŒ Ù…ÙˆØ¬â€ŒØ¯Ø§Ø± Ù…ØªÙˆØ³Ø·: Ù…ÙˆØ¬ Ø·Ø¨ÛŒØ¹ÛŒ\n"
            "â€¢ ØªÚ©Ø³ØªÚ†Ø± Ø¨Ù„Ù†Ø¯: Ø¨Ù„Ù†Ø¯ Ø¨Ø§ Ø¨Ø§ÙØª\n"
            "â€¢ Ù„Ø§Ù†Ú¯ ØªÚ©Ø³Ú†Ø±: Ø¨Ù„Ù†Ø¯ Ø¨Ø§ Ø¨Ø§ÙØª Ø·Ø¨ÛŒØ¹ÛŒ\n"
            "â€¢ Ú©Ø±Ø§Ù¾ ÙØ±Ø§Ù†Ø³ÙˆÛŒ: Ú©ÙˆØªØ§Ù‡ Ùˆ Ù…Ø±ØªØ¨\n"
            "â€¢ Ø¨Ø§ØªØ²: Ú©ÙˆØªØ§Ù‡ Ø¨Ø§ Ø·ÙˆÙ„ ÛŒÚ©Ù†ÙˆØ§Ø®Øª\n"
            "â€¢ ØªÚ©Ø³ØªÚ†Ø±: Ø¨Ø§ Ø¨Ø§ÙØª Ùˆ Ø­Ø±Ú©Øª\n"
            "â€¢ Ù„Ø§Ù†Ú¯ Ø³Ù„ÛŒÚ©â€ŒØ¨Ú©: Ø¨Ù„Ù†Ø¯ Ùˆ ØµØ§Ù Ø¨Ù‡ Ø¹Ù‚Ø¨\n"
            "â€¢ Ù…Ø§Ù†â€ŒØ¨Ù†: Ú¯Ø±Ù‡ Ù…Ùˆ Ø¯Ø± Ø¨Ø§Ù„Ø§ÛŒ Ø³Ø±\n"
            "â€¢ Ø¨Ù„Ù†Ø¯ Ú©Ù„Ø§Ø³ÛŒÚ©: Ø¨Ù„Ù†Ø¯ Ùˆ Ø´ÛŒÚ©\n"
            "â€¢ ØµØ§Ù Ùˆ Ø¨Ù„Ù†Ø¯: Ø¨Ù„Ù†Ø¯ Ùˆ ØµØ§Ù\n"
            "â€¢ Ù…ÙˆÛŒ Ù…ÙˆØ¬â€ŒØ¯Ø§Ø± (Ø³ÙˆØ±ÙØ±): Ù…ÙˆØ¬ Ø·Ø¨ÛŒØ¹ÛŒ\n"
            "â€¢ Ù…Ø¯Ù„â€ŒØ¯Ø§Ø± Ø¨Ù„Ù†Ø¯: Ø¨Ù„Ù†Ø¯ Ø¨Ø§ Ø§Ø³ØªØ§ÛŒÙ„\n"
            "â€¢ Ø¯Ø±Ø¯Ù„Ú©: Ø¨Ø§ÙØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ù„Ù†Ø¯ Ùˆ Ù¾ÛŒÚ†ÛŒØ¯Ù‡"
        )
        await update.message.reply_text("ğŸ“„ Ø­Ø§Ù„Ø§ Ù…Ø¯Ù„ Ù…ÙˆÛŒ Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ğŸ‘‡")
        return HAIR_MODEL

    page = context.user_data.get("hair_page", 0)
    
    if text == NEXT_PAGE:
        page += 1
        context.user_data["hair_page"] = page
        kb = hair_model_keyboard_for_page(page, is_female=False)
        await update.message.reply_text("ğŸ“„ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ÛŒ Ù…Ø¯Ù„ Ù…Ùˆ:", reply_markup=kb)
        return HAIR_MODEL
    
    if text == PREV_PAGE:
        page = max(0, page - 1)
        context.user_data["hair_page"] = page
        kb = hair_model_keyboard_for_page(page, is_female=False)
        await update.message.reply_text("ğŸ“„ ØµÙØ­Ù‡ Ù‚Ø¨Ù„ÛŒ Ù…Ø¯Ù„ Ù…Ùˆ:", reply_markup=kb)
        return HAIR_MODEL
    
    if text not in hair_model_options:
        kb = hair_model_keyboard_for_page(page, is_female=False)
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=kb)
        return HAIR_MODEL
    
    context.user_data["hair_model"] = text
    return await ask_hair_dye(update, context)

# HAIR MODEL FOR FEMALE (Ø«Ø§Ø¨Øª Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯)
async def ask_hair_model_female(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["hair_page"] = 0
    kb = hair_model_keyboard_for_page(0, is_female=True)
    await update.message.reply_text("Ù…Ø¯Ù„ Ù…ÙˆÛŒ ÙØ¹Ù„ÛŒ Ø®ÙˆØ¯Øª Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(HAIR_MODEL_FEMALE)
    return HAIR_MODEL_FEMALE

async def hair_model_female_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(HAIR_MODEL_FEMALE, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    
    if text == HELP:
        help_text = get_female_hair_model_help()
        await update.message.reply_text(help_text)
        await update.message.reply_text("ğŸ“¸ Ø­Ø§Ù„Ø§ Ù…Ø¯Ù„ Ù…ÙˆÛŒ Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ğŸ‘‡")
        return HAIR_MODEL_FEMALE
    
    page = context.user_data.get("hair_page", 0)
    
    if text == NEXT_PAGE:
        page += 1
        context.user_data["hair_page"] = page
        kb = hair_model_keyboard_for_page(page, is_female=True)
        await update.message.reply_text("ğŸ“„ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ÛŒ Ù…Ø¯Ù„ Ù…Ùˆ:", reply_markup=kb)
        return HAIR_MODEL_FEMALE
    
    if text == PREV_PAGE:
        page = max(0, page - 1)
        context.user_data["hair_page"] = page
        kb = hair_model_keyboard_for_page(page, is_female=True)
        await update.message.reply_text("ğŸ“„ ØµÙØ­Ù‡ Ù‚Ø¨Ù„ÛŒ Ù…Ø¯Ù„ Ù…Ùˆ:", reply_markup=kb)
        return HAIR_MODEL_FEMALE
    
    all_options = female_hair_model_options
    if text not in all_options:
        kb = hair_model_keyboard_for_page(page, is_female=True)
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=kb)
        return HAIR_MODEL_FEMALE
    
    context.user_data["hair_model"] = text
    return await ask_hair_dye(update, context)

# HAIR DYE
async def ask_hair_dye(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(dye_options)
    await update.message.reply_text("ğŸ¨ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ù…ÙˆÙ‡Ø§Øª Ø±Ùˆ Ø±Ù†Ú¯ Ú©Ù†ÛŒØŸ", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(HAIR_DYE)
    return HAIR_DYE

async def hair_dye_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(HAIR_DYE, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text not in dye_options:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=simple_with_back(dye_options))
        return HAIR_DYE
    
    context.user_data["hair_dye"] = text
    return await ask_face_condition(update, context)

# FACE_CONDITION
async def ask_face_condition(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(face_condition_options)
    await update.message.reply_text("ğŸ˜Š ÙˆØ¶Ø¹ÛŒØª ØµÙˆØ±Øª Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(FACE_CONDITION)
    return FACE_CONDITION

async def face_condition_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(FACE_CONDITION, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text not in face_condition_options:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=simple_with_back(face_condition_options))
        return FACE_CONDITION
    
    context.user_data["face_condition"] = text
    return await ask_face_shape(update, context)
# Ù…Ø³ÛŒØ± Ù¾Ø§ÛŒÙ‡ Ù¾Ø±ÙˆÚ˜Ù‡
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
# Ù…Ø³ÛŒØ± Ù¾ÙˆØ´Ù‡ ØªØµØ§ÙˆÛŒØ± ÙØ±Ù… ØµÙˆØ±Øª
FACE_BASE_PATH = os.path.join(BASE_DIR, "face")

# FACE_SHAPE
async def ask_face_shape(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = add_back_cancel([face_shape_options[0:4], face_shape_options[4:7], [HELP]])
    await update.message.reply_text("ğŸ˜Š ÙØ±Ù… ØµÙˆØ±Øª Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(FACE_SHAPE)
    return FACE_SHAPE

async def face_shape_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text

    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(FACE_SHAPE, update, context)

    if text == HELP:
        # Ù…Ø³ÛŒØ± Ù¾Ø§ÛŒÙ‡ ØªØµØ§ÙˆÛŒØ±
        base_path = FACE_BASE_PATH  # Ø§ÛŒÙ† Ø±Ø§ Ø§Ø² Ø§ÛŒÙ…Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒ

        # ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØµØ§ÙˆÛŒØ± Ù…Ø±Ø¯Ø§Ù†Ù‡
        male_files = [
            "beyziM.jpg",
            "gerdM.jpg",
            "mostatiliM.webp",
            "ghalbiM.jpg",
            "mosalasiM.jpg",
            "morabaeiM.jpg",
            "AlmasiM.jpg"
        ]
        # ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØµØ§ÙˆÛŒØ± Ø²Ù†Ø§Ù†Ù‡
        female_files = [
            "beyziZ.jpg",
            "gerdZ.jpg",
            "mostatiliZ.jpg",
            "ghalbiZ.jpg",
            "mosalasiZ.jpg",
            "morabaeiZ.jpg",
            "AlmasiZ.jpg"
        ]

        # Ú©Ù¾Ø´Ù†â€ŒÙ‡Ø§
        captions = [
            "ğŸ”µ Ø¨ÛŒØ¶ÛŒ:\nØµÙˆØ±Øª Ú©Ø´ÛŒØ¯Ù‡ Ùˆ Ù…ØªÙ‚Ø§Ø±Ù†ØŒ Ù¾ÛŒØ´Ø§Ù†ÛŒ Ú©Ù…ÛŒ Ù¾Ù‡Ù†â€ŒØªØ± Ø§Ø² Ú†Ø§Ù†Ù‡.",
            "ğŸŸ¢ Ú¯Ø±Ø¯:\nØµÙˆØ±Øª ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ø¯Ø§ÛŒØ±Ù‡â€ŒØ§ÛŒ Ø´Ú©Ù„ØŒ Ø·ÙˆÙ„ Ùˆ Ø¹Ø±Ø¶ Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ù‡Ù….",
            "ğŸŸ£ Ù…Ø³ØªØ·ÛŒÙ„ÛŒ:\nØµÙˆØ±Øª Ú©Ø´ÛŒØ¯Ù‡ Ùˆ Ø²Ø§ÙˆÛŒÙ‡â€ŒØ¯Ø§Ø±ØŒ Ø·ÙˆÙ„ ØµÙˆØ±Øª Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø¹Ø±Ø¶.",
            "â¤ï¸ Ù‚Ù„Ø¨ÛŒ:\nÙ¾ÛŒØ´Ø§Ù†ÛŒ Ù¾Ù‡Ù† Ùˆ Ø¨Ø±Ø¬Ø³ØªÙ‡ØŒ Ú†Ø§Ù†Ù‡ Ø¨Ø§Ø±ÛŒÚ© Ùˆ Ù†ÙˆÚ©â€ŒØªÛŒØ².",
            "ğŸ”º Ù…Ø«Ù„Ø«ÛŒ:\nÚ†Ø§Ù†Ù‡ Ù¾Ù‡Ù† Ùˆ Ù…Ø´Ø®ØµØŒ ÙÚ© Ù‚ÙˆÛŒØŒ Ù¾ÛŒØ´Ø§Ù†ÛŒ Ø¨Ø§Ø±ÛŒÚ©â€ŒØªØ±.",
            "ğŸŸ§ Ù…Ø±Ø¨Ø¹ÛŒ:\nÙÚ© Ù‚ÙˆÛŒ Ùˆ Ø²Ø§ÙˆÛŒÙ‡â€ŒØ¯Ø§Ø±ØŒ Ø·ÙˆÙ„ Ùˆ Ø¹Ø±Ø¶ ØµÙˆØ±Øª ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ø¨Ø±Ø§Ø¨Ø±.",
            "ğŸ’ Ø§Ù„Ù…Ø§Ø³ÛŒ:\nÚ¯ÙˆÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø±Ø¬Ø³ØªÙ‡ Ùˆ Ù¾Ù‡Ù†ØŒ Ú†Ø§Ù†Ù‡ Ùˆ Ù¾ÛŒØ´Ø§Ù†ÛŒ Ø¨Ø§Ø±ÛŒÚ©â€ŒØªØ±."
        ]

        gender = context.user_data.get("gender", "Ù…Ø±Ø¯")
        selected_files = female_files if gender == "Ø²Ù†" else male_files

        for fname, caption in zip(selected_files, captions):
            path = os.path.join(base_path, fname)
            try:
                with open(path, "rb") as photo:
                    await update.message.reply_photo(photo=photo, caption=caption)
            except FileNotFoundError:
                await update.message.reply_text(f"âš ï¸ ÙØ§ÛŒÙ„ ØªØµÙˆÛŒØ± ÛŒØ§ÙØª Ù†Ø´Ø¯: {fname}")
            except Exception as e:
                logger.exception("Error sending face guide photo: %s", e)

        await update.message.reply_text("ğŸ“¸ Ø­Ø§Ù„Ø§ ÙØ±Ù… ØµÙˆØ±Øª Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ğŸ‘‡")
        return FACE_SHAPE

    # Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±
    if text not in face_shape_options:
        await update.message.reply_text(
            "âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†",
            reply_markup=add_back_cancel([face_shape_options[0:4], face_shape_options[4:7], [HELP]])
        )
        return FACE_SHAPE

    context.user_data["face_shape"] = text
    return await ask_skin_color(update, context)

# SKIN COLOR
async def ask_skin_color(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(skin_color_options)
    await update.message.reply_text("ğŸŒ Ø±Ù†Ú¯ Ù¾ÙˆØ³Øª Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(SKIN_COLOR)
    return SKIN_COLOR

async def skin_color_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(SKIN_COLOR, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text not in skin_color_options:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=simple_with_back(skin_color_options))
        return SKIN_COLOR
    
    context.user_data["skin_color"] = text
    return await ask_eyebrow_color(update, context)

# EYEBROW
async def ask_eyebrow_color(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(eyebrow_color_options)
    await update.message.reply_text(" Ø±Ù†Ú¯ Ø§Ø¨Ø±ÙˆÛŒ Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…ØªÙ‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(EYEBROW_COLOR)
    return EYEBROW_COLOR

async def eyebrow_color_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(EYEBROW_COLOR, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text not in eyebrow_color_options:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=simple_with_back(eyebrow_color_options))
        return EYEBROW_COLOR
    
    context.user_data["eyebrow_color"] = text
    return await ask_eye_color(update, context)

# EYE COLOR
async def ask_eye_color(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(eye_color_options)
    await update.message.reply_text("ğŸ‘ Ø±Ù†Ú¯ Ú†Ø´Ù… Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(EYE_COLOR)
    return EYE_COLOR

async def eye_color_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(EYE_COLOR, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text not in eye_color_options:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=simple_with_back(eye_color_options))
        return EYE_COLOR
    
    context.user_data["eye_color"] = text
    return await ask_nose_type(update, context)

# NOSE
async def ask_nose_type(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(nose_type_options)
    await update.message.reply_text("ğŸ‘ƒ ØªÛŒÙ¾ Ø¨ÛŒÙ†ÛŒ Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(NOSE_TYPE)
    return NOSE_TYPE

async def nose_type_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(NOSE_TYPE, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text not in nose_type_options:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=simple_with_back(nose_type_options))
        return NOSE_TYPE
    
    context.user_data["nose_type"] = text
    
    if context.user_data.get("gender") == "Ø²Ù†":
        return await show_summary(update, context)
    else:
        return await ask_beard_present(update, context)

# BEARD - ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø¯Ø§Ù†
async def ask_beard_present(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(beard_presence_options)
    await update.message.reply_text("ğŸ§” Ø¢ÛŒØ§ Ø±ÛŒØ´ ÛŒØ§ Ø³Ø¨ÛŒÙ„ Ø¯Ø§Ø±ÛŒØŸ", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(BEARD_PRESENT)
    return BEARD_PRESENT

async def beard_present_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(BEARD_PRESENT, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text not in beard_presence_options:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=simple_with_back(beard_presence_options))
        return BEARD_PRESENT
    
    context.user_data["beard"] = "Ø¨Ù„Ù‡" if text == "Ø¯Ø§Ø±Ù… ğŸ§”" else "Ø®ÛŒØ±"
    
    if context.user_data["beard"] == "Ø¨Ù„Ù‡":
        return await ask_beard_color(update, context)
    return await show_summary(update, context)

# BEARD COLOR
async def ask_beard_color(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(beard_color_options)
    await update.message.reply_text("ğŸ¨ Ø±Ù†Ú¯ Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ ÙØ¹Ù„ÛŒ Ø®ÙˆØ¯Øª Ø±ÙˆØ§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(BEARD_COLOR)
    return BEARD_COLOR

async def beard_color_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(BEARD_COLOR, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text not in beard_color_options:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=simple_with_back(beard_color_options))
        return BEARD_COLOR
    
    context.user_data["beard_color"] = text
    return await ask_beard_model(update, context)

async def ask_beard_model(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = add_back_cancel([beard_model_options[0:3], beard_model_options[3:6]])
    await update.message.reply_text("ğŸ§” Ù…Ø¯Ù„ ÙØ¹Ù„ÛŒ Ø±ÛŒØ´ Ùˆ Ø³Ø¨ÛŒÙ„ Ø®ÙˆØ¯ØªÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(BEARD_MODEL)
    return BEARD_MODEL

async def beard_model_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(BEARD_MODEL, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text not in beard_model_options:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=add_back_cancel([beard_model_options[0:3], beard_model_options[3:6]]))
        return BEARD_MODEL
    
    context.user_data["beard_model"] = text
    return await ask_beard_dye(update, context)

# BEARD DYE
async def ask_beard_dye(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = simple_with_back(dye_options)
    await update.message.reply_text("ğŸ¨ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø±ÛŒØ´Øª / Ø³Ø¨ÛŒÙ„Øª Ø±Ùˆ Ø±Ù†Ú¯ Ú©Ù†ÛŒØŸ", reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(BEARD_DYE)
    return BEARD_DYE

async def beard_dye_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(BEARD_DYE, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    if text not in dye_options:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†", reply_markup=simple_with_back(dye_options))
        return BEARD_DYE
    
    context.user_data["beard_dye"] = text
    return await show_summary(update, context)

# SUMMARY & SUGGESTIONS
def build_summary_text(data: Dict[str, Any]) -> str:
    lines = ["ğŸ“‹ Ø®Ù„Ø§ØµÙ‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø«Ø¨Øª Ø´Ø¯Ù‡:\n"]
    keys = [
        ("Ø¬Ù†Ø³ÛŒØª", "gender"),
        ("Ø³Ù†", "age"),
    ]
    
    if data.get("gender") == "Ù…Ø±Ø¯":
        keys.append(("ÙˆØ¶Ø¹ÛŒØª Ù…Ùˆ", "hair_status"))
    
    # ÙÙ‚Ø· Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø±Ø§ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡
    
    keys.extend([
            ("Ø±Ù†Ú¯ Ù…Ùˆ", "hair_color"),
            ("Ø¬Ù†Ø³ Ù…Ùˆ", "hair_type"),
            ("Ù…Ø¯Ù„ Ù…Ùˆ", "hair_model"),
            ("Ø±Ù†Ú¯ Ú©Ø±Ø¯Ù† Ù…Ùˆ", "hair_dye"),
        ])
    
    keys.extend([
        ("ÙˆØ¶Ø¹ÛŒØª ØµÙˆØ±Øª", "face_condition"),
        ("ÙØ±Ù… ØµÙˆØ±Øª", "face_shape"),
        ("Ø±Ù†Ú¯ Ù¾ÙˆØ³Øª", "skin_color"),
        ("Ø±Ù†Ú¯ Ø§Ø¨Ø±Ùˆ", "eyebrow_color"),
        ("Ø±Ù†Ú¯ Ú†Ø´Ù…", "eye_color"),
        ("ØªÛŒÙ¾ Ø¨ÛŒÙ†ÛŒ", "nose_type"),
    ])
    
    if data.get("gender") == "Ù…Ø±Ø¯":
        keys.extend([
            ("Ø±ÛŒØ´/Ø³Ø¨ÛŒÙ„", "beard"),
            ("Ø±Ù†Ú¯ Ø±ÛŒØ´ / Ø³Ø¨ÛŒÙ„", "beard_color"),
            ("Ù…Ø¯Ù„ Ø±ÛŒØ´ / Ø³Ø¨ÛŒÙ„", "beard_model"),
            ("Ø±Ù†Ú¯ Ú©Ø±Ø¯Ù† Ø±ÛŒØ´", "beard_dye"),
        ])
    
    for label, key in keys:
        if key in data and data[key] is not None:
            lines.append(f"â€¢ {label}: {data[key]}")
    
    return "\n".join(lines)

async def show_summary(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = ReplyKeyboardMarkup(
        [[KeyboardButton("ØªØ£ÛŒÛŒØ¯ âœ…"), KeyboardButton("Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ âœï¸")],
         [KeyboardButton(BACK), KeyboardButton(CANCEL)]],
        resize_keyboard=True,
        one_time_keyboard=True,
    )
    text = build_summary_text(context.user_data)
    await update.message.reply_text(text, reply_markup=kb)
    
    # Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙÙ‚Ø· Ø§Ú¯Ø± Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ§Ù…Ø¯Ù‡â€ŒØ§ÛŒÙ…
    if not context.user_data.pop("is_navigating_back", False):
        context.user_data.setdefault("history", []).append(SUMMARY)
    return SUMMARY

async def summary_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if text == CANCEL:
        return await cancel(update, context)
    if text == BACK:
        return await navigate_back(SUMMARY, update, context)   # â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯
    
    if text == "ØªØ£ÛŒÛŒØ¯ âœ…":
        suggestions = generate_detailed_suggestions(context.user_data)
        reply = suggestions
        kb = ReplyKeyboardMarkup(
            [[KeyboardButton(START)]],
            resize_keyboard=True,
            one_time_keyboard=False,
        )
        await update.message.reply_text(reply, reply_markup=kb)
        context.user_data.clear()
        return ConversationHandler.END
    
    if text == "Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ âœï¸":
        context.user_data.setdefault("history", []).append(GENDER)
        return await ask_gender(update, context)
    
    await update.message.reply_text(
        "âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¯Ú©Ù…Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.",
        reply_markup=ReplyKeyboardMarkup(
            [[KeyboardButton("ØªØ£ÛŒÛŒØ¯ âœ…"), KeyboardButton("Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ âœï¸")]],
            resize_keyboard=True,
            one_time_keyboard=True,
        ),
    )
    return SUMMARY

# ---------- NEW: Intelligent Suggestion Generator ----------
def generate_detailed_suggestions(data: Dict[str, Any]) -> str:
    """ØªÙˆÙ„ÛŒØ¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§ÛŒ ØªØ®ØµØµÛŒ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ÙˆØªÙˆØ± Ù‡ÙˆØ´Ù…Ù†Ø¯"""
    gender = data.get("gender")
    
    if gender == "Ø²Ù†":
        # Ø¨Ø±Ø§ÛŒ Ø²Ù†Ø§Ù† - Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯
        return suggest_female_style(data)
    else:
        # Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø¯Ø§Ù† - Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù‚Ø¨Ù„ÛŒ
        return suggest_male_style(data)

def suggest_female_style(data: Dict[str, Any]) -> str:
    """Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§ - 3 Ù…Ø¯Ù„ + 3 Ø±Ù†Ú¯"""
    
    # Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ø² Ù…ÙˆØªÙˆØ± Ø²Ù†Ø§Ù†Ù‡
    top_models, top_colors = female_style_engine.generate_suggestions_female(data)
    
    # Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù… Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ ÙØ±Ù…Øª Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ
    result = "ğŸ¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§ÛŒ ØªØ®ØµØµÛŒ Ù…Ù† Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§:\n\n"
    
    # Ø¨Ø®Ø´ Ù…Ø¯Ù„ Ù…Ùˆ
    result += "ğŸ’‡ Ù…Ø¯Ù„ Ù…ÙˆÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:\n"
    if len(top_models) >= 1:
        result += f"Ù…Ø¯Ù„ Ø§ÙˆÙ„ (Ø§ÙˆÙ„ÙˆÛŒØª Ø§ÙˆÙ„): {top_models[0]}\n"
    if len(top_models) >= 2:
        result += f"Ù…Ø¯Ù„ Ø¯ÙˆÙ… (Ø§ÙˆÙ„ÙˆÛŒØª Ø¯ÙˆÙ…): {top_models[1]}\n"
    if len(top_models) >= 3:
        result += f"Ù…Ø¯Ù„ Ø³ÙˆÙ… (Ø§ÙˆÙ„ÙˆÛŒØª Ø³ÙˆÙ…): {top_models[2]}\n"
    
    # Ø¨Ø®Ø´ Ø±Ù†Ú¯ Ù…Ùˆ
    result += "\nğŸ¨ Ø¨Ù‡ØªØ±ÛŒÙ† Ø±Ù†Ú¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ù…Ùˆ:\n"
    if len(top_colors) >= 1:
        result += f"Ø±Ù†Ú¯ Ø§ÙˆÙ„ (Ø§ÙˆÙ„ÙˆÛŒØª Ø§ÙˆÙ„): {top_colors[0]}\n"
    if len(top_colors) >= 2:
        result += f"Ø±Ù†Ú¯ Ø¯ÙˆÙ… (Ø§ÙˆÙ„ÙˆÛŒØª Ø¯ÙˆÙ…): {top_colors[1]}\n"
    if len(top_colors) >= 3:
        result += f"Ø±Ù†Ú¯ Ø³ÙˆÙ… (Ø§ÙˆÙ„ÙˆÛŒØª Ø³ÙˆÙ…): {top_colors[2]}\n"
    
    return result

def suggest_male_style(data: Dict[str, Any]) -> str:
    """Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ Ø¢Ù‚Ø§ÛŒØ§Ù†"""
    
    # ÙˆØ¶Ø¹ÛŒØª Ù…Ùˆ
    hair_status = data.get("hair_status", "Ø¯Ø§Ø±Ø§ÛŒ Ù…Ùˆ")
    

    # ---------- ØªØºÛŒÛŒØ± 4: Ø­Ø°Ù Ø±Ù†Ú¯ ÙØ¹Ù„ÛŒ Ø§Ø² Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª ----------
    # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ù‡ØªØ±ÛŒÙ† Ø±Ù†Ú¯ Ù…Ùˆ
    hair_dye = data.get("hair_dye", "Ù†Ù‡ âŒ")
    suggested_hair_color = None
    if hair_dye == "Ø¢Ø±Ù‡ âœ…":
        # ---------- ØªØºÛŒÛŒØ± 4: Ø­Ø°Ù Ø±Ù†Ú¯ ÙØ¹Ù„ÛŒ Ø§Ø² Ù„ÛŒØ³Øª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª ----------
        current_hair_color = data.get("hair_color")
        available_colors = [color for color in AVAILABLE_DYE_COLORS if color != current_hair_color]
        
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ…Ø§Ù… Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ù‡ØªØ±ÛŒÙ†
        color_scores = []
        for color in available_colors:
            score = style_engine.calculate_color_score(color, data)
            color_scores.append((color, score))
        
        color_scores.sort(key=lambda x: x[1], reverse=True)
        suggested_hair_color = color_scores[0][0]
    
    # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ù‡ØªØ±ÛŒÙ† Ù…Ø¯Ù„ Ù…Ùˆ
    valid_models = hair_model_options.copy()
    
    # ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¬Ù†Ø³ Ù…Ùˆ
    hair_type = data.get("hair_type", "ØµØ§Ù ğŸ’‡")
    if hair_type in style_engine.hair_type_exclusions:
        valid_models = [m for m in valid_models if m not in style_engine.hair_type_exclusions[hair_type]]
    
    # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ù…Ø¯Ù„â€ŒÙ‡Ø§
    model_scores = []
    for model in valid_models:
        score = style_engine.calculate_hair_model_score(model, data)
        model_scores.append((model, score))
        model_scores.sort(key=lambda x: x[1], reverse=True)
    suggested_hair_model = model_scores[0][0]
    
    # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ù‡ØªØ±ÛŒÙ† Ù…Ø¯Ù„ Ø±ÛŒØ´
    beard_present = data.get("beard", "Ø®ÛŒØ±")
    suggested_beard_model = "ØªÙ‡â€ŒØ±ÛŒØ´"
    suggested_beard_color = "Ù…Ø´Ú©ÛŒ"
    
    # ---------- ØªØºÛŒÛŒØ± 5: Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø¯ÙˆÙ† Ø±ÛŒØ´ ----------
    if beard_present == "Ø®ÛŒØ±":
        beard_text = "\nğŸ§” Ù…Ø¯Ù„ Ø±ÛŒØ´ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ: Ø§ØµÙ„Ø§Ø­ Ú©Ø§Ù…Ù„ ØµÙˆØ±Øª"
        beard_color_text = "\nğŸ¨ Ø¨Ù‡ØªØ±ÛŒÙ† Ø±Ù†Ú¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø±ÛŒØ´: Ø·Ø¨ÛŒØ¹ÛŒ"
    else:
        beard_dye = data.get("beard_dye", "Ù†Ù‡ âŒ")
        current_beard_color = data.get("beard_color", "Ù…Ø´Ú©ÛŒ")
        current_hair_color = data.get("hair_color", "Ù…Ø´Ú©ÛŒ")
        
        # Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„ Ø±ÛŒØ´
        valid_beard_models = beard_model_options.copy()
        beard_scores = []
        for model in valid_beard_models:
            score = style_engine.calculate_beard_model_score(model, data)
            beard_scores.append((model, score))
        
        beard_scores.sort(key=lambda x: x[1], reverse=True)
        suggested_beard_model = beard_scores[0][0]
        
        # Ø§Ù†ØªØ®Ø§Ø¨ Ø±Ù†Ú¯ Ø±ÛŒØ´
        if beard_dye == "Ø¢Ø±Ù‡ âœ…":
            # ---------- ØªØºÛŒÛŒØ± 4: Ø­Ø°Ù Ø±Ù†Ú¯ ÙØ¹Ù„ÛŒ Ø±ÛŒØ´ Ø§Ø² Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª ----------
            suggested_beard_color = style_engine.get_harmonious_beard_color(
                suggested_hair_color or current_hair_color,
                data.get("skin_color", "Ú¯Ù†Ø¯Ù…ÛŒ ğŸŒ"),
                data.get("age", "30-40"),
                current_beard_color
            )

        else:
            suggested_beard_color = "Ø·Ø¨ÛŒØ¹ÛŒ"
        
        beard_text = f"\nğŸ§” Ù…Ø¯Ù„ Ø±ÛŒØ´ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ: {suggested_beard_model}"
        beard_color_text = f"\nğŸ¨ Ø¨Ù‡ØªØ±ÛŒÙ† Ø±Ù†Ú¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø±ÛŒØ´: {suggested_beard_color if beard_dye == 'Ø¢Ø±Ù‡ âœ…' else 'Ø·Ø¨ÛŒØ¹ÛŒ'}"
    
    # ØªÙˆÙ„ÛŒØ¯ Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
    if hair_status == "Ø¬Ù„Ùˆ ØªØ§ Ù¾Ø´Øª Ø³Ø± Ø¨Ø¯ÙˆÙ† Ù…Ùˆ":
        hair_text = "ğŸ’‡ Ù…Ø¯Ù„ Ù…ÙˆÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ: Ø§ØµÙ„Ø§Ø­ Ø³Ø§Ø¯Ù‡ Ø¯ÙˆØ± Ø³Ø±"
    else:
        hair_text = f"ğŸ’‡ Ù…Ø¯Ù„ Ù…ÙˆÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ: {suggested_hair_model}"
    
    color_text = f"\nğŸ¨ Ø¨Ù‡ØªØ±ÛŒÙ† Ø±Ù†Ú¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ù…Ùˆ: {suggested_hair_color if hair_dye == 'Ø¢Ø±Ù‡ âœ…' else 'Ø·Ø¨ÛŒØ¹ÛŒ'}"
    
    return f"ğŸ¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§ÛŒ ØªØ®ØµØµÛŒ Ù…Ù† Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§:\n\n{hair_text}{color_text}{beard_text}{beard_color_text}"

# ---------- DATA FOR FEMALE (Ø«Ø§Ø¨Øª) ----------
female_hair_colors_all = [
    # ØµÙØ­Ù‡ 0 - Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ùˆ ØªØ±Ù†Ø¯
    "Ù…Ø´Ú©ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ", "Ù…Ø´Ú©ÛŒ Ø¢Ø¨ÛŒ", "Ø¬ÙˆÚ¯Ù†Ø¯ÙˆÙ…ÛŒ", "Ø³ÙÛŒØ¯",
    "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø´Ú©Ù„Ø§ØªÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ù†Ø³Ú©Ø§ÙÙ‡â€ŒØ§ÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø²ØºØ§Ù„ÛŒ",
    # ØµÙØ­Ù‡ 1
    "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ù…ØªÙˆØ³Ø·", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ú©Ø§Ø±Ø§Ù…Ù„ÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø·Ù„Ø§ÛŒÛŒ",
    "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¯ÙˆØ¯ÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ Ø¹Ø³Ù„ÛŒ", "Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ ÙÙ†Ø¯Ù‚ÛŒ", "Ø¨Ù„ÙˆÙ†Ø¯ ØªÛŒØ±Ù‡",
    # ØµÙØ­Ù‡ 2
    "Ø¨Ù„ÙˆÙ†Ø¯ Ù…ØªÙˆØ³Ø·", "Ø¨Ù„ÙˆÙ†Ø¯ Ø±ÙˆØ´Ù†", "Ø¨Ù„ÙˆÙ†Ø¯ Ø·Ù„Ø§ÛŒÛŒ", "Ø¨Ù„ÙˆÙ†Ø¯ Ø®Ø§Ú©Ø³ØªØ±ÛŒ",
    "Ø¨Ù„ÙˆÙ†Ø¯ Ø¹Ø³Ù„ÛŒ", "Ø¨Ù„ÙˆÙ†Ø¯ Ù¾Ù„Ø§ØªÛŒÙ†Ù‡", "Ø¨Ù„ÙˆÙ†Ø¯ Ú©Ø±Ù‡â€ŒØ§ÛŒ (Butter Blonde)", "Ø¨Ù„ÙˆÙ†Ø¯ ØªÙˆØªâ€ŒÙØ±Ù†Ú¯ÛŒ (Strawberry Blonde)",
    # ØµÙØ­Ù‡ 3
    "Ù‚Ø±Ù…Ø² Ø·Ø¨ÛŒØ¹ÛŒ", "Ù‚Ø±Ù…Ø² ØªÛŒØ±Ù‡", "Ø´Ø±Ø§Ø¨ÛŒ", "Ø¢Ù„Ø¨Ø§Ù„ÙˆÛŒÛŒ", "Ù…Ø³ÛŒ", "Ù…Ø³ÛŒ Ø±ÙˆØ´Ù†",
    "Ù…Ø³ÛŒ Ø·Ù„Ø§ÛŒÛŒ", "Ù…Ø³ÛŒ Ù‚Ø±Ù…Ø²Ø±Ù†Ú¯ (Copper Red)",
    # ØµÙØ­Ù‡ 4
    "Ø±Ø²Ú¯Ù„Ø¯", "ØµÙˆØ±ØªÛŒ Ù¾Ø§Ø³ØªÙ„ÛŒ", "ØµÙˆØ±ØªÛŒ Ù¾Ø±Ø±Ù†Ú¯", "Ø¨Ù†ÙØ´ Ø§Ø³Ø·ÙˆØ®ÙˆØ¯ÙˆØ³ÛŒ",
    "Ø¨Ù†ÙØ´ ØªÛŒØ±Ù‡ (Violet)", "Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ", "Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù†", "Ø¢Ø¨ÛŒ ØªÛŒØ±Ù‡ (Navy Blue)",
    # ØµÙØ­Ù‡ 5
    "Ø¢Ø¨ÛŒ Ø®Ø§Ú©Ø³ØªØ±ÛŒ", "Ø³Ø¨Ø² Ø²ÛŒØªÙˆÙ†ÛŒ", "Ø³Ø¨Ø² Ø²Ù…Ø±Ø¯ÛŒ", "Ø³ÙÛŒØ¯ Ù¾Ù„Ø§ØªÛŒÙ†Ù‡", "Ø¨Ú˜ Ø±ÙˆØ´Ù†"
]

female_hair_model_popular = [
    "Ù…Ø¹Ù…ÙˆÙ„ÛŒ", "Ø¨Ø§Ø¨ Ú©Ù„Ø§Ø³ÛŒÚ© Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ø¨Ø§ Ú†ØªØ±ÛŒ", "Ù¾ÛŒÚ©Ø³ÛŒ Ø¨Ù„Ù†Ø¯ Ù†Ø§Ù…ØªÙ‚Ø§Ø±Ù† ÙØ§Ù†ØªØ²ÛŒ",
    "Ù…Ø¯Ù„ Ù‚Ø§Ø±Ú†ÛŒ Ú©ÙˆØªØ§Ù‡", "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ù…ØªÙˆØ³Ø·", "Ù…ÙˆØ¬ Ø·Ø¨ÛŒØ¹ÛŒ Ù…ØªÙˆØ³Ø·", "ØµØ§Ù Ù…ØªÙˆØ³Ø· Ú©Ù„Ø§Ø³ÛŒÚ©",
    "Ù…Ø¯Ù„ Ú©Ø±Ù‡â€ŒØ§ÛŒ Ù…ØªÙˆØ³Ø·"
]

female_hair_model_other = [
    "Ù…Ø¯Ù„ Ù…ØªÙˆØ³Ø· Ø¨Ø§ Ú†ØªØ±ÛŒ Ù¾Ø±Ø¯Ù‡â€ŒØ§ÛŒ", "Ù„Ø§ÛŒÙ‡â€ŒØ¯Ø§Ø± Ø¨Ù„Ù†Ø¯ V-Cut / Butterfly Cut", "ØµØ§Ù Ø·Ø¨ÛŒØ¹ÛŒ Ø¨Ù„Ù†Ø¯",
    "Ù…ÙˆØ¬ Ø³Ø§Ø­Ù„ÛŒ / ÙØ± Ø¨Ø§Ø²", "Ø¯Ù…â€ŒØ§Ø³Ø¨ÛŒ Ø¨Ù„Ù†Ø¯ Ø¨Ø§ Ù„Ø§ÛŒÙ‡", "ÙØ± Ø¨Ø§Ø² Ø¨Ù„Ù†Ø¯", "Ø±ÛŒØ´â€ŒØ±ÛŒØ´ Ø¨Ù„Ù†Ø¯",
    "ÛŒÙˆ Ø¨Ù„Ù†Ø¯ Ø³Ø§Ø¯Ù‡", "Ú†ØªØ±ÛŒ Ù¾Ø±Ø¯Ù‡â€ŒØ§ÛŒ Ù…ØªÙˆØ³Ø·-Ø¨Ù„Ù†Ø¯", "Ú†ØªØ±ÛŒ ØµØ§Ù Ú©Ù„Ø§Ø³ÛŒÚ© Ú©ÙˆØªØ§Ù‡",
    "Ú†ØªØ±ÛŒ ÛŒÚ©â€ŒØ·Ø±ÙÙ‡ Ø­Ø¬ÛŒÙ…", "Ø´ÛŒÙ†ÛŒÙˆÙ† Ú©Ù„Ø§Ø³ÛŒÚ© Ø¨Ø§ Ø¨Ø§ÙØª Ø¨Ø§Ø²", "Ø´ÛŒÙ†ÛŒÙˆÙ† ÙØ±Ø§Ù†Ø³ÙˆÛŒ Ú¯ÙˆØ¬Ù‡â€ŒØ§ÛŒ",
    "Ø´ÛŒÙ†ÛŒÙˆÙ† Ù¾Ø§ÛŒÛŒÙ† Ú¯Ø±Ø¯Ù† Ø³Ø§Ø¯Ù‡", "Ø´ÛŒÙ†ÛŒÙˆÙ† Ù†ÛŒÙ…Ù‡ Ø¨Ø§Ø²", "Ø´ÛŒÙ†ÛŒÙˆÙ† Ø­Ø¬ÛŒÙ… Ù…Ø¯Ø±Ù†",
    "Ø¨Ø§ÙØª ÙØ±Ø§Ù†Ø³ÙˆÛŒ Ú©Ù„Ø§Ø³ÛŒÚ©", "Ø¨Ø§ÙØª Ù‡Ù„Ù†Ø¯ÛŒ / ØªØ§Ø¬ÛŒ", "Ø¨Ø§ÙØª Ù…Ø§Ù‡ÛŒ",
    "Ø¨Ø§ÙØª ØªØ±Ú©ÛŒØ¨ÛŒ Ø¨Ø§ Ø´ÛŒÙ†ÛŒÙˆÙ†", "ÙˆÙÙ„Ùâ€ŒÚ©Ø§Øª", "Ù‡Ø§Ù„ÛŒÙˆÙˆØ¯ÛŒ Ù…ÙˆØ¬â€ŒØ¯Ø§Ø±",
    "Ú©Ø±Ù‡â€ŒØ§ÛŒ ÙØ§Ù†ØªØ²ÛŒ", "Ø¨Ù„Ø§Ù†Øª Ø¨Ù„Ù†Ø¯", "ÙˆÛŒÙˆ ÛŒØ®ÛŒ / Ù…ÙˆØ¬ ÙØ§Ù†ØªØ²ÛŒ"
]

female_hair_model_options = female_hair_model_popular + female_hair_model_other

# ---------- Error handler ----------
async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.error(f"Error occurred: {context.error}", exc_info=context.error)
    if update and update.effective_message:
        await update.effective_message.reply_text(
            "âŒ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯! Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯."
        )

# build conversation handler
def build_conv_handler():
    return ConversationHandler(
        entry_points=[CommandHandler("start", start), MessageHandler(filters.Text(START), start_command)],
        states={
            GENDER: [MessageHandler(filters.TEXT & ~filters.COMMAND, gender_handler)],
            AGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, age_handler)],
            HAIR_STATUS: [MessageHandler(filters.TEXT & ~filters.COMMAND, hair_status_handler)],
            HAIR_COLOR: [MessageHandler(filters.TEXT & ~filters.COMMAND, hair_color_handler)],
            HAIR_TYPE: [MessageHandler(filters.TEXT & ~filters.COMMAND, hair_type_handler)],
            HAIR_MODEL: [MessageHandler(filters.TEXT & ~filters.COMMAND, hair_model_handler)],
            HAIR_MODEL_FEMALE: [MessageHandler(filters.TEXT & ~filters.COMMAND, hair_model_female_handler)],
            HAIR_DYE: [MessageHandler(filters.TEXT & ~filters.COMMAND, hair_dye_handler)],
            FACE_CONDITION: [MessageHandler(filters.TEXT & ~filters.COMMAND, face_condition_handler)],
            FACE_SHAPE: [MessageHandler(filters.TEXT & ~filters.COMMAND, face_shape_handler)],
            SKIN_COLOR: [MessageHandler(filters.TEXT & ~filters.COMMAND, skin_color_handler)],
            EYEBROW_COLOR: [MessageHandler(filters.TEXT & ~filters.COMMAND, eyebrow_color_handler)],
            EYE_COLOR: [MessageHandler(filters.TEXT & ~filters.COMMAND, eye_color_handler)],
            NOSE_TYPE: [MessageHandler(filters.TEXT & ~filters.COMMAND, nose_type_handler)],
            BEARD_PRESENT: [MessageHandler(filters.TEXT & ~filters.COMMAND, beard_present_handler)],
            BEARD_COLOR: [MessageHandler(filters.TEXT & ~filters.COMMAND, beard_color_handler)],
            BEARD_MODEL: [MessageHandler(filters.TEXT & ~filters.COMMAND, beard_model_handler)],
            BEARD_DYE: [MessageHandler(filters.TEXT & ~filters.COMMAND, beard_dye_handler)],
            SUMMARY: [MessageHandler(filters.TEXT & ~filters.COMMAND, summary_handler)],
        },
        fallbacks=[
            CommandHandler("cancel", cancel),
            MessageHandler(filters.TEXT & ~filters.COMMAND, unknown_handler)
        ],
        allow_reentry=True,
    )

# Setup bot commands menu
async def post_init(application: Application) -> None:
    await application.bot.set_my_commands([
        BotCommand("start", "Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø±Ø¨Ø§Øª")
    ])

if __name__ == "__main__":
    if not BOT_TOKEN:
        
        logger.error("âŒ ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ø¯Ø± Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ BOT_TOKEN ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡.")
    else:
        app = ApplicationBuilder().token(BOT_TOKEN).post_init(post_init).build()

        # Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§
        conv = build_conv_handler()
        app.add_handler(conv)
        app.add_handler(MessageHandler(filters.Text(START), start_command))
        app.add_handler(CommandHandler("help", lambda update, context: update.message.reply_text(
            "ğŸ¤– Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø±Ø¨Ø§Øª StyleBot:\n"
            "â€¢ Ø§Ø² /start ÛŒØ§ Ø¯Ú©Ù…Ù‡ 'Ø´Ø±ÙˆØ¹' Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†\n"
            "â€¢ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¯Ø± Ù‡Ø± Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ùˆ Ø§Ù†ØµØ±Ø§Ù Ú©Ù†ØªØ±Ù„ Ú©Ù†ÛŒ\n"
            "â€¢ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒ ØªÙˆ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒØ´Ù†"
        )))
        app.add_error_handler(error_handler)

        # Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Webhook
        PORT = int(os.environ.get("PORT", "8443"))
        WEBHOOK_PATH = f"webhook/{BOT_TOKEN}"
        WEBHOOK_URL = f"https://atmrstylehelperbot.onrender.com/{WEBHOOK_PATH}"

        print("âœ… Bot is running")
        app.run_webhook(
            listen="0.0.0.0",
            port=PORT,
            url_path=WEBHOOK_PATH,
            webhook_url=WEBHOOK_URL
        )
